<!DOCTYPE html>
<html lang="de">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Einstellungen - fourteenkilobytes</title>
  <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
  <link rel="stylesheet" href="style.css">
</head>

<body>
  <!-- Use semantic header element for better document structure -->
  <header class="header">
    <div class="header-top">
      <!-- Logo with improved accessibility -->
      <div class="logo-container">
        <a href="index.html" class="logo" aria-label="14KB Dashboard">
          <!-- SVG uses currentColor to inherit accent from CSS -->
          <svg version="1.0" xmlns="http://www.w3.org/2000/svg" width="32" height="32"
            viewBox="0 0 191.000000 191.000000" preserveAspectRatio="xMidYMid meet" aria-hidden="true">
            <g transform="translate(0.000000,191.000000) scale(0.100000,-0.100000)" fill="currentColor" stroke="none">
              <path d="M406 1889 c-175 -35 -325 -178 -371 -356 -21 -81 -22 -1071 -1 -1149
47 -176 194 -315 374 -353 61 -13 1058 -16 1066 -3 2 4 -22 29 -55 55 -67 54
-152 157 -220 265 -24 39 -46 71 -49 72 -3 0 -18 -21 -34 -46 -41 -65 -64 -78
-116 -64 -63 17 -74 3 -65 -82 5 -57 4 -69 -10 -74 -24 -10 -45 15 -45 54 0
34 -1 34 -19 18 -10 -9 -21 -31 -25 -47 -5 -26 -10 -30 -33 -27 -23 2 -29 8
-31 35 -3 27 1 35 22 44 26 12 40 35 30 50 -9 16 -22 10 -58 -27 -40 -41 -72
-40 -82 2 -8 31 5 46 54 59 49 14 52 37 7 54 -19 7 -40 9 -45 6 -29 -18 -54
47 -28 73 17 17 35 15 66 -8 15 -12 41 -22 57 -23 28 -2 30 0 27 28 -8 85 -7
89 12 93 24 5 46 -23 46 -58 0 -37 29 -60 75 -60 51 0 69 18 101 106 l27 74
-19 42 c-26 59 -98 111 -196 143 -68 23 -91 36 -129 75 -58 59 -82 121 -109
278 -33 194 -24 242 44 242 36 0 242 -68 310 -102 87 -43 125 -102 140 -218 9
-60 39 -108 79 -125 20 -8 76 -15 138 -16 57 -1 142 -8 188 -15 46 -8 87 -12
90 -9 9 10 1 84 -14 119 -8 20 -25 41 -37 47 -20 11 -25 8 -55 -27 -27 -33
-35 -37 -50 -28 -10 6 -19 22 -21 36 -2 20 5 30 33 47 45 26 37 45 -16 38 -44
-6 -75 18 -65 51 9 29 30 33 70 17 57 -24 63 -18 22 24 -40 41 -44 66 -13 85
24 15 49 -2 59 -41 4 -17 15 -36 23 -43 21 -18 31 12 17 56 -8 27 -7 37 5 49
36 37 68 5 59 -58 -5 -32 -3 -47 8 -56 11 -9 18 -6 35 16 40 54 41 54 62 42
28 -15 22 -60 -11 -76 -57 -28 -65 -87 -25 -201 28 -82 31 -131 10 -171 -16
-31 -33 -41 -71 -41 -14 0 -34 -5 -45 -11 -26 -13 -15 -27 61 -79 30 -21 91
-70 135 -109 44 -39 85 -71 92 -71 20 0 18 909 -2 1003 -15 73 -58 162 -106
221 -40 48 -135 112 -207 139 -55 21 -71 22 -587 23 -305 1 -551 -2 -579 -7z" />
            </g>
          </svg>
          <!-- Stacked wordmark for compact branding -->
          <span class="logo-text" aria-hidden="true">14<br>KB</span>
        </a>
      </div>
      <!-- Semantic nav with improved structure -->
      <nav class="header-nav" aria-label="Main navigation">
        <a href="index.html" class="nav-icon">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
            aria-hidden="true">
            <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" />
            <polyline points="9 22 9 12 15 12 15 22" />
          </svg>
          Übersicht
        </a>
        <a href="editor.html" class="nav-icon">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
            aria-hidden="true">
            <line x1="12" y1="5" x2="12" y2="19" />
            <line x1="5" y1="12" x2="19" y2="12" />
          </svg>
          Neu
        </a>
        <a href="settings.html" class="nav-icon active" aria-current="page">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
            aria-hidden="true">
            <circle cx="12" cy="12" r="3" />
            <path
              d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z" />
          </svg>
          Einstellungen
        </a>
        <a href="/" target="_blank" rel="noopener" class="nav-icon external-link">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
            aria-hidden="true">
            <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6" />
            <polyline points="15 3 21 3 21 9" />
            <line x1="10" y1="14" x2="21" y2="3" />
          </svg>
          Blog
        </a>
        <!-- Visual separator before logout -->
        <span class="nav-separator" aria-hidden="true"></span>
        <a href="#" id="logout-btn" class="nav-icon logout-icon">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
            aria-hidden="true">
            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" />
            <polyline points="16 17 21 12 16 7" />
            <line x1="21" y1="12" x2="9" y2="12" />
          </svg>
          Logout
        </a>
      </nav>
    </div>
    <h1 class="page-title">Einstellungen</h1>
  </header>

  <!-- Settings Card -->
  <div class="editor-card">
    <div class="card-header">
      <div class="settings-tabs">
        <button type="button" class="tab-btn active" data-tab="general">Allgemein</button>
        <button type="button" class="tab-btn" data-tab="header">Header</button>
        <button type="button" class="tab-btn" data-tab="footer">Footer</button>
        <button type="button" class="tab-btn" data-tab="css">CSS</button>
      </div>
      <div class="settings-actions">
        <button id="discard-btn" class="btn btn-secondary hidden">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="3 6 5 6 21 6"></polyline>
            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
            <line x1="10" y1="11" x2="10" y2="17"></line>
            <line x1="14" y1="11" x2="14" y2="17"></line>
          </svg>
          Verwerfen
        </button>
        <button id="save-btn" class="btn btn-primary" disabled>
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
            <polyline points="17 21 17 13 7 13 7 21"></polyline>
            <polyline points="7 3 7 8 15 8"></polyline>
          </svg>
          Speichern
        </button>
      </div>
    </div>
    <div class="card-body">
      <!-- General Tab -->
      <div id="tab-general" class="tab-content active">
        <div class="form-group">
          <h3 class="override-section-title">Startseite</h3>
          <p class="text-small text-muted mb-1">Wähle eine Seite, die als Startseite (/) angezeigt werden soll</p>
          <div style="display: flex; gap: 0.5rem; align-items: center;">
            <select id="homepage-select" class="homepage-select" style="flex: 1;">
              <option value="">Standard (automatische Postliste)</option>
            </select>
            <button type="button" id="regenerate-homepage-btn" class="btn btn-secondary" style="display: none;">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="23 4 23 10 17 10"></polyline>
                <polyline points="1 20 1 14 7 14"></polyline>
                <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
              </svg>
              Aktualisieren
            </button>
          </div>
        </div>

        <div class="form-group" style="margin-top: 1.5rem;">
          <h3 class="override-section-title">Favicon</h3>
          <p class="text-small text-muted mb-1">Kleines Icon das im Browser-Tab angezeigt wird (max. 4KB, wird als Base64 eingebettet)</p>
          <div class="favicon-editor">
            <div class="favicon-preview-container">
              <div id="favicon-preview" class="favicon-preview">
                <span class="favicon-placeholder">Kein Favicon</span>
              </div>
            </div>
            <div class="favicon-actions">
              <label class="btn btn-secondary">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                  <polyline points="17 8 12 3 7 8"></polyline>
                  <line x1="12" y1="3" x2="12" y2="15"></line>
                </svg>
                Hochladen
                <input type="file" id="favicon-input" accept="image/png,image/x-icon,image/svg+xml,image/gif" hidden>
              </label>
              <button type="button" id="favicon-remove" class="btn btn-danger hidden">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="3 6 5 6 21 6"></polyline>
                  <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                </svg>
                Entfernen
              </button>
            </div>
            <input type="hidden" id="favicon-data">
          </div>
        </div>
      </div>

      <!-- Header Tab -->
      <div id="tab-header" class="tab-content hidden">
        <!-- Navigation Section -->
        <div class="override-section override-section-first">
          <h3 class="override-section-title">Navigation</h3>
          <div class="override-section-header">
            <label class="override-toggle">
              <input type="checkbox" id="header-enabled">
              <span>Navigation aktivieren</span>
            </label>
          </div>
          <div id="header-editor" class="override-editor hidden">
            <p class="text-small text-muted mb-1">Navigation-Links (erscheinen in jeder Seite)</p>
            <div class="nav-editor-row">
              <div id="header-links" class="nav-links"></div>
              <button type="button" id="add-header-link" class="btn btn-secondary">+ Link</button>
            </div>
          </div>
        </div>

        <!-- Meta Section -->
        <div class="override-section">
          <h3 class="override-section-title">Meta</h3>
          <div class="override-section-header">
            <label class="override-toggle">
              <input type="checkbox" id="meta-enabled">
              <span>Meta aktivieren</span>
            </label>
          </div>
          <div id="meta-editor" class="override-editor hidden">
            <p class="text-small text-muted mb-1">Globale SEO-Tags die im &lt;head&gt; jeder Seite eingebettet werden
              (können pro Seite überschrieben werden)</p>
            <div class="meta-row">
              <div class="form-group">
                <label for="meta-description">Beschreibung</label>
                <input type="text" id="meta-description" maxlength="160"
                  placeholder="Eine kurze Beschreibung deines Blogs...">
              </div>
              <div class="form-group">
                <label for="meta-author">Autor</label>
                <input type="text" id="meta-author" maxlength="100" placeholder="Max Mustermann">
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Footer Tab -->
      <div id="tab-footer" class="tab-content hidden">
        <div class="override-section override-section-first">
          <h3 class="override-section-title">Footer</h3>
          <div class="override-section-header">
            <label class="override-toggle">
              <input type="checkbox" id="footer-enabled">
              <span>Footer aktivieren</span>
            </label>
          </div>
          <div id="footer-editor" class="override-editor hidden">
            <p class="text-small text-muted mb-1">Footer-Text (HTML erlaubt, <code>{{bytes}}</code> für Byte-Anzeige)
            </p>
            <div class="footer-editor-row">
              <input type="text" id="footer-content" placeholder="© 2026 | {{bytes}}/14336 bytes">
              <button type="button" id="insert-bytes-btn" class="btn btn-secondary">{{bytes}}</button>
            </div>
          </div>
        </div>
      </div>

      <!-- CSS Tab -->
      <div id="tab-css" class="tab-content hidden">
        <div class="override-section override-section-first">
          <h3 class="override-section-title">CSS Vorlagen</h3>
          <div class="override-section-header">
            <label class="override-toggle">
              <input type="checkbox" id="css-enabled">
              <span>Globales CSS verwenden</span>
            </label>
          </div>
          <div id="css-editor" class="hidden">
            <div class="css-select-box">
              <p class="text-small text-muted mb-1">Wähle eine Vorlage oder verwende eigenes CSS</p>
              <select id="css-mode" class="css-template-select">
                <option value="default">Standard</option>
                <option value="light">Light</option>
                <option value="dark">Dark</option>
                <option value="custom">Eigenes CSS</option>
              </select>
            </div>

            <!-- Preview for presets -->
            <div id="css-preset-preview" class="css-preview">
              <p class="text-small text-muted mb-1">
                Vorschau für <span id="css-preview-filename">fourteenkilobytes-default.css</span> <span class="text-muted">(Nur lesen)</span>
              </p>
              <pre id="css-preview-content" class="css-preview-code"></pre>
            </div>

            <!-- Custom CSS editor -->
            <div id="css-custom-editor" class="hidden">
              <p class="text-small text-muted mb-1">Eigene CSS-Regeln (werden in jede Seite eingebettet)</p>
              <textarea id="global-css" rows="12" placeholder="body {
  font-family: Georgia, serif;
  max-width: 600px;
  margin: 0 auto;
}"></textarea>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Overhead Card -->
  <div class="editor-card">
    <div class="card-header">
      <h2 class="card-title">Overhead</h2>
    </div>
    <div class="card-body card-body-with-rail">
      <div class="card-content">
        <div class="breakdown-table">
          <div class="breakdown-row">
            <span>Base</span>
            <span id="overhead-breakdown-base">0 B</span>
          </div>
          <div class="breakdown-row">
            <span>Favicon</span>
            <span id="overhead-breakdown-favicon">0 B</span>
          </div>
          <div class="breakdown-row">
            <span>Meta</span>
            <span id="overhead-breakdown-meta">0 B</span>
          </div>
          <div class="breakdown-row">
            <span>Navigation</span>
            <span id="overhead-breakdown-nav">0 B</span>
          </div>
          <div class="breakdown-row">
            <span>Footer</span>
            <span id="overhead-breakdown-footer">0 B</span>
          </div>
          <div class="breakdown-row">
            <span>CSS</span>
            <span id="overhead-breakdown-css">0 B</span>
          </div>
          <div class="breakdown-row breakdown-row-total">
            <span>Total</span>
            <span id="overhead-breakdown-total">0 B / 14.336 B</span>
          </div>
        </div>
      </div>
      <div class="card-rail build-rail" style="justify-content: center;">
        <div class="build-progress">
          <div class="pie-chart" id="overhead-pie-chart">
            <span class="pie-percent" id="overhead-percent">0%</span>
          </div>
          <div class="pie-legend">
            <div class="pie-legend-item">
              <span class="pie-dot pie-dot-overhead"></span>
              <span id="overhead-bytes">0 B</span>
            </div>
            <div class="pie-legend-item">
              <span class="pie-dot pie-dot-free"></span>
              <span>Verfügbar</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Link Edit Popup -->
  <div id="link-popup" class="nav-link-popup hidden">
    <div class="popup-content">
      <div class="form-group">
        <label>Text</label>
        <input type="text" id="link-text" placeholder="Home">
      </div>
      <div class="form-group">
        <label>Ziel</label>
        <input type="text" id="link-href" placeholder="/">
      </div>
      <div class="popup-actions">
        <button type="button" id="link-save" class="btn btn-primary">OK</button>
        <button type="button" id="link-delete" class="btn btn-danger btn-small hidden">Löschen</button>
        <button type="button" id="link-cancel" class="btn btn-secondary">Abbrechen</button>
      </div>
    </div>
  </div>

  <!-- Modal System -->
  <div id="modal-backdrop" class="modal-backdrop hidden"></div>
  <div id="modal" class="modal hidden">
    <div class="modal-content">
      <p id="modal-message"></p>
      <div id="modal-actions" class="popup-actions"></div>
    </div>
  </div>


  <script type="module" src="app.js"></script>
  <script type="module">
    (async function () {
      // Check if setup is complete
      const status = await App.getSetupStatus();
      if (!status.setupComplete) {
        window.location.href = '/admin/setup';
        return;
      }

      // Check auth
      const config = await App.getConfig();
      if (config.authEnabled && !(await App.isLoggedIn())) {
        window.location.href = 'index.html';
        return;
      }

      // Logout handler
      document.getElementById('logout-btn').addEventListener('click', async (e) => {
        e.preventDefault();
        await App.logout();
        window.location.href = '/admin/login.html';
      });

      // Elements
      const homepageSelect = document.getElementById('homepage-select');
      const regenerateHomepageBtn = document.getElementById('regenerate-homepage-btn');
      const headerEnabled = document.getElementById('header-enabled');
      const headerEditor = document.getElementById('header-editor');
      const headerLinks = document.getElementById('header-links');
      const addHeaderLinkBtn = document.getElementById('add-header-link');
      const footerEnabled = document.getElementById('footer-enabled');
      const footerEditor = document.getElementById('footer-editor');
      const footerContent = document.getElementById('footer-content');
      const cssEnabled = document.getElementById('css-enabled');
      const cssEditor = document.getElementById('css-editor');
      const cssMode = document.getElementById('css-mode');
      const cssPresetPreview = document.getElementById('css-preset-preview');
      const cssPreviewContent = document.getElementById('css-preview-content');
      const cssPreviewFilename = document.getElementById('css-preview-filename');
      const cssCustomEditor = document.getElementById('css-custom-editor');
      const globalCss = document.getElementById('global-css');
      const metaEnabled = document.getElementById('meta-enabled');
      const metaEditor = document.getElementById('meta-editor');
      const metaDescription = document.getElementById('meta-description');
      const metaAuthor = document.getElementById('meta-author');
      const linkPopup = document.getElementById('link-popup');
      const linkText = document.getElementById('link-text');
      const linkHref = document.getElementById('link-href');
      const linkSave = document.getElementById('link-save');
      const linkDelete = document.getElementById('link-delete');
      const linkCancel = document.getElementById('link-cancel');
      const faviconInput = document.getElementById('favicon-input');
      const faviconPreview = document.getElementById('favicon-preview');
      const faviconRemove = document.getElementById('favicon-remove');
      const faviconData = document.getElementById('favicon-data');
      const saveBtn = document.getElementById('save-btn');
      const discardBtn = document.getElementById('discard-btn');
      const overheadBytesEl = document.getElementById('overhead-bytes');
      const overheadPieChart = document.getElementById('overhead-pie-chart');
      const overheadPercent = document.getElementById('overhead-percent');

      // Tab elements
      const tabBtns = document.querySelectorAll('.tab-btn');
      const tabContents = document.querySelectorAll('.tab-content');

      // State
      let editingLink = null;
      let hasUnsavedChanges = false;
      let initialSettings = null;

      // Update save button appearance based on changes
      function updateSaveButton() {
        if (hasUnsavedChanges) {
          saveBtn.disabled = false;
          discardBtn.classList.remove('hidden');
        } else {
          saveBtn.disabled = true;
          discardBtn.classList.add('hidden');
        }
      }

      // Mark as changed
      function markAsChanged() {
        hasUnsavedChanges = true;
        updateSaveButton();
      }

      // ============ HOMEPAGE ============

      function updateRegenerateButton() {
        const selectedSlug = homepageSelect.value;
        if (selectedSlug) {
          regenerateHomepageBtn.style.display = 'block';
        } else {
          regenerateHomepageBtn.style.display = 'none';
        }
      }

      homepageSelect.addEventListener('change', () => {
        updateRegenerateButton();
        markAsChanged();
      });

      regenerateHomepageBtn.addEventListener('click', async () => {
        const slug = homepageSelect.value;
        if (!slug) return;

        const confirmed = await Modal.confirm(`Startseite "${slug}" mit aktuellen Posts neu generieren?`);
        if (!confirmed) return;

        regenerateHomepageBtn.disabled = true;
        regenerateHomepageBtn.textContent = '⏳ Generiere...';
        try {
          await App.republishPost(slug);
          Toast.success('Startseite erfolgreich aktualisiert!');
          regenerateHomepageBtn.textContent = '✓ Aktualisiert';
          setTimeout(() => {
            regenerateHomepageBtn.textContent = 'Aktualisieren';
            regenerateHomepageBtn.disabled = false;
          }, 2000);
        } catch (err) {
          Toast.error(`Fehler: ${err.message}`);
          regenerateHomepageBtn.textContent = 'Aktualisieren';
          regenerateHomepageBtn.disabled = false;
        }
      });

      // ============ TABS ============

      tabBtns.forEach(btn => {
        btn.addEventListener('click', () => {
          const tab = btn.dataset.tab;
          tabBtns.forEach(b => b.classList.toggle('active', b === btn));
          tabContents.forEach(c => c.classList.toggle('active', c.id === `tab-${tab}`));
          tabContents.forEach(c => c.classList.toggle('hidden', c.id !== `tab-${tab}`));
        });
      });

      // ============ HEADER EDITOR ============

      headerEnabled.addEventListener('change', () => {
        headerEditor.classList.toggle('hidden', !headerEnabled.checked);
        markAsChanged();
        updateOverhead();
      });

      function createLinkChip(text, href) {
        const chip = document.createElement('span');
        chip.className = 'nav-chip';
        chip.dataset.href = href;
        chip.textContent = text;
        chip.addEventListener('click', () => editLink(chip));
        return chip;
      }

      function editLink(chip) {
        editingLink = chip;
        linkText.value = chip.textContent;
        linkHref.value = chip.dataset.href;
        linkDelete.classList.remove('hidden');
        linkPopup.classList.remove('hidden');
        linkText.focus();
      }

      addHeaderLinkBtn.addEventListener('click', () => {
        editingLink = null;
        linkText.value = '';
        linkHref.value = '';
        linkDelete.classList.add('hidden');
        linkPopup.classList.remove('hidden');
        linkText.focus();
      });

      linkSave.addEventListener('click', () => {
        const text = linkText.value.trim();
        const href = linkHref.value.trim();
        if (!text || !href) return;

        if (editingLink) {
          editingLink.textContent = text;
          editingLink.dataset.href = href;
        } else {
          headerLinks.appendChild(createLinkChip(text, href));
        }
        linkPopup.classList.add('hidden');
        editingLink = null;
        markAsChanged();
        updateOverhead();
      });

      linkDelete.addEventListener('click', () => {
        if (editingLink) {
          editingLink.remove();
        }
        linkPopup.classList.add('hidden');
        editingLink = null;
        markAsChanged();
        updateOverhead();
      });

      linkCancel.addEventListener('click', () => {
        linkPopup.classList.add('hidden');
        editingLink = null;
      });

      // ============ FOOTER EDITOR ============

      footerEnabled.addEventListener('change', () => {
        footerEditor.classList.toggle('hidden', !footerEnabled.checked);
        markAsChanged();
        updateOverhead();
      });

      footerContent.addEventListener('input', debounce(() => {
        updateOverhead();
        markAsChanged();
      }, 300));

      document.getElementById('insert-bytes-btn').addEventListener('click', () => {
        const input = footerContent;
        const start = input.selectionStart;
        const end = input.selectionEnd;
        const text = '{{bytes}}';
        input.value = input.value.substring(0, start) + text + input.value.substring(end);
        input.selectionStart = input.selectionEnd = start + text.length;
        input.focus();
        updateOverhead();
      });

      // ============ FAVICON EDITOR ============

      const MAX_FAVICON_SIZE = 4096; // 4KB max

      faviconInput.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        if (file.size > MAX_FAVICON_SIZE) {
          Toast.error(`Favicon zu groß (${formatBytes(file.size)}). Maximum: ${formatBytes(MAX_FAVICON_SIZE)}`);
          faviconInput.value = '';
          return;
        }

        try {
          const base64 = await fileToBase64(file);
          setFaviconPreview(base64);
          faviconData.value = base64;
          markAsChanged();
          updateOverhead();
        } catch (err) {
          Toast.error('Fehler beim Lesen der Datei');
        }
        faviconInput.value = '';
      });

      faviconRemove.addEventListener('click', () => {
        clearFaviconPreview();
        faviconData.value = '';
        markAsChanged();
        updateOverhead();
      });

      function fileToBase64(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result);
          reader.onerror = reject;
          reader.readAsDataURL(file);
        });
      }

      function setFaviconPreview(dataUrl) {
        faviconPreview.innerHTML = `<img src="${dataUrl}" alt="Favicon">`;
        faviconRemove.classList.remove('hidden');
      }

      function clearFaviconPreview() {
        faviconPreview.innerHTML = '<span class="favicon-placeholder">Kein Favicon</span>';
        faviconRemove.classList.add('hidden');
      }

      // ============ CSS EDITOR ============

      cssEnabled.addEventListener('change', () => {
        cssEditor.classList.toggle('hidden', !cssEnabled.checked);
        markAsChanged();
        updateOverhead();
      });

      async function updateCssModeUI() {
        const mode = cssMode.value;
        const isCustom = mode === 'custom';

        cssPresetPreview.classList.toggle('hidden', isCustom);
        cssCustomEditor.classList.toggle('hidden', !isCustom);

        // Update filename in preview title
        if (!isCustom) {
          cssPreviewFilename.textContent = `fourteenkilobytes-${mode}.css`;
          // Show preset CSS in preview
          const presets = await App.loadCssPresets();
          cssPreviewContent.textContent = presets[mode] || '';
        }
        updateOverhead();
      }

      cssMode.addEventListener('change', () => {
        updateCssModeUI();
        markAsChanged();
      });
      globalCss.addEventListener('input', debounce(() => {
        updateOverhead();
        markAsChanged();
      }, 300));

      // ============ META EDITOR ============

      metaEnabled.addEventListener('change', () => {
        metaEditor.classList.toggle('hidden', !metaEnabled.checked);
        markAsChanged();
        updateOverhead();
      });

      metaDescription.addEventListener('input', debounce(() => {
        updateOverhead();
        markAsChanged();
      }, 300));
      metaAuthor.addEventListener('input', debounce(() => {
        updateOverhead();
        markAsChanged();
      }, 300));

      // ============ BUILD SETTINGS ============

      function getHeaderLinks() {
        const chips = headerLinks.querySelectorAll('.nav-chip');
        return Array.from(chips).map(chip => ({
          text: chip.textContent,
          href: chip.dataset.href
        }));
      }

      function buildSettings() {
        return {
          version: 1,
          homepageSlug: homepageSelect.value || null,
          favicon: faviconData.value || null,
          cssEnabled: cssEnabled.checked,
          cssMode: cssMode.value,
          globalCss: globalCss.value.trim(),
          header: {
            enabled: headerEnabled.checked,
            links: getHeaderLinks(),
          },
          footer: {
            enabled: footerEnabled.checked,
            content: footerContent.value.trim(),
          },
          meta: {
            enabled: metaEnabled.checked,
            description: metaDescription.value.trim() || undefined,
            author: metaAuthor.value.trim() || undefined,
          },
        };
      }

      // ============ OVERHEAD CALCULATION ============

      function formatBytes(bytes) {
        if (bytes === 0) return '0 B';
        if (bytes < 1000) return bytes + ' B';
        return (bytes / 1024).toFixed(1) + ' KB';
      }

      async function updateOverhead() {
        try {
          const settings = buildSettings();
          const res = await App.previewOverhead(settings);
          console.log('Overhead preview result:', res);
          const bytes = res.overheadBytes;
          const breakdown = res.breakdown || {};
          const limit = 14336;
          const percent = Math.min((bytes / limit) * 100, 100);
          const overheadDeg = (percent / 100) * 360;

          // Update breakdown table
          const breakdownBaseEl = document.getElementById('overhead-breakdown-base');
          const breakdownFaviconEl = document.getElementById('overhead-breakdown-favicon');
          const breakdownMetaEl = document.getElementById('overhead-breakdown-meta');
          const breakdownNavEl = document.getElementById('overhead-breakdown-nav');
          const breakdownFooterEl = document.getElementById('overhead-breakdown-footer');
          const breakdownCssEl = document.getElementById('overhead-breakdown-css');
          const breakdownTotalEl = document.getElementById('overhead-breakdown-total');

          if (breakdownBaseEl) breakdownBaseEl.textContent = formatBytes(breakdown.base || 0);
          if (breakdownFaviconEl) breakdownFaviconEl.textContent = formatBytes(breakdown.favicon || 0);
          if (breakdownMetaEl) breakdownMetaEl.textContent = formatBytes(breakdown.meta || 0);
          if (breakdownNavEl) breakdownNavEl.textContent = formatBytes(breakdown.navigation || 0);
          if (breakdownFooterEl) breakdownFooterEl.textContent = formatBytes(breakdown.footer || 0);
          if (breakdownCssEl) breakdownCssEl.textContent = formatBytes(breakdown.css || 0);
          if (breakdownTotalEl) breakdownTotalEl.textContent = `${formatBytes(bytes)} / 14.336 B`;

          overheadBytesEl.textContent = formatBytes(bytes);
          overheadPercent.textContent = `${Math.round(percent)}%`;

          // Determine color based on usage
          let overheadColor = 'var(--gray-400)';
          if (percent >= 75) {
            overheadColor = '#dc2626';
          } else if (percent >= 50) {
            overheadColor = '#f59e0b';
          }

          overheadPieChart.style.background = `conic-gradient(
            ${overheadColor} 0deg ${overheadDeg}deg,
            var(--gray-200) ${overheadDeg}deg 360deg
          )`;
        } catch (e) {
          console.error('Overhead calculation failed:', e);
        }
      }

      // ============ LOAD SETTINGS ============

      async function loadSettings() {
        try {
          const settings = await App.getSettings();
          const allPosts = await App.getPosts();

          console.log('Posts Data:', allPosts);

          // Homepage
          homepageSelect.innerHTML = '<option value="">— Standard (automatische Postliste) —</option>';
          const pages = allPosts.filter(p => p.pageType === 'page' && p.status === 'published');
          console.log('Filtered pages:', pages);

          for (const page of pages) {
            const option = document.createElement('option');
            option.value = page.slug;
            option.textContent = page.title;
            homepageSelect.appendChild(option);
          }
          homepageSelect.value = settings.homepageSlug || '';

          // Update regenerate button visibility
          updateRegenerateButton();

          // Header
          headerEnabled.checked = settings.header.enabled;
          headerEditor.classList.toggle('hidden', !settings.header.enabled);
          headerLinks.innerHTML = '';
          for (const link of settings.header.links) {
            headerLinks.appendChild(createLinkChip(link.text, link.href));
          }

          // Footer
          footerEnabled.checked = settings.footer.enabled;
          footerEditor.classList.toggle('hidden', !settings.footer.enabled);
          footerContent.value = settings.footer.content;

          // CSS (default: enabled)
          cssEnabled.checked = settings.cssEnabled !== false;
          cssEditor.classList.toggle('hidden', !cssEnabled.checked);
          cssMode.value = settings.cssMode || 'default';
          globalCss.value = settings.globalCss || '';
          updateCssModeUI();

          // Meta (default: enabled)
          metaEnabled.checked = settings.meta?.enabled !== false;
          metaEditor.classList.toggle('hidden', !metaEnabled.checked);
          metaDescription.value = settings.meta?.description || '';
          metaAuthor.value = settings.meta?.author || '';

          // Favicon
          if (settings.favicon) {
            setFaviconPreview(settings.favicon);
            faviconData.value = settings.favicon;
          } else {
            clearFaviconPreview();
            faviconData.value = '';
          }

          await updateOverhead();

          // Store initial settings for comparison
          initialSettings = JSON.stringify(buildSettings());
          hasUnsavedChanges = false;
          updateSaveButton();
        } catch (e) {
          console.error('Failed to load settings:', e);
        }
      }

      // ============ SAVE SETTINGS ============

      discardBtn.addEventListener('click', async () => {
        const confirmed = await Modal.confirm('Alle nicht gespeicherten Änderungen verwerfen?');
        if (!confirmed) return;
        
        await loadSettings();
      });

      saveBtn.addEventListener('click', async () => {
        saveBtn.disabled = true;

        try {
          const settings = buildSettings();
          await App.saveSettings(settings);
          
          // Update initial settings and reset change tracking
          initialSettings = JSON.stringify(settings);
          hasUnsavedChanges = false;
          updateSaveButton();
          
          Toast.success('Einstellungen gespeichert');
        } catch (err) {
          Toast.error(err.message);
        } finally {
          saveBtn.disabled = false;
        }
      });

      // ============ WARN BEFORE LEAVING WITH UNSAVED CHANGES ============

      // Intercept navigation links
      document.querySelectorAll('a[href]:not([target="_blank"])').forEach(link => {
        link.addEventListener('click', async (e) => {
          if (hasUnsavedChanges && !link.id.includes('logout')) {
            e.preventDefault();
            const confirmed = await Modal.confirm('Du hast ungespeicherte Änderungen. Möchtest du die Seite wirklich verlassen?');
            if (confirmed) {
              hasUnsavedChanges = false; // Reset flag to allow navigation
              window.location.href = link.href;
            }
          }
        });
      });

      // ============ TOAST NOTIFICATIONS ============

      const Toast = (() => {
        let container = document.getElementById('toast-container');
        if (!container) {
          container = document.createElement('div');
          container.id = 'toast-container';
          container.className = 'toast-container';
          document.body.appendChild(container);
        }

        function show(text, type = 'success', duration = 3000) {
          const toast = document.createElement('div');
          toast.className = `toast ${type}`;
          toast.textContent = text;
          container.appendChild(toast);

          setTimeout(() => {
            toast.classList.add('hiding');
            toast.addEventListener('animationend', () => toast.remove());
          }, duration);
        }

        return {
          success: (text) => show(text, 'success'),
          error: (text) => show(text, 'error')
        };
      })();

      // ============ MODAL SYSTEM ============

      const Modal = (() => {
        const backdrop = document.getElementById('modal-backdrop');
        const modal = document.getElementById('modal');
        const message = document.getElementById('modal-message');
        const actions = document.getElementById('modal-actions');

        function hide() {
          modal.classList.add('hidden');
          backdrop.classList.add('hidden');
          modal.className = 'modal hidden';
          actions.innerHTML = '';
        }

        function show(text, buttons, type = '') {
          message.textContent = text;
          actions.innerHTML = '';
          modal.className = 'modal' + (type ? ` modal-${type}` : '');

          buttons.forEach(btn => {
            const button = document.createElement('button');
            button.type = 'button';
            button.textContent = btn.text;
            button.className = btn.class || '';
            button.addEventListener('click', () => {
              hide();
              if (btn.action) btn.action();
            });
            actions.appendChild(button);
          });

          backdrop.classList.remove('hidden');
          modal.classList.remove('hidden');
        }

        return {
          confirm(text) {
            return new Promise(resolve => {
              show(text, [
                { text: 'Ja', class: 'btn-primary', action: () => resolve(true) },
                { text: 'Abbrechen', class: 'btn-secondary', action: () => resolve(false) }
              ]);
            });
          },

          success(text) {
            show(text, [{ text: 'OK', class: 'btn-primary' }], 'success');
          },

          error(text) {
            show(text, [{ text: 'OK', class: 'btn-primary' }], 'error');
          },

          hide
        };
      })();

      // ============ UTILS ============

      function debounce(fn, delay) {
        let timeout;
        return (...args) => {
          clearTimeout(timeout);
          timeout = setTimeout(() => fn(...args), delay);
        };
      }

      // ============ INIT ============

      await loadSettings();
    })();
  </script>
</body>

</html>