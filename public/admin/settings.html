<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Einstellungen - fourteenkilobytes</title>
  <link rel="stylesheet" href="/admin/style.css">
</head>
<body>
  <div class="header">
    <div class="header-top">
      <a href="index.html" class="logo">&lt;14kb</a>
      <div class="header-secondary">
        <a href="/" target="_blank">Blog â†—</a>
      </div>
    </div>
    <nav class="main-nav">
      <a href="index.html">Ãœbersicht</a>
      <a href="editor.html">+ Neu</a>
      <a href="settings.html" class="active">Einstellungen</a>
    </nav>
  </div>

  <div id="message" class="message hidden"></div>

  <!-- Overhead Card -->
  <div class="editor-card">
    <div class="card-header">
      <h2 class="card-title">Overhead</h2>
    </div>
    <div class="card-body card-body-with-rail">
      <div class="card-content">
        <p class="text-muted">Globale Einstellungen werden in jede Seite eingebettet und verbrauchen Speicherplatz.</p>
      </div>
      <div class="card-rail build-rail" style="justify-content: center;">
        <div class="build-progress">
          <div class="pie-chart" id="overhead-pie-chart">
            <span class="pie-percent" id="overhead-percent">0%</span>
          </div>
          <div class="pie-legend">
            <div class="pie-legend-item">
              <span class="pie-dot pie-dot-overhead"></span>
              <span id="overhead-bytes">0 B</span>
            </div>
            <div class="pie-legend-item">
              <span class="pie-dot pie-dot-free"></span>
              <span>VerfÃ¼gbar</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Settings Card -->
  <div class="editor-card">
    <div class="card-header">
      <div class="settings-tabs">
        <button type="button" class="tab-btn active" data-tab="general">Allgemein</button>
        <button type="button" class="tab-btn" data-tab="header">Header</button>
        <button type="button" class="tab-btn" data-tab="footer">Footer</button>
        <button type="button" class="tab-btn" data-tab="css">CSS</button>
      </div>
    </div>
    <div class="card-body">
      <!-- General Tab -->
      <div id="tab-general" class="tab-content active">
        <div class="form-group">
          <label for="homepage-select">Startseite</label>
          <p class="text-small text-muted mb-1">WÃ¤hle eine Seite, die als Startseite (/) angezeigt werden soll</p>
          <div style="display: flex; gap: 0.5rem; align-items: center;">
            <select id="homepage-select" class="homepage-select" style="flex: 1;">
              <option value="">Standard (automatische Postliste)</option>
            </select>
            <button type="button" id="regenerate-homepage-btn" class="btn-small btn-secondary" style="display: none;">Aktualisieren</button>
          </div>
        </div>
      </div>

      <!-- Header Tab -->
      <div id="tab-header" class="tab-content hidden">
        <div class="override-section override-section-first">
          <div class="override-section-header">
            <label class="override-toggle">
              <input type="checkbox" id="header-enabled">
              <span>Header aktivieren</span>
            </label>
          </div>
          <div id="header-editor" class="override-editor hidden">
            <p class="text-small text-muted mb-1">Navigation-Links (erscheinen in jeder Seite)</p>
            <div class="nav-editor-row">
              <div id="header-links" class="nav-links"></div>
              <button type="button" id="add-header-link" class="btn-primary">+ Link</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Footer Tab -->
      <div id="tab-footer" class="tab-content hidden">
        <div class="override-section override-section-first">
          <div class="override-section-header">
            <label class="override-toggle">
              <input type="checkbox" id="footer-enabled">
              <span>Footer aktivieren</span>
            </label>
          </div>
          <div id="footer-editor" class="override-editor hidden">
            <p class="text-small text-muted mb-1">Footer-Text (HTML erlaubt, <code>{{bytes}}</code> fÃ¼r Byte-Anzeige)</p>
            <div class="footer-editor-row">
              <input type="text" id="footer-content" placeholder="Â© 2026 | {{bytes}}/14336 bytes">
            </div>
          </div>
        </div>
      </div>

      <!-- CSS Tab -->
      <div id="tab-css" class="tab-content hidden">
        <div class="form-group">
          <label for="css-mode">CSS-Vorlage</label>
          <p class="text-small text-muted mb-1">WÃ¤hle eine Vorlage oder verwende eigenes CSS</p>
          <select id="css-mode">
            <option value="default">Default (System-Fonts, neutral)</option>
            <option value="light">Light (Serif, hell)</option>
            <option value="dark">Dark (Dunkelmodus)</option>
            <option value="custom">Eigenes CSS</option>
          </select>
        </div>

        <!-- Preview for presets -->
        <div id="css-preset-preview" class="css-preview">
          <p class="text-small text-muted mb-1">Vorschau (nur lesen)</p>
          <pre id="css-preview-content" class="css-preview-code"></pre>
        </div>

        <!-- Custom CSS editor -->
        <div id="css-custom-editor" class="hidden">
          <p class="text-small text-muted mb-1">Eigene CSS-Regeln (werden in jede Seite eingebettet)</p>
          <textarea id="global-css" rows="12" placeholder="body {
  font-family: Georgia, serif;
  max-width: 600px;
  margin: 0 auto;
}"></textarea>
        </div>
      </div>
    </div>
  </div>

  <!-- Link Edit Popup -->
  <div id="link-popup" class="nav-link-popup hidden">
    <div class="popup-content">
      <div class="form-group">
        <label>Text</label>
        <input type="text" id="link-text" placeholder="Home">
      </div>
      <div class="form-group">
        <label>Ziel</label>
        <input type="text" id="link-href" placeholder="/">
      </div>
      <div class="popup-actions">
        <button type="button" id="link-save">OK</button>
        <button type="button" id="link-delete" class="btn-danger btn-small hidden">LÃ¶schen</button>
        <button type="button" id="link-cancel" class="btn-secondary">Abbrechen</button>
      </div>
    </div>
  </div>

  <!-- Save Card -->
  <div class="editor-card">
    <div class="card-body" style="display: flex; justify-content: flex-end; gap: 16px; align-items: center;">
      <span id="byte-text" class="text-muted text-small">Overhead: 0 / 14.336 Bytes</span>
      <button id="save-btn" class="btn-primary build-publish-btn" style="width: auto;">Speichern</button>
    </div>
  </div>

  <script type="module" src="app.js"></script>
  <script type="module">
    (async function() {
      // Check if setup is complete
      const status = await App.getSetupStatus();
      if (!status.setupComplete) {
        window.location.href = '/admin/setup';
        return;
      }

      // Check auth
      const config = await App.getConfig();
      if (config.authEnabled && !(await App.isLoggedIn())) {
        window.location.href = 'index.html';
        return;
      }

      // Elements
      const homepageSelect = document.getElementById('homepage-select');
      const regenerateHomepageBtn = document.getElementById('regenerate-homepage-btn');
      const headerEnabled = document.getElementById('header-enabled');
      const headerEditor = document.getElementById('header-editor');
      const headerLinks = document.getElementById('header-links');
      const addHeaderLinkBtn = document.getElementById('add-header-link');
      const footerEnabled = document.getElementById('footer-enabled');
      const footerEditor = document.getElementById('footer-editor');
      const footerContent = document.getElementById('footer-content');
      const cssMode = document.getElementById('css-mode');
      const cssPresetPreview = document.getElementById('css-preset-preview');
      const cssPreviewContent = document.getElementById('css-preview-content');
      const cssCustomEditor = document.getElementById('css-custom-editor');
      const globalCss = document.getElementById('global-css');
      const linkPopup = document.getElementById('link-popup');
      const linkText = document.getElementById('link-text');
      const linkHref = document.getElementById('link-href');
      const linkSave = document.getElementById('link-save');
      const linkDelete = document.getElementById('link-delete');
      const linkCancel = document.getElementById('link-cancel');
      const saveBtn = document.getElementById('save-btn');
      const messageEl = document.getElementById('message');
      const overheadBytesEl = document.getElementById('overhead-bytes');
      const overheadPieChart = document.getElementById('overhead-pie-chart');
      const overheadPercent = document.getElementById('overhead-percent');
      const byteText = document.getElementById('byte-text');

      // Tab elements
      const tabBtns = document.querySelectorAll('.tab-btn');
      const tabContents = document.querySelectorAll('.tab-content');

      // State
      let editingLink = null;

      // ============ HOMEPAGE ============

      function updateRegenerateButton() {
        const selectedSlug = homepageSelect.value;
        if (selectedSlug) {
          regenerateHomepageBtn.style.display = 'block';
        } else {
          regenerateHomepageBtn.style.display = 'none';
        }
      }

      homepageSelect.addEventListener('change', updateRegenerateButton);

      regenerateHomepageBtn.addEventListener('click', async () => {
        const slug = homepageSelect.value;
        if (!slug) return;

        if (!confirm(`Startseite "${slug}" mit aktuellen Posts neu generieren?`)) return;

        regenerateHomepageBtn.disabled = true;
        regenerateHomepageBtn.textContent = 'â³ Generiere...';
        hideMessage();

        try {
          await App.republishPost(slug);
          showMessage('Startseite erfolgreich aktualisiert!', 'success');
          regenerateHomepageBtn.textContent = 'âœ“ Aktualisiert';
          setTimeout(() => {
            regenerateHomepageBtn.textContent = 'ðŸ”„ Aktualisieren';
            regenerateHomepageBtn.disabled = false;
          }, 2000);
        } catch (err) {
          showMessage(`Fehler: ${err.message}`, 'error');
          regenerateHomepageBtn.textContent = 'ðŸ”„ Aktualisieren';
          regenerateHomepageBtn.disabled = false;
        }
      });

      // ============ TABS ============

      tabBtns.forEach(btn => {
        btn.addEventListener('click', () => {
          const tab = btn.dataset.tab;
          tabBtns.forEach(b => b.classList.toggle('active', b === btn));
          tabContents.forEach(c => c.classList.toggle('active', c.id === `tab-${tab}`));
          tabContents.forEach(c => c.classList.toggle('hidden', c.id !== `tab-${tab}`));
        });
      });

      // ============ HEADER EDITOR ============

      headerEnabled.addEventListener('change', () => {
        headerEditor.classList.toggle('hidden', !headerEnabled.checked);
        updateOverhead();
      });

      function createLinkChip(text, href) {
        const chip = document.createElement('span');
        chip.className = 'nav-chip';
        chip.dataset.href = href;
        chip.textContent = text;
        chip.addEventListener('click', () => editLink(chip));
        return chip;
      }

      function editLink(chip) {
        editingLink = chip;
        linkText.value = chip.textContent;
        linkHref.value = chip.dataset.href;
        linkDelete.classList.remove('hidden');
        linkPopup.classList.remove('hidden');
        linkText.focus();
      }

      addHeaderLinkBtn.addEventListener('click', () => {
        editingLink = null;
        linkText.value = '';
        linkHref.value = '';
        linkDelete.classList.add('hidden');
        linkPopup.classList.remove('hidden');
        linkText.focus();
      });

      linkSave.addEventListener('click', () => {
        const text = linkText.value.trim();
        const href = linkHref.value.trim();
        if (!text || !href) return;

        if (editingLink) {
          editingLink.textContent = text;
          editingLink.dataset.href = href;
        } else {
          headerLinks.appendChild(createLinkChip(text, href));
        }
        linkPopup.classList.add('hidden');
        editingLink = null;
        updateOverhead();
      });

      linkDelete.addEventListener('click', () => {
        if (editingLink) {
          editingLink.remove();
        }
        linkPopup.classList.add('hidden');
        editingLink = null;
        updateOverhead();
      });

      linkCancel.addEventListener('click', () => {
        linkPopup.classList.add('hidden');
        editingLink = null;
      });

      // ============ FOOTER EDITOR ============

      footerEnabled.addEventListener('change', () => {
        footerEditor.classList.toggle('hidden', !footerEnabled.checked);
        updateOverhead();
      });

      footerContent.addEventListener('input', debounce(updateOverhead, 300));

      // ============ CSS EDITOR ============

      async function updateCssModeUI() {
        const mode = cssMode.value;
        const isCustom = mode === 'custom';

        cssPresetPreview.classList.toggle('hidden', isCustom);
        cssCustomEditor.classList.toggle('hidden', !isCustom);

        if (!isCustom) {
          // Show preset CSS in preview
          const presets = await App.loadCssPresets();
          cssPreviewContent.textContent = presets[mode] || '';
        }
        updateOverhead();
      }

      cssMode.addEventListener('change', () => updateCssModeUI());
      globalCss.addEventListener('input', debounce(updateOverhead, 300));

      // ============ BUILD SETTINGS ============

      function getHeaderLinks() {
        const chips = headerLinks.querySelectorAll('.nav-chip');
        return Array.from(chips).map(chip => ({
          text: chip.textContent,
          href: chip.dataset.href
        }));
      }

      function buildSettings() {
        return {
          version: 1,
          homepageSlug: homepageSelect.value || null,
          cssMode: cssMode.value,
          globalCss: globalCss.value.trim(),
          header: {
            enabled: headerEnabled.checked,
            links: getHeaderLinks(),
          },
          footer: {
            enabled: footerEnabled.checked,
            content: footerContent.value.trim(),
          },
        };
      }

      // ============ OVERHEAD CALCULATION ============

      function formatBytes(bytes) {
        if (bytes === 0) return '0 B';
        if (bytes < 1000) return bytes + ' B';
        return (bytes / 1024).toFixed(1) + ' KB';
      }

      async function updateOverhead() {
        try {
          const settings = buildSettings();
          const res = await App.previewOverhead(settings);
          const bytes = res.overheadBytes;
          const limit = 14336;
          const percent = Math.min((bytes / limit) * 100, 100);
          const overheadDeg = (percent / 100) * 360;

          overheadBytesEl.textContent = formatBytes(bytes);
          byteText.textContent = `Overhead: ${formatBytes(bytes)} / ${formatBytes(limit)}`;
          overheadPercent.textContent = `${Math.round(percent)}%`;

          // Determine color based on usage
          let overheadColor = 'var(--gray-400)';
          if (percent >= 75) {
            overheadColor = '#dc2626';
          } else if (percent >= 50) {
            overheadColor = '#f59e0b';
          }

          overheadPieChart.style.background = `conic-gradient(
            ${overheadColor} 0deg ${overheadDeg}deg,
            var(--gray-200) ${overheadDeg}deg 360deg
          )`;
        } catch (e) {
          console.error('Overhead calculation failed:', e);
        }
      }

      // ============ LOAD SETTINGS ============

      async function loadSettings() {
        try {
          const settings = await App.getSettings();
          const allPosts = await App.getPosts();

          console.log('Posts Data:', allPosts);
          
          // Homepage
          homepageSelect.innerHTML = '<option value="">â€” Standard (automatische Postliste) â€”</option>';
          const pages = allPosts.filter(p => p.pageType === 'page' && p.status === 'published');
          console.log('Filtered pages:', pages);
          
          for (const page of pages) {
            const option = document.createElement('option');
            option.value = page.slug;
            option.textContent = page.title;
            homepageSelect.appendChild(option);
          }
          homepageSelect.value = settings.homepageSlug || '';

          // Update regenerate button visibility
          updateRegenerateButton();

          // Header
          headerEnabled.checked = settings.header.enabled;
          headerEditor.classList.toggle('hidden', !settings.header.enabled);
          headerLinks.innerHTML = '';
          for (const link of settings.header.links) {
            headerLinks.appendChild(createLinkChip(link.text, link.href));
          }

          // Footer
          footerEnabled.checked = settings.footer.enabled;
          footerEditor.classList.toggle('hidden', !settings.footer.enabled);
          footerContent.value = settings.footer.content;

          // CSS
          cssMode.value = settings.cssMode || 'default';
          globalCss.value = settings.globalCss || '';
          updateCssModeUI();

          await updateOverhead();
        } catch (e) {
          console.error('Failed to load settings:', e);
        }
      }

      // ============ SAVE SETTINGS ============

      saveBtn.addEventListener('click', async () => {
        saveBtn.disabled = true;
        hideMessage();

        try {
          const settings = buildSettings();
          await App.saveSettings(settings);
          showMessage('Einstellungen gespeichert', 'success');
        } catch (err) {
          showMessage(err.message, 'error');
        } finally {
          saveBtn.disabled = false;
        }
      });

      // ============ MESSAGES ============

      function showMessage(text, type = 'error') {
        messageEl.textContent = text;
        messageEl.className = `message ${type}`;
        messageEl.classList.remove('hidden');
      }

      function hideMessage() {
        messageEl.classList.add('hidden');
      }

      // ============ UTILS ============

      function debounce(fn, delay) {
        let timeout;
        return (...args) => {
          clearTimeout(timeout);
          timeout = setTimeout(() => fn(...args), delay);
        };
      }

      // ============ INIT ============

      await loadSettings();
    })();
  </script>
</body>
</html>
