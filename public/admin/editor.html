<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Editor - fourteenkilobytes</title>
  <link rel="icon" type="image/png" sizes="32x32" href="/admin/favicon-32x32.png">
  <link rel="stylesheet" href="/admin/style.css">
  <link rel="stylesheet" href="/admin/sections.css">
  <link rel="modulepreload" href="/admin/i18n.js">
  <link rel="modulepreload" href="/admin/app.js">
  <link rel="modulepreload" href="/admin/lib/common.js">
  <link rel="modulepreload" href="/admin/lib/css-utils.js">
  <link rel="modulepreload" href="/admin/lib/byte-utils.js">
  <link rel="modulepreload" href="/admin/lib/settings-utils.js">
  <link rel="modulepreload" href="/admin/lib/content-utils.js">
  <link rel="modulepreload" href="/admin/lib/editor-core.js">
  <script type="module" src="/admin/i18n.js"></script>
</head>

<body>
  <div id="loading-overlay" class="loading-overlay instant">
    <div class="loading-state">
      <div class="loading-spinner"></div>
      <span>Loading...</span>
    </div>
  </div>

  <header class="header">
    <div class="header-top">
      <div class="logo-container">
        <a href="/admin/index.html" class="logo" aria-label="14KB Dashboard">
          <svg version="1.0" xmlns="http://www.w3.org/2000/svg" width="32" height="32"
            viewBox="0 0 191.000000 191.000000" preserveAspectRatio="xMidYMid meet" aria-hidden="true">
            <g transform="translate(0.000000,191.000000) scale(0.100000,-0.100000)" fill="currentColor" stroke="none">
              <path d="M406 1889 c-175 -35 -325 -178 -371 -356 -21 -81 -22 -1071 -1 -1149
47 -176 194 -315 374 -353 61 -13 1058 -16 1066 -3 2 4 -22 29 -55 55 -67 54
-152 157 -220 265 -24 39 -46 71 -49 72 -3 0 -18 -21 -34 -46 -41 -65 -64 -78
-116 -64 -63 17 -74 3 -65 -82 5 -57 4 -69 -10 -74 -24 -10 -45 15 -45 54 0
34 -1 34 -19 18 -10 -9 -21 -31 -25 -47 -5 -26 -10 -30 -33 -27 -23 2 -29 8
-31 35 -3 27 1 35 22 44 26 12 40 35 30 50 -9 16 -22 10 -58 -27 -40 -41 -72
-40 -82 2 -8 31 5 46 54 59 49 14 52 37 7 54 -19 7 -40 9 -45 6 -29 -18 -54
47 -28 73 17 17 35 15 66 -8 15 -12 41 -22 57 -23 28 -2 30 0 27 28 -8 85 -7
89 12 93 24 5 46 -23 46 -58 0 -37 29 -60 75 -60 51 0 69 18 101 106 l27 74
-19 42 c-26 59 -98 111 -196 143 -68 23 -91 36 -129 75 -58 59 -82 121 -109
278 -33 194 -24 242 44 242 36 0 242 -68 310 -102 87 -43 125 -102 140 -218 9
-60 39 -108 79 -125 20 -8 76 -15 138 -16 57 -1 142 -8 188 -15 46 -8 87 -12
90 -9 9 10 1 84 -14 119 -8 20 -25 41 -37 47 -20 11 -25 8 -55 -27 -27 -33
-35 -37 -50 -28 -10 6 -19 22 -21 36 -2 20 5 30 33 47 45 26 37 45 -16 38 -44
-6 -75 18 -65 51 9 29 30 33 70 17 57 -24 63 -18 22 24 -40 41 -44 66 -13 85
24 15 49 -2 59 -41 4 -17 15 -36 23 -43 21 -18 31 12 17 56 -8 27 -7 37 5 49
36 37 68 5 59 -58 -5 -32 -3 -47 8 -56 11 -9 18 -6 35 16 40 54 41 54 62 42
28 -15 22 -60 -11 -76 -57 -28 -65 -87 -25 -201 28 -82 31 -131 10 -171 -16
-31 -33 -41 -71 -41 -14 0 -34 -5 -45 -11 -26 -13 -15 -27 61 -79 30 -21 91
-70 135 -109 44 -39 85 -71 92 -71 20 0 18 909 -2 1003 -15 73 -58 162 -106
221 -40 48 -135 112 -207 139 -55 21 -71 22 -587 23 -305 1 -551 -2 -579 -7z" />
            </g>
          </svg>
          <span class="logo-text" aria-hidden="true">14<br>KB</span>
        </a>
      </div>
      <nav class="header-nav" aria-label="Main navigation">
        <a href="/admin/index.html" class="nav-icon">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
            aria-hidden="true">
            <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" />
            <polyline points="9 22 9 12 15 12 15 22" />
          </svg>
          <span data-i18n="nav.overview">Overview</span>
        </a>
        <a href="/admin/editor.html" class="nav-icon active" aria-current="page">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
            aria-hidden="true">
            <line x1="12" y1="5" x2="12" y2="19" />
            <line x1="5" y1="12" x2="19" y2="12" />
          </svg>
          <span data-i18n="nav.new">New</span>
        </a>
        <a href="/admin/settings.html" class="nav-icon">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
            aria-hidden="true">
            <circle cx="12" cy="12" r="3" />
            <path
              d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z" />
          </svg>
          <span data-i18n="nav.settings">Settings</span>
        </a>
        <a href="/" target="_blank" rel="noopener" class="nav-icon external-link">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
            aria-hidden="true">
            <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6" />
            <polyline points="15 3 21 3 21 9" />
            <line x1="10" y1="14" x2="21" y2="3" />
          </svg>
          <span data-i18n="nav.blog">Blog</span>
        </a>
        <span class="nav-separator" aria-hidden="true"></span>
        <a href="#" id="logout-btn" class="nav-icon logout-icon">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
            aria-hidden="true">
            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" />
            <polyline points="16 17 21 12 16 7" />
            <line x1="21" y1="12" x2="9" y2="12" />
          </svg>
          <span data-i18n="nav.logout">Logout</span>
        </a>
      </nav>
    </div>
    <div style="margin-top: 32px;">
      <div>
        <h1 id="page-title" class="page-title" style="margin: 0;" data-i18n="editor.new">New</h1>
        <p id="page-subtitle" class="page-subtitle" style="margin: 4px 0 0 0;">Creating source · not yet compiled</p>
      </div>
      <div style="display: flex; gap: 12px; align-items: center; justify-content: flex-end; margin-top: 16px;">
        <div id="template-selector-container" style="display: flex; gap: 12px; align-items: center;">
          <select id="template-selector" class="page-type-select">
            <option value="" data-i18n="editor.templatesSelect">Select template...</option>
          </select>
        </div>
        <button type="button" id="clear-all-btn" class="btn btn-danger"> <svg width="14" height="14" viewBox="0 0 24 24"
            fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="23 4 23 10 17 10"></polyline>
            <polyline points="1 20 1 14 7 14"></polyline>
            <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
          </svg><span data-i18n="editor.resetBtn">Reset</span></button>
      </div>
    </div>
  </header>

  <div class="editor-card">
    <div class="card-header">
      <h2 class="card-title" data-i18n="editor.head">Head</h2>
    </div>
    <div class="card-body card-body-grid">
      <div class="base-data-row">
        <div class="form-group">
          <label for="title" data-i18n="editor.title">Title</label>
          <input type="text" id="title" data-i18n-placeholder="editor.titlePlaceholder" placeholder="My first post">
        </div>
        <div class="form-group">
          <label for="slug" data-i18n="editor.slug">Slug</label>
          <input type="text" id="slug" data-i18n-placeholder="editor.slugPlaceholder" placeholder="my-first-post">
        </div>
        <div class="form-group">
          <label for="page-type" data-i18n="editor.pageType">Page Type</label>
          <select id="page-type" class="page-type-select">
            <option value="post" data-i18n="editor.pageTypePost">Post</option>
            <option value="page" data-i18n="editor.pageTypePage">Page</option>
          </select>
          <span id="page-type-hint" class="text-small text-muted"></span>
        </div>
      </div>
      <div class="rail-item">
        <span data-i18n="editor.blogTitle">Blog Title</span>
        <span id="title-bytes">0 B</span>
      </div>

      <div class="override-section">
        <div class="override-section-header">
          <label class="override-toggle">
            <input type="checkbox" id="title-override-enabled">
            <span data-i18n="editor.browserTabTitle">Browser Tab Title</span>
          </label>
          <p id="title-override-hint" class="override-hint"><svg class="hint-icon" width="12" height="12"
              viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="20 6 9 17 4 12" />
            </svg> <span data-i18n="editor.browserTabTitleHint">Using title only</span></p>
        </div>
        <div id="title-override-editor" class="override-editor">
          <div class="form-group">
            <label for="title-override" data-i18n="editor.browserTabTitle">Browser Tab Title</label>
            <input type="text" id="title-override" maxlength="100" placeholder="Custom browser tab title..." disabled>
          </div>
        </div>
      </div>
      <div class="rail-item" id="title-rail-item">
        <span data-i18n="editor.browserTabTitle">Browser Tab Title</span>
        <span id="browser-title-bytes">0 B</span>
      </div>

      <div class="override-section">
        <div class="override-section-header">
          <label class="override-toggle">
            <input type="checkbox" id="meta-enabled">
            <span data-i18n="settings.meta">Meta</span>
          </label>
          <p id="meta-global-hint" class="override-hint" data-i18n="settings.metaHint">Global SEO tags</p>
        </div>
        <div id="meta-editor" class="override-editor hidden">
          <div class="meta-row">
            <div class="form-group">
              <label for="meta-description" data-i18n="settings.metaDescription">Description</label>
              <input type="text" id="meta-description" maxlength="160"
                data-i18n-placeholder="settings.metaDescriptionPlaceholder" placeholder="Page description...">
            </div>
            <div class="form-group">
              <label for="meta-author" data-i18n="settings.metaAuthor">Author</label>
              <input type="text" id="meta-author" maxlength="100" data-i18n-placeholder="settings.metaAuthorPlaceholder"
                placeholder="Author name">
            </div>
          </div>
        </div>
      </div>
      <div class="rail-item" id="meta-rail-item">
        <span data-i18n="settings.meta">Meta</span>
        <span id="meta-bytes">0 B</span>
      </div>

      <div class="override-section">
        <div class="override-section-header">
          <label class="override-toggle">
            <input type="checkbox" id="nav-enabled">
            <span data-i18n="settings.navigation">Navigation</span>
          </label>
          <p id="nav-global-hint" class="override-hint" data-i18n="settings.navigationHint">Navigation links</p>
        </div>
        <div id="nav-editor" class="override-editor hidden">
          <p class="text-small text-muted mb-1" data-i18n="settings.navigationHint">Navigation links (appear on every
            page)</p>
          <div class="nav-editor-row">
            <div id="nav-links" class="nav-links"></div>
            <button type="button" id="add-nav-link" class="btn btn-secondary" data-i18n="settings.navigationAddLink">+
              Link</button>
          </div>
        </div>
      </div>
      <div class="rail-item" id="nav-rail-item">
        <span data-i18n="settings.navigation">Navigation</span>
        <span id="nav-bytes">0 B</span>
      </div>
    </div>
  </div>

  <div class="editor-card">
    <div class="card-header">
      <h2 class="card-title" data-i18n="editor.body">Body</h2>
    </div>
    <div class="card-body card-body-grid">
      <div class="block-editor-wrapper">
        <div id="block-editor" class="block-editor"></div>
        <div class="block-actions-row">
          <button type="button" id="add-block-btn" class="btn btn-secondary" data-i18n="editor.addBlock">+ Add
            Block</button>
          <div id="add-block-dropdown" class="add-block-dropdown hidden">
            <button type="button" data-type="paragraph" data-i18n="editor.blockParagraph">Paragraph</button>
            <button type="button" data-type="heading" data-level="2" data-i18n="editor.blockHeading">Heading</button>
            <button type="button" data-type="list" data-list-type="unordered" data-i18n="editor.blockList">List</button>
            <button type="button" data-type="divider" data-i18n="editor.blockDivider">Divider</button>
            <button type="button" data-type="spacer" data-i18n="editor.blockSpacer">Spacer</button>
            <button type="button" data-type="bloglist" data-i18n="editor.blockBloglist">Bloglist</button>
            <button type="button" data-type="section" data-i18n="editor.blockSection">Section</button>
          </div>
        </div>
      </div>
      <div class="rail-item rail-item-total" id="content-rail">
        <span data-i18n="editor.body">Body</span>
        <span id="cost-content-total">0 B</span>
      </div>
    </div>
  </div>

  <div class="editor-card">
    <div class="card-header">
      <h2 class="card-title" data-i18n="editor.footer">Footer</h2>
    </div>
    <div class="card-body card-body-grid">
      <div class="override-section override-section-first">
        <div class="override-section-header">
          <label class="override-toggle">
            <input type="checkbox" id="footer-enabled">
            <span data-i18n="settings.footerSection">Footer</span>
          </label>
          <p id="footer-global-hint" class="override-hint" data-i18n="settings.footerHint">Footer text</p>
        </div>
        <div id="footer-editor" class="override-editor hidden">
          <div class="footer-editor-row">
            <input type="text" id="footer-text" placeholder="© 2024 My Blog">
            <button type="button" id="insert-bytes-btn" class="btn btn-secondary"
              data-i18n="settings.footerBytesBtn">{{bytes}}</button>
          </div>
        </div>
      </div>
      <div class="rail-item">
        <span data-i18n="settings.footerSection">Footer</span>
        <span id="footer-bytes">0 B</span>
      </div>

      <div class="override-section">
        <div class="override-section-header">
          <label class="override-toggle">
            <input type="checkbox" id="css-enabled">
            <span data-i18n="tabs.css">CSS</span>
          </label>
          <p id="css-global-hint" class="override-hint"></p>
        </div>
        <div id="css-editor" class="override-editor">
          <p class="css-warning-hint" data-i18n="settings.cssCustomHint">Custom CSS rules (embedded in every page)</p>
          <textarea id="css-rules" rows="10" data-i18n-placeholder="settings.cssCustom"
            placeholder="/* Additional CSS */"></textarea>
        </div>
      </div>
      <div class="rail-item">
        <span data-i18n="tabs.css">CSS</span>
        <span id="css-bytes">0 B</span>
      </div>
    </div>
  </div>

  <div id="nav-link-popup" class="nav-link-popup hidden">
    <div class="popup-content">
      <div class="form-group">
        <label data-i18n="linkPopup.text">Text</label>
        <input type="text" id="nav-link-text" data-i18n-placeholder="linkPopup.textPlaceholder" placeholder="Home">
      </div>
      <div class="form-group">
        <label data-i18n="linkPopup.target">Target</label>
        <input type="text" id="nav-link-href" data-i18n-placeholder="linkPopup.targetPlaceholder" placeholder="/">
      </div>
      <div class="popup-actions">
        <button type="button" id="nav-link-save" class="btn btn-primary" data-i18n="linkPopup.save">OK</button>
        <button type="button" id="nav-link-delete" class="btn btn-danger" data-i18n="linkPopup.delete">Delete</button>
        <button type="button" id="nav-link-cancel" class="btn btn-secondary"
          data-i18n="linkPopup.cancel">Cancel</button>
      </div>
    </div>
  </div>


  <div id="link-popup" class="link-popup hidden">
    <div class="link-prefix-buttons">
      <button type="button" class="link-prefix-btn" data-prefix="https://" title="URL">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10" />
          <line x1="2" y1="12" x2="22" y2="12" />
          <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z" />
        </svg>
      </button>
      <button type="button" class="link-prefix-btn" data-prefix="mailto:" title="E-Mail">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z" />
          <polyline points="22,6 12,13 2,6" />
        </svg>
      </button>
      <button type="button" class="link-prefix-btn" data-prefix="tel:" title="Telefon">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path
            d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z" />
        </svg>
      </button>
    </div>
    <input type="text" id="link-href" placeholder="/path or #anchor">
    <button type="button" id="link-apply" class="btn btn-primary">OK</button>
    <button type="button" id="link-cancel" class="btn btn-secondary">×</button>
  </div>

  <div id="modal-backdrop" class="modal-backdrop hidden"></div>
  <div id="modal" class="modal hidden">
    <div class="modal-content">
      <p id="modal-message"></p>
      <div id="modal-actions" class="popup-actions"></div>
    </div>
  </div>

  <div class="editor-card">
    <div class="card-header">
      <h2 class="card-title">Build</h2>
    </div>
    <div class="card-body card-body-with-rail">
      <div class="card-content">
        <div class="breakdown-table">
          <div class="breakdown-row">
            <span>Base</span>
            <span id="breakdown-base">0 B</span>
          </div>
          <div class="breakdown-row">
            <span>Title</span>
            <span id="breakdown-title">0 B</span>
          </div>
          <div class="breakdown-row">
            <span>Favicon</span>
            <span id="breakdown-favicon">0 B</span>
          </div>
          <div class="breakdown-row">
            <span>Navigation</span>
            <span id="breakdown-nav">0 B</span>
          </div>
          <div class="breakdown-row">
            <span>Meta</span>
            <span id="breakdown-meta">0 B</span>
          </div>
          <div class="breakdown-row">
            <span>Footer</span>
            <span id="breakdown-footer">0 B</span>
          </div>
          <div class="breakdown-row">
            <span>CSS</span>
            <span id="breakdown-css">0 B</span>
          </div>
          <div class="breakdown-row">
            <span>Content</span>
            <span id="breakdown-content">0 B</span>
          </div>
          <div class="breakdown-row breakdown-row-total">
            <span>Total</span>
            <span id="breakdown-total">0 B / 14.336 B</span>
          </div>
        </div>
      </div>
      <div class="card-rail build-rail">
        <div class="build-progress">
          <div class="pie-chart" id="pie-chart">
            <span class="pie-percent" id="pie-percent">0%</span>
          </div>
          <div class="pie-legend">
            <div class="pie-legend-item">
              <span class="pie-dot pie-dot-overhead"></span>
              <span>Overhead</span>
            </div>
            <div class="pie-legend-item">
              <span class="pie-dot pie-dot-content"></span>
              <span>Content</span>
            </div>
            <div class="pie-legend-item">
              <span class="pie-dot pie-dot-free"></span>
              <span>Free</span>
            </div>
          </div>
        </div>
        <button id="publish-btn" class="btn btn-primary build-publish-btn" data-i18n="editor.buildPublish">Compile &
          Publish</button>
      </div>
    </div>
  </div>

  <style id="live-css"></style>

  <script type="module" src="/admin/app.js"></script>
  <script type="module">
    import * as Compiler from './compiler.browser.js';
    import { debounce, initAuthGuard, setupLogoutHandler, hideLoadingOverlay } from './lib/common.js';
    import { inlineNodesToHtml, serializeBlock } from './lib/editor-core.js';
    import { formatBytes } from './lib/byte-utils.js';
    import { estimateBlockSize } from './lib/byte-estimation.js';
    import { validatePublishData, determinePaginationStrategy, executePublish, resetEditorForm } from './lib/publish-workflow.js';
    import { createBlockSelectorControl, createInnerAddBlock, createByteIndicator } from './lib/block-ui-utils.js';
    import { createSectionBlock, createLayoutBlock } from './lib/block-builders.js';
    import { createModalManager } from './lib/modal-utils.js';
    import { updateBlockStyling, insertBlockBelow, moveBlock as moveBlockUtil, toggleSelectionWrap } from './lib/block-operations.js';
    import { createTextBlockTypeSelector, createHeadingLevelSelector, createListTypeSelector, createBlockTypeLabel, createFormatButtons } from './lib/block-type-selectors.js';
    import { createBloglistContent, createListContent, createDividerContent, createSpacerContent, createCodeblockContent, createBlockquoteContent, createParagraphContent, createHeadingContent } from './lib/block-content-builders.js';
    import { createEditorStateManager } from './lib/editor/state.js';
    import { createEditorMetricsManager } from './lib/editor/metrics.js';
    import { createEditorOverridesManager } from './lib/editor/overrides.js';
    import { createEditorBuildInputManager } from './lib/editor/build-input.js';
    import { createEditorBlockFactory } from './lib/editor/block-factory.js';
    import { createEditorSourceLoader } from './lib/editor/source-loader.js';
    import { createEditorRichtextTools } from './lib/editor/richtext-tools.js';
    import { createEditorBootstrap } from './lib/editor/bootstrap.js';

    let debouncedPreview = () => { };

    (async function () {
      await initAuthGuard({ redirectIfNotAuth: 'index.html' });
      const settings = await App.getSettings();
      window.globalConfig = settings;
      hideLoadingOverlay();
      setupLogoutHandler();
      const pageTypeSelect = document.getElementById('page-type');
      const pageTypeHint = document.getElementById('page-type-hint');
      const titleInput = document.getElementById('title');
      const slugInput = document.getElementById('slug');
      const blockEditor = document.getElementById('block-editor');
      const addBlockBtn = document.getElementById('add-block-btn');
      const addBlockDropdown = document.getElementById('add-block-dropdown');
      const linkPopup = document.getElementById('link-popup');
      const linkHrefInput = document.getElementById('link-href');
      const linkApplyBtn = document.getElementById('link-apply');
      const linkCancelBtn = document.getElementById('link-cancel');
      const navEnabled = document.getElementById('nav-enabled');
      const navEditor = document.getElementById('nav-editor');
      const navGlobalHint = document.getElementById('nav-global-hint');
      const navLinks = document.getElementById('nav-links');
      const addNavLinkBtn = document.getElementById('add-nav-link');
      const navLinkPopup = document.getElementById('nav-link-popup');
      const navLinkText = document.getElementById('nav-link-text');
      const navLinkHref = document.getElementById('nav-link-href');
      const navLinkSave = document.getElementById('nav-link-save');
      const navLinkDelete = document.getElementById('nav-link-delete');
      const navLinkCancel = document.getElementById('nav-link-cancel');
      const footerEnabled = document.getElementById('footer-enabled');
      const footerEditor = document.getElementById('footer-editor');
      const footerGlobalHint = document.getElementById('footer-global-hint');
      const footerText = document.getElementById('footer-text');
      const titleOverrideEnabled = document.getElementById('title-override-enabled');
      const titleOverrideEditor = document.getElementById('title-override-editor');
      const titleOverrideHint = document.getElementById('title-override-hint');
      const titleOverrideInput = document.getElementById('title-override');
      const metaEnabled = document.getElementById('meta-enabled');
      const metaEditor = document.getElementById('meta-editor');
      const metaGlobalHint = document.getElementById('meta-global-hint');
      const metaDescription = document.getElementById('meta-description');
      const metaAuthor = document.getElementById('meta-author');
      const cssEnabled = document.getElementById('css-enabled');
      const cssEditor = document.getElementById('css-editor');
      const cssGlobalHint = document.getElementById('css-global-hint');
      const cssRules = document.getElementById('css-rules');
      const liveCSS = document.getElementById('live-css');
      const publishBtn = document.getElementById('publish-btn');

      const costContentTotal = document.getElementById('cost-content-total');
      const contentRail = document.getElementById('content-rail');
      const titleBytesEl = document.getElementById('title-bytes');
      const browserTitleBytesEl = document.getElementById('browser-title-bytes');
      const navBytesEl = document.getElementById('nav-bytes');
      const metaBytesEl = document.getElementById('meta-bytes');
      const footerBytesEl = document.getElementById('footer-bytes');
      const cssBytesEl = document.getElementById('css-bytes');

      const breakdownBase = document.getElementById('breakdown-base');
      const breakdownTitle = document.getElementById('breakdown-title');
      const breakdownFavicon = document.getElementById('breakdown-favicon');
      const breakdownNav = document.getElementById('breakdown-nav');
      const breakdownMeta = document.getElementById('breakdown-meta');
      const breakdownFooter = document.getElementById('breakdown-footer');
      const breakdownCss = document.getElementById('breakdown-css');
      const breakdownContent = document.getElementById('breakdown-content');
      const breakdownTotal = document.getElementById('breakdown-total');
      const pieChart = document.getElementById('pie-chart');
      const piePercent = document.getElementById('pie-percent');
      const pieContentDot = document.querySelector('.pie-dot-content');

      let editorRichtextTools = null;

      // ============ AUTO-SAVE ============
      let editorStateManager = null;

      function getEditorStateManager() {
        if (editorStateManager) {
          return editorStateManager;
        }

        editorStateManager = createEditorStateManager({
          titleInput,
          slugInput,
          pageTypeSelect,
          blockEditor,
          titleOverrideEnabled,
          titleOverrideInput,
          navEnabled,
          navLinks,
          footerEnabled,
          footerText,
          metaEnabled,
          metaDescription,
          metaAuthor,
          cssEnabled,
          cssRules,
          getContentFromBlocks,
          getNavigationItems,
          loadFromSource,
          updatePageTitleSlug,
          createBlockElement,
          createNavChip
        });

        return editorStateManager;
      }

      function saveToLocalStorage() {
        return getEditorStateManager().saveToLocalStorage();
      }

      function loadFromLocalStorage() {
        return getEditorStateManager().loadFromLocalStorage();
      }

      function clearAutoSave() {
        return getEditorStateManager().clearAutoSave();
      }

      // ============ EDIT MODE (Source Editing) ============

      let isEditMode = false;
      let editingSlug = null;
      let editorBootstrap = null;

      function updatePageTitleSlug() {
        if (isEditMode) return; // Don't update in edit mode
        const pageTitle = document.getElementById('page-title');
        const slug = slugInput.value.trim();
        if (slug) {
          pageTitle.innerHTML = `New <span style="font-weight: 400; color: var(--text-secondary);">/ ${slug}</span>`;
        } else {
          pageTitle.textContent = 'New';
        }
      }

      let blockElFromSource = null;
      let editorSourceLoader = null;

      function getEditorSourceLoader() {
        if (editorSourceLoader) {
          return editorSourceLoader;
        }

        editorSourceLoader = createEditorSourceLoader({
          Compiler,
          titleInput,
          slugInput,
          pageTypeSelect,
          blockEditor,
          titleOverrideEnabled,
          titleOverrideInput,
          navEnabled,
          navLinks,
          footerEnabled,
          footerText,
          metaEnabled,
          metaDescription,
          metaAuthor,
          cssEnabled,
          cssRules,
          createBlockElement,
          setupListKeyHandlers,
          createNavChip,
          loadGlobalNavigation,
          loadGlobalFooter,
          loadGlobalMeta,
          loadGlobalCSS,
          inlineNodesToHtml,
          onPreviewRequested: () => debouncedPreview()
        });

        return editorSourceLoader;
      }

      function loadFromSource(sourceData) {
        getEditorSourceLoader().loadFromSource(sourceData);
        blockElFromSource = getEditorSourceLoader().getBlockElFromSource();
      }

      // ============ PAGE TYPE ============

      pageTypeSelect.addEventListener('change', () => {
        const type = pageTypeSelect.value;
        if (type === 'page') {
          pageTypeHint.textContent = '(not in feed)';
        } else {
          pageTypeHint.textContent = '';
        }
      });

      // ============ NAVIGATION EDITOR ============
      const insertBytesBtn = document.getElementById('insert-bytes-btn');
      let editorOverridesManager = null;

      function getEditorOverridesManager() {
        if (editorOverridesManager) {
          return editorOverridesManager;
        }

        editorOverridesManager = createEditorOverridesManager({
          navEnabled,
          navGlobalHint,
          navLinks,
          addNavLinkBtn,
          navLinkPopup,
          navLinkText,
          navLinkHref,
          navLinkSave,
          navLinkDelete,
          navLinkCancel,
          footerEnabled,
          footerGlobalHint,
          footerText,
          insertBytesBtn,
          metaEnabled,
          metaGlobalHint,
          metaDescription,
          metaAuthor,
          titleOverrideEnabled,
          titleOverrideHint,
          titleOverrideInput,
          cssEnabled,
          cssGlobalHint,
          cssRules,
          liveCSS,
          t,
          updateTitleBytes,
          onPreviewRequested: () => debouncedPreview(),
          getGlobalConfig: () => window.globalConfig
        });

        return editorOverridesManager;
      }

      function loadGlobalNavigation() {
        return getEditorOverridesManager().loadGlobalNavigation();
      }

      function createNavChip(text, href) {
        return getEditorOverridesManager().createNavChip(text, href);
      }

      function loadGlobalFooter() {
        return getEditorOverridesManager().loadGlobalFooter();
      }

      function loadGlobalMeta() {
        return getEditorOverridesManager().loadGlobalMeta();
      }

      function updateTitleOverrideHint() {
        return getEditorOverridesManager().updateTitleOverrideHint();
      }

      function loadGlobalCSS() {
        return getEditorOverridesManager().loadGlobalCSS();
      }

      function applyLiveCSS() {
        return getEditorOverridesManager().applyLiveCSS();
      }

      // ============ AUTO-SLUG ============

      titleInput.addEventListener('input', () => {
        if (!slugInput.dataset.manual) {
          slugInput.value = App.slugify(titleInput.value);
          updatePageTitleSlug();
        }
        updateTitleBytes();
      });

      slugInput.addEventListener('input', () => {
        slugInput.dataset.manual = 'true';
        updatePageTitleSlug();
      });

      // ============ BLOCK EDITOR ============
      let editorBlockFactory = null;

      function getEditorBlockFactory() {
        if (editorBlockFactory) {
          return editorBlockFactory;
        }

        editorBlockFactory = createEditorBlockFactory({
          Compiler,
          createInnerAddBlock,
          createSectionBlock,
          createLayoutBlock,
          createTextBlockTypeSelector,
          createHeadingLevelSelector,
          createListTypeSelector,
          createBlockTypeLabel,
          createFormatButtons,
          createBlockSelectorControl,
          createByteIndicator,
          createBloglistContent,
          createListContent,
          createDividerContent,
          createSpacerContent,
          createCodeblockContent,
          createBlockquoteContent,
          createParagraphContent,
          createHeadingContent,
          serializeBlock,
          updateBlockStyling,
          moveBlock,
          insertBlockDirectlyBelow,
          getBlockElFromSource: () => blockElFromSource,
          onCostRailChanged: () => updateCostRail(),
          onPreviewRequested: () => debouncedPreview(),
          onFormatClick: (cmd, block) => handleFormatClick(cmd, block)
        });

        return editorBlockFactory;
      }

      function setupListKeyHandlers(listEl) {
        return getEditorBlockFactory().setupListKeyHandlers(listEl);
      }

      function createBlockElement(type, level, initialHtml = '', listType = null, spacerHeight = null, isNested = false) {
        return getEditorBlockFactory().createBlockElement(type, level, initialHtml, listType, spacerHeight, isNested);
      }

      function getEditorRichtextTools() {
        if (editorRichtextTools) {
          return editorRichtextTools;
        }

        editorRichtextTools = createEditorRichtextTools({
          linkPopup,
          linkHrefInput,
          linkApplyBtn,
          linkCancelBtn,
          toggleSelectionWrap,
          modalInfo: (message) => Modal.info(message),
          onPreviewRequested: () => debouncedPreview()
        });

        return editorRichtextTools;
      }

      function moveBlock(block, direction) {
        moveBlockUtil(block, direction, {
          onChange: () => {
            updateCostRail();
            debouncedPreview();
          }
        });
      }

      function insertBlockDirectlyBelow(referenceBlock, newBlock) {
        insertBlockBelow(referenceBlock, newBlock);
      }

      // ============ FORMAT BUTTONS ============

      function handleFormatClick(cmd, block) {
        return getEditorRichtextTools().handleFormatClick(cmd, block);
      }

      function wrapSelectionWithTag(tagName) {
        return getEditorRichtextTools().wrapSelectionWithTag(tagName);
      }

      // ============ LINK POPUP ============

      function showLinkPopup() {
        return getEditorRichtextTools().showLinkPopup();
      }

      // ============ ADD BLOCK ============

      addBlockBtn.addEventListener('click', () => {
        addBlockDropdown.classList.toggle('hidden');
      });

      addBlockDropdown.addEventListener('click', (e) => {
        const btn = e.target.closest('button');
        if (!btn) return;

        const type = btn.dataset.type;
        const level = btn.dataset.level;
        const listType = btn.dataset.listType;
        const spacerHeight = btn.dataset.spacerHeight;
        const block = createBlockElement(type, level, '', listType, spacerHeight);
        blockEditor.appendChild(block);
        const focusTarget = block.querySelector('li[contenteditable="true"]') || block.querySelector('.block-content');
        if (focusTarget) focusTarget.focus();
        addBlockDropdown.classList.add('hidden');
      });

      document.addEventListener('click', (e) => {
        if (!e.target.closest('.block-actions-row')) {
          addBlockDropdown.classList.add('hidden');
        }
        if (!e.target.closest('.nav-link-popup') && !e.target.closest('#add-nav-link') && !e.target.closest('.nav-chip')) {
          navLinkPopup.classList.add('hidden');
        }
      });

      // ============ BUILD INPUT ============
      let editorBuildInputManager = null;

      function getEditorBuildInputManager() {
        if (editorBuildInputManager) {
          return editorBuildInputManager;
        }

        editorBuildInputManager = createEditorBuildInputManager({
          blockEditor,
          navLinks,
          slugInput,
          titleInput,
          pageTypeSelect,
          titleOverrideEnabled,
          titleOverrideInput,
          navEnabled,
          footerEnabled,
          footerText,
          metaEnabled,
          metaDescription,
          metaAuthor,
          cssEnabled,
          cssRules,
          serializeBlock,
          getPosts: () => App.getPosts(),
          getGlobalConfig: () => window.globalConfig
        });

        return editorBuildInputManager;
      }

      function getContentFromBlocks() {
        return getEditorBuildInputManager().getContentFromBlocks();
      }

      function getNavigationItems() {
        return getEditorBuildInputManager().getNavigationItems();
      }

      async function buildInput(allowPagination = false) {
        return getEditorBuildInputManager().buildInput(allowPagination);
      }

      // ============ BYTE COUNTER & COST RAIL ============
      let editorMetricsManager = null;

      function getEditorMetricsManager() {
        if (editorMetricsManager) {
          return editorMetricsManager;
        }

        editorMetricsManager = createEditorMetricsManager({
          formatBytes,
          serializeBlock,
          estimateBlockSize,
          blockEditor,
          titleInput,
          titleOverrideEnabled,
          titleOverrideInput,
          titleBytesEl,
          browserTitleBytesEl,
          costContentTotal,
          navBytesEl,
          metaBytesEl,
          footerBytesEl,
          cssBytesEl,
          breakdownBase,
          breakdownTitle,
          breakdownFavicon,
          breakdownNav,
          breakdownMeta,
          breakdownFooter,
          breakdownCss,
          breakdownContent,
          breakdownTotal,
          pieChart,
          piePercent,
          pieContentDot,
          getGlobalConfig: () => window.globalConfig
        });

        return editorMetricsManager;
      }

      function updateByteCounter(totalBytes, overheadBytes = 0, contentBytes = null, breakdown = null) {
        return getEditorMetricsManager().updateByteCounter(totalBytes, overheadBytes, contentBytes, breakdown);
      }

      function updateCostRail() {
        return getEditorMetricsManager().updateCostRail();
      }

      function updateTitleBytes() {
        return getEditorMetricsManager().updateTitleBytes();
      }

      function getEditorBootstrap() {
        if (editorBootstrap) {
          return editorBootstrap;
        }

        editorBootstrap = createEditorBootstrap({
          t,
          publishBtn,
          navEditor,
          addNavLinkBtn,
          navLinks,
          footerEditor,
          footerText,
          insertBytesBtn,
          metaEditor,
          metaDescription,
          metaAuthor,
          titleOverrideInput,
          updateTitleOverrideHint,
          cssEditor,
          cssRules,
          templateSelector: document.getElementById('template-selector'),
          templateSelectorContainer: document.getElementById('template-selector-container'),
          loadGlobalNavigation,
          loadGlobalFooter,
          loadGlobalMeta,
          loadGlobalCSS,
          loadFromSource,
          loadFromLocalStorage,
          getSeeds: () => App.getSeeds(),
          clonePage: (seedName, source) => App.clonePage(seedName, source),
          getSourceData: (slug) => App.getSourceData(slug),
          modalError: (message) => Modal.error(message),
          setEditMode: (slug) => {
            isEditMode = true;
            editingSlug = slug;
          }
        });

        return editorBootstrap;
      }

      // ============ MODAL SYSTEM ============

      const Modal = createModalManager({
        backdrop: document.getElementById('modal-backdrop'),
        modal: document.getElementById('modal'),
        message: document.getElementById('modal-message'),
        actions: document.getElementById('modal-actions')
      });

      window.Modal = Modal;

      // ============ PUBLISH ============

      publishBtn.addEventListener('click', async () => {
        const validation = validatePublishData({
          title: titleInput.value,
          blockCount: blockEditor.querySelectorAll('.block-item').length
        }, t);

        if (!validation.valid) {
          Modal.error(t('editor.buildError', { error: validation.error }));
          return;
        }

        const confirmed = await Modal.confirm(t('editor.buildConfirm'));
        if (!confirmed) return;

        publishBtn.disabled = true;

        try {
          const paginationResult = await determinePaginationStrategy({
            buildInput,
            App,
            Modal,
            t
          });

          if (paginationResult.aborted) {
            Modal.error(paginationResult.error);
            publishBtn.disabled = false;
            return;
          }

          const input = await buildInput(paginationResult.shouldPaginate);
          await executePublish({ input, App, Modal, t });

          if (!isEditMode) {
            resetEditorForm(
              {
                titleInput,
                slugInput,
                blockEditor,
                titleOverrideEnabled,
                titleOverrideInput,
                navEnabled,
                footerEnabled,
                footerText,
                metaEnabled,
                metaDescription,
                metaAuthor,
                cssEnabled,
                cssRules,
                liveCSS,
                pageTypeSelect,
                pageTypeHint
              },
              {
                createBlockElement,
                loadGlobalNavigation,
                clearAutoSave,
                updateByteCounter,
                updateCostRail,
                updateTitleBytes
              }
            );
          }

          publishBtn.disabled = false;
          publishBtn.textContent = isEditMode ? t('editor.recompile') : t('editor.buildPublish');
        } catch (err) {
          Modal.error(err.message);
          console.error(err);
          publishBtn.disabled = false;
        }
      });

      // ============ INIT ============
      await getEditorBootstrap().init();

      // ============ CLEAR ALL BUTTON ============

      document.getElementById('clear-all-btn').addEventListener('click', async () => {
        const confirmed = await Modal.confirm(t('editor.resetConfirm'));
        if (!confirmed) return;

        titleInput.value = '';
        slugInput.value = '';
        blockEditor.innerHTML = '';

        const emptyBlock = createBlockElement('paragraph');
        blockEditor.appendChild(emptyBlock);

        titleOverrideEnabled.checked = false;
        titleOverrideEnabled.dispatchEvent(new Event('change'));
        titleOverrideInput.value = '';

        navEnabled.checked = false;
        navEnabled.dispatchEvent(new Event('change'));
        loadGlobalNavigation();

        footerEnabled.checked = false;
        footerEnabled.dispatchEvent(new Event('change'));
        loadGlobalFooter();

        metaEnabled.checked = false;
        metaEnabled.dispatchEvent(new Event('change'));
        loadGlobalMeta();

        cssEnabled.checked = false;
        cssEnabled.dispatchEvent(new Event('change'));
        loadGlobalCSS();

        pageTypeSelect.value = 'post';
        pageTypeHint.textContent = '';

        clearAutoSave();

        updateByteCounter(0, 0);
        updateCostRail();
        updateTitleBytes();
      });

      updateByteCounter(0, 0);
      updateCostRail();
      updateTitleBytes();

      debouncedPreview = debounce(async () => {
        saveToLocalStorage();
        try {
          const input = await buildInput();
          const result = await App.preview(input);
          updateByteCounter(result.bytes, result.overheadBytes || 0, result.contentBytes, result.breakdown);

          blockEditor.querySelectorAll('.block-item.block-too-large').forEach(el => {
            el.classList.remove('block-too-large');
          });

          if (result.blockTooLarge) {
            const blocks = blockEditor.querySelectorAll('.block-item');
            const blockIndex = result.blockTooLarge.blockIndex;
            if (blocks[blockIndex]) {
              blocks[blockIndex].classList.add('block-too-large');
            }
          }
        } catch (e) {
        }
      }, 500);

      blockEditor.addEventListener('input', () => {
        debouncedPreview();
        updateCostRail();
      });
      titleInput.addEventListener('input', debouncedPreview);
      titleOverrideInput.addEventListener('input', debouncedPreview);
      titleOverrideEnabled.addEventListener('change', debouncedPreview);
      footerText.addEventListener('input', debouncedPreview);
      cssRules.addEventListener('input', debouncedPreview);
      metaDescription.addEventListener('input', debouncedPreview);
      metaAuthor.addEventListener('input', debouncedPreview);
      navEnabled.addEventListener('change', debouncedPreview);
      footerEnabled.addEventListener('change', debouncedPreview);
      metaEnabled.addEventListener('change', debouncedPreview);
      cssEnabled.addEventListener('change', debouncedPreview);

      const observer = new MutationObserver(() => {
        updateCostRail();
      });
      observer.observe(blockEditor, { childList: true });

      debouncedPreview();

    })();
  </script>
</body>

</html>