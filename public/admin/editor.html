<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Editor - fourteenkilobytes</title>
  <link rel="stylesheet" href="/admin/style.css">
</head>
<body>
  <div class="header">
    <div class="header-top">
      <a href="index.html" class="logo">&lt;14kb</a>
      <nav class="header-nav">
        <a href="index.html" class="nav-icon" title="Ãœbersicht">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
        </a>
        <a href="editor.html" class="nav-icon active" title="Neu erstellen">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
        </a>
        <a href="settings.html" class="nav-icon" title="Einstellungen">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
        </a>
        <a href="/" target="_blank" class="nav-icon" title="Blog ansehen">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
        </a>
        <span class="nav-separator"></span>
        <a href="#" id="logout-btn" class="nav-icon logout-icon" title="Logout">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
        </a>
      </nav>
    </div>
    <h1 class="page-title">Editor</h1>
  </div>

  
  <!-- Card: Head -->
  <div class="editor-card">
    <div class="card-header">
      <h2 class="card-title">Head</h2>
    </div>
    <div class="card-body card-body-grid">
      <div class="base-data-row">
        <div class="form-group">
          <label for="title">Title</label>
          <input type="text" id="title" placeholder="My first post">
        </div>
        <div class="form-group">
          <label for="slug">Slug</label>
          <input type="text" id="slug" placeholder="my-first-post">
        </div>
        <div class="form-group">
          <label for="page-type">Build Type</label>
          <select id="page-type" class="page-type-select">
            <option value="post">Blog Post</option>
            <option value="page">Static Page</option>
          </select>
          <span id="page-type-hint" class="text-small text-muted"></span>
        </div>
      </div>
      <div class="rail-item">
        <span>Title</span>
        <span id="title-bytes">0 B</span>
      </div>

      <!-- Header-Override -->
      <div class="override-section">
        <div class="override-section-header">
          <label class="override-toggle">
            <input type="checkbox" id="nav-enabled">
            <span>Override Navigation</span>
          </label>
          <p id="nav-global-hint" class="override-hint">âœ“ Using global navigation</p>
        </div>
        <div id="nav-editor" class="override-editor hidden">
          <div class="nav-editor-row">
            <div id="nav-links" class="nav-links"></div>
            <button type="button" id="add-nav-link" class="btn-primary">+ Link</button>
          </div>
        </div>
      </div>
      <div class="rail-item" id="nav-rail-item">
        <span>Navigation</span>
        <span id="nav-bytes">0 B</span>
      </div>
    </div>
  </div>

  <!-- Card: Body -->
  <div class="editor-card">
    <div class="card-header">
      <h2 class="card-title">Body</h2>
    </div>
    <div class="card-body card-body-grid">
      <div class="block-editor-wrapper">
        <div id="block-editor" class="block-editor"></div>
        <div class="block-actions-row">
          <button type="button" id="add-block-btn" class="btn-primary">+ Add Block</button>
          <div id="add-block-dropdown" class="add-block-dropdown hidden">
            <button type="button" data-type="paragraph">Paragraph</button>
            <button type="button" data-type="heading" data-level="1">Heading 1</button>
            <button type="button" data-type="heading" data-level="2">Heading 2</button>
            <button type="button" data-type="heading" data-level="3">Heading 3</button>
            <button type="button" data-type="heading" data-level="4">Heading 4</button>
            <button type="button" data-type="heading" data-level="5">Heading 5</button>
            <button type="button" data-type="heading" data-level="6">Heading 6</button>
            <button type="button" data-type="bloglist">Bloglist</button>
          </div>
        </div>
      </div>
      <div class="rail-item rail-item-total" id="content-rail">
        <span>Content</span>
        <span id="cost-content-total">0 B</span>
      </div>
    </div>
  </div>

  <!-- Card: Footer -->
  <div class="editor-card">
    <div class="card-header">
      <h2 class="card-title">Footer</h2>
    </div>
    <div class="card-body card-body-grid">
      <!-- Footer-Override -->
      <div class="override-section override-section-first">
        <div class="override-section-header">
          <label class="override-toggle">
            <input type="checkbox" id="footer-enabled">
            <span>Override Footer</span>
          </label>
          <p id="footer-global-hint" class="override-hint">âœ“ Using global footer</p>
        </div>
        <div id="footer-editor" class="override-editor hidden">
          <div class="footer-editor-row">
            <input type="text" id="footer-text" placeholder="Â© 2024 My Blog">
            <button type="button" id="insert-bytes-btn" class="btn-primary">+ Bytes</button>
          </div>
        </div>
      </div>
      <div class="rail-item">
        <span>Footer</span>
        <span id="footer-bytes">0 B</span>
      </div>

      <!-- CSS Override -->
      <div class="override-section">
        <div class="override-section-header">
          <label class="override-toggle">
            <input type="checkbox" id="css-enabled">
            <span>Add CSS</span>
          </label>
          <p id="css-global-hint" class="override-hint"></p>
        </div>
        <div id="css-editor" class="override-editor">
          <p class="css-warning-hint">Additional CSS is inserted after global CSS and increases page size.</p>
          <textarea id="css-rules" rows="10" placeholder="/* Additional CSS */"></textarea>
        </div>
      </div>
      <div class="rail-item">
        <span>CSS</span>
        <span id="css-bytes">0 B</span>
      </div>
    </div>
  </div>

  <!-- Link Edit Popup for Navigation -->
  <div id="nav-link-popup" class="nav-link-popup hidden">
    <div class="popup-content">
      <div class="form-group">
        <label>Text</label>
        <input type="text" id="nav-link-text" placeholder="Home">
      </div>
      <div class="form-group">
        <label>Target</label>
        <input type="text" id="nav-link-href" placeholder="/">
      </div>
      <div class="popup-actions">
        <button type="button" id="nav-link-save" class="btn-primary">OK</button>
        <button type="button" id="nav-link-delete" class="btn-danger">Delete</button>
        <button type="button" id="nav-link-cancel" class="btn-secondary">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Floating Format Toolbar (hidden by default) -->
  <div id="format-toolbar" class="format-toolbar hidden">
    <button type="button" data-cmd="bold" title="Bold"><b>B</b></button>
    <button type="button" data-cmd="italic" title="Italic"><i>I</i></button>
    <button type="button" data-cmd="link" title="Link">ðŸ”—</button>
  </div>

  <!-- Link Popup for content -->
  <div id="link-popup" class="link-popup hidden">
    <input type="text" id="link-href" placeholder="/path or #anchor">
    <button type="button" id="link-apply" class="btn-primary">OK</button>
    <button type="button" id="link-cancel" class="btn-secondary">Ã—</button>
  </div>

  <!-- Modal System -->
  <div id="modal-backdrop" class="modal-backdrop hidden"></div>
  <div id="modal" class="modal hidden">
    <div class="modal-content">
      <p id="modal-message"></p>
      <div id="modal-actions" class="popup-actions"></div>
    </div>
  </div>

  <!-- Card: Build -->
  <div class="editor-card">
    <div class="card-header">
      <h2 class="card-title">Build</h2>
    </div>
    <div class="card-body card-body-with-rail">
      <div class="card-content">
        <div class="breakdown-table">
          <div class="breakdown-row">
            <span>Base</span>
            <span id="breakdown-base">0 B</span>
          </div>
          <div class="breakdown-row">
            <span>Navigation</span>
            <span id="breakdown-nav">0 B</span>
          </div>
          <div class="breakdown-row">
            <span>Footer</span>
            <span id="breakdown-footer">0 B</span>
          </div>
          <div class="breakdown-row">
            <span>CSS</span>
            <span id="breakdown-css">0 B</span>
          </div>
          <div class="breakdown-row">
            <span>Content</span>
            <span id="breakdown-content">0 B</span>
          </div>
          <div class="breakdown-row breakdown-row-total">
            <span>Total</span>
            <span id="breakdown-total">0 B / 14.336 B</span>
          </div>
        </div>
        <label id="pagination-option" class="pagination-checkbox hidden">
          <input type="checkbox" id="allow-pagination">
          <span>Automatically split into multiple pages</span>
        </label>
      </div>
      <div class="card-rail build-rail">
        <div class="build-progress">
          <div class="pie-chart" id="pie-chart">
              <span class="pie-percent" id="pie-percent">0%</span>
            </div>
          <div class="pie-legend">
            <div class="pie-legend-item">
              <span class="pie-dot pie-dot-overhead"></span>
              <span>Overhead</span>
            </div>
            <div class="pie-legend-item">
              <span class="pie-dot pie-dot-content"></span>
              <span>Content</span>
            </div>
            <div class="pie-legend-item">
              <span class="pie-dot pie-dot-free"></span>
              <span>Free</span>
            </div>
          </div>
        </div>
        <button id="publish-btn" class="btn-primary build-publish-btn">Build & Publish</button>
      </div>
    </div>
  </div>

  <!-- Live CSS Container -->
  <style id="live-css"></style>

  <script type="module" src="app.js"></script>
  <script type="module">
    (async function() {
      // Check if setup is complete
      const status = await App.getSetupStatus();
      if (!status.setupComplete) {
        window.location.href = '/admin/setup';
        return;
      }

      // Check auth
      const config = await App.getConfig();
      if (config.authEnabled && !(await App.isLoggedIn())) {
        window.location.href = 'index.html';
        return;
      }

      // Load settings with global header/footer/CSS
      const settings = await App.getSettings();
      window.globalConfig = settings;

      // Logout handler
      document.getElementById('logout-btn').addEventListener('click', async (e) => {
        e.preventDefault();
        await App.logout();
        window.location.href = '/admin/login.html';
      });

      // Elements
      const pageTypeSelect = document.getElementById('page-type');
      const pageTypeHint = document.getElementById('page-type-hint');
      const titleInput = document.getElementById('title');
      const slugInput = document.getElementById('slug');
      const blockEditor = document.getElementById('block-editor');
      const addBlockBtn = document.getElementById('add-block-btn');
      const addBlockDropdown = document.getElementById('add-block-dropdown');
      const formatToolbar = document.getElementById('format-toolbar');
      const linkPopup = document.getElementById('link-popup');
      const linkHrefInput = document.getElementById('link-href');
      const linkApplyBtn = document.getElementById('link-apply');
      const linkCancelBtn = document.getElementById('link-cancel');
      const navEnabled = document.getElementById('nav-enabled');
      const navEditor = document.getElementById('nav-editor');
      const navGlobalHint = document.getElementById('nav-global-hint');
      const navLinks = document.getElementById('nav-links');
      const addNavLinkBtn = document.getElementById('add-nav-link');
      const navLinkPopup = document.getElementById('nav-link-popup');
      const navLinkText = document.getElementById('nav-link-text');
      const navLinkHref = document.getElementById('nav-link-href');
      const navLinkSave = document.getElementById('nav-link-save');
      const navLinkDelete = document.getElementById('nav-link-delete');
      const navLinkCancel = document.getElementById('nav-link-cancel');
      const footerEnabled = document.getElementById('footer-enabled');
      const footerEditor = document.getElementById('footer-editor');
      const footerGlobalHint = document.getElementById('footer-global-hint');
      const footerText = document.getElementById('footer-text');
      const cssEnabled = document.getElementById('css-enabled');
      const cssEditor = document.getElementById('css-editor');
      const cssGlobalHint = document.getElementById('css-global-hint');
      const cssRules = document.getElementById('css-rules');
      const liveCSS = document.getElementById('live-css');
      const publishBtn = document.getElementById('publish-btn');
      const paginationOption = document.getElementById('pagination-option');
      const allowPaginationCheckbox = document.getElementById('allow-pagination');

      // Byte display elements
      const costContentTotal = document.getElementById('cost-content-total');
      const contentRail = document.getElementById('content-rail');
      const titleBytesEl = document.getElementById('title-bytes');
      const navBytesEl = document.getElementById('nav-bytes');
      const footerBytesEl = document.getElementById('footer-bytes');
      const cssBytesEl = document.getElementById('css-bytes');

      // Build Card elements
      const breakdownBase = document.getElementById('breakdown-base');
      const breakdownNav = document.getElementById('breakdown-nav');
      const breakdownFooter = document.getElementById('breakdown-footer');
      const breakdownCss = document.getElementById('breakdown-css');
      const breakdownContent = document.getElementById('breakdown-content');
      const breakdownTotal = document.getElementById('breakdown-total');
      const pieChart = document.getElementById('pie-chart');
      const piePercent = document.getElementById('pie-percent');
      const pieContentDot = document.querySelector('.pie-dot-content');

      // State
      let savedSelection = null;
      let editingNavLink = null; // The chip element being edited

      // ============ PAGE TYPE ============

      pageTypeSelect.addEventListener('change', () => {
        const type = pageTypeSelect.value;
        if (type === 'page') {
          pageTypeHint.textContent = '(not in feed)';
        } else {
          pageTypeHint.textContent = '';
        }
      });

      // ============ NAVIGATION EDITOR ============

      // Load global navigation into disabled fields
      function loadGlobalNavigation() {
        navLinks.innerHTML = '';
        if (window.globalConfig?.header?.links) {
          window.globalConfig.header.links.forEach(link => {
            navLinks.appendChild(createNavChip(link.text, link.href));
          });
        }
      }

      navEnabled.addEventListener('change', () => {
        navGlobalHint.classList.toggle('hidden', navEnabled.checked);
        
        // Toggle disabled state
        const chips = navLinks.querySelectorAll('.nav-chip');
        chips.forEach(chip => {
          chip.style.pointerEvents = navEnabled.checked ? 'auto' : 'none';
          chip.style.opacity = navEnabled.checked ? '1' : '0.6';
        });
        addNavLinkBtn.disabled = !navEnabled.checked;
      });

      function createNavChip(text, href) {
        const chip = document.createElement('span');
        chip.className = 'nav-chip';
        chip.dataset.href = href;
        chip.textContent = text;
        chip.draggable = true;
        chip.addEventListener('click', () => editNavLink(chip));

        // Drag & Drop
        chip.addEventListener('dragstart', (e) => {
          chip.classList.add('dragging');
          e.dataTransfer.effectAllowed = 'move';
        });

        chip.addEventListener('dragend', () => {
          chip.classList.remove('dragging');
          navLinks.querySelectorAll('.nav-chip').forEach(c => c.classList.remove('drag-over'));
        });

        chip.addEventListener('dragover', (e) => {
          e.preventDefault();
          const dragging = navLinks.querySelector('.dragging');
          if (dragging && dragging !== chip) {
            chip.classList.add('drag-over');
          }
        });

        chip.addEventListener('dragleave', () => {
          chip.classList.remove('drag-over');
        });

        chip.addEventListener('drop', (e) => {
          e.preventDefault();
          const dragging = navLinks.querySelector('.dragging');
          if (dragging && dragging !== chip) {
            const allChips = [...navLinks.querySelectorAll('.nav-chip')];
            const dragIndex = allChips.indexOf(dragging);
            const dropIndex = allChips.indexOf(chip);
            if (dragIndex < dropIndex) {
              chip.after(dragging);
            } else {
              chip.before(dragging);
            }
          }
          chip.classList.remove('drag-over');
        });

        return chip;
      }

      function editNavLink(chip) {
        editingNavLink = chip;
        navLinkText.value = chip.textContent;
        navLinkHref.value = chip.dataset.href;
        navLinkDelete.classList.remove('hidden');
        navLinkPopup.classList.remove('hidden');
        navLinkText.focus();
      }

      addNavLinkBtn.addEventListener('click', () => {
        editingNavLink = null;
        navLinkText.value = '';
        navLinkHref.value = '';
        navLinkDelete.classList.add('hidden');
        navLinkPopup.classList.remove('hidden');
        navLinkText.focus();
      });

      navLinkSave.addEventListener('click', () => {
        const text = navLinkText.value.trim();
        const href = navLinkHref.value.trim();
        if (!text || !href) return;

        if (editingNavLink) {
          editingNavLink.textContent = text;
          editingNavLink.dataset.href = href;
        } else {
          navLinks.appendChild(createNavChip(text, href));
        }
        navLinkPopup.classList.add('hidden');
        editingNavLink = null;
      });

      navLinkDelete.addEventListener('click', () => {
        if (editingNavLink) {
          editingNavLink.remove();
        }
        navLinkPopup.classList.add('hidden');
        editingNavLink = null;
      });

      navLinkCancel.addEventListener('click', () => {
        navLinkPopup.classList.add('hidden');
        editingNavLink = null;
      });

      // ============ FOOTER EDITOR ============

      const insertBytesBtn = document.getElementById('insert-bytes-btn');

      // Load global footer into disabled field
      function loadGlobalFooter() {
        if (window.globalConfig?.footer?.content) {
          footerText.value = window.globalConfig.footer.content;
        }
      }

      footerEnabled.addEventListener('change', () => {
        footerGlobalHint.classList.toggle('hidden', footerEnabled.checked);
        footerText.disabled = !footerEnabled.checked;
        insertBytesBtn.disabled = !footerEnabled.checked;
      });

      insertBytesBtn.addEventListener('click', () => {
        const cursorPos = footerText.selectionStart;
        const textBefore = footerText.value.substring(0, cursorPos);
        const textAfter = footerText.value.substring(cursorPos);
        footerText.value = textBefore + '{{bytes}}' + textAfter;
        footerText.focus();
        footerText.setSelectionRange(cursorPos + 9, cursorPos + 9);
        debouncedPreview();
      });

      // ============ CSS EDITOR ============

      function getThemeDisplayName(cssMode) {
        const names = {
          'default': 'CMS Default Theme',
          'light': 'CMS Light Theme',
          'dark': 'CMS Dark Theme',
          'custom': 'Custom CSS'
        };
        return names[cssMode] || cssMode || 'CMS Default Theme';
      }

      // Don't load global CSS - this field is for ADDITIONAL CSS only
      function loadGlobalCSS() {
        // Leave empty - this textarea is for additional CSS only
        // Global CSS is already included in the base template

        // Update hint with theme name
        const themeName = getThemeDisplayName(window.globalConfig?.cssMode);
        cssGlobalHint.textContent = `âœ“ ${themeName} is used globally`;
      }

      cssEnabled.addEventListener('change', () => {
        cssGlobalHint.classList.toggle('hidden', cssEnabled.checked);
        cssRules.disabled = !cssEnabled.checked;
      });

      // ============ LIVE CSS ============

      cssRules.addEventListener('input', () => {
        applyLiveCSS();
      });

      function applyLiveCSS() {
        const css = cssRules.value.trim();
        // Scope CSS to block-editor to avoid breaking admin UI
        // Simple approach: prefix all rules with .block-editor
        if (!css) {
          liveCSS.textContent = '';
          return;
        }

        // Basic scoping - wrap in .block-editor context
        // This won't handle all edge cases but works for simple rules
        try {
          const scopedCSS = css.replace(/([^{}]+)\{/g, (match, selector) => {
            const selectors = selector.split(',').map(s => {
              s = s.trim();
              if (s.startsWith('@') || s.startsWith('from') || s.startsWith('to') || /^\d+%$/.test(s)) {
                return s;
              }
              if (s === 'body' || s === 'html') {
                return '.block-editor';
              }
              return `.block-editor ${s}`;
            }).join(', ');
            return selectors + ' {';
          });
          liveCSS.textContent = scopedCSS;
        } catch (e) {
          // Invalid CSS, ignore
        }
      }

      // ============ AUTO-SLUG ============

      titleInput.addEventListener('input', () => {
        if (!slugInput.dataset.manual) {
          slugInput.value = App.slugify(titleInput.value);
        }
        updateTitleBytes();
      });

      slugInput.addEventListener('input', () => {
        slugInput.dataset.manual = 'true';
      });

      // ============ BLOCK EDITOR ============

      function createBlockElement(type, level, initialHtml = '') {
        const block = document.createElement('div');
        block.className = 'block-item';
        block.dataset.type = type;
        if (level) block.dataset.level = level;

        // Block header with type selector and actions
        const header = document.createElement('div');
        header.className = 'block-header';

        // Type selector (nur wenn nicht bloglist)
        if (type !== 'bloglist') {
          const typeSelect = document.createElement('select');
          typeSelect.className = 'block-type-select';
          typeSelect.innerHTML = `
            <option value="paragraph">Paragraph</option>
            <option value="heading-1">H1</option>
            <option value="heading-2">H2</option>
            <option value="heading-3">H3</option>
            <option value="heading-4">H4</option>
            <option value="heading-5">H5</option>
            <option value="heading-6">H6</option>
          `;
          typeSelect.value = type === 'heading' ? `heading-${level}` : 'paragraph';
          typeSelect.addEventListener('change', () => {
            const val = typeSelect.value;
            if (val === 'paragraph') {
              block.dataset.type = 'paragraph';
              delete block.dataset.level;
            } else {
              block.dataset.type = 'heading';
              block.dataset.level = val.split('-')[1];
            }
            updateBlockStyling(block);
          });
          header.appendChild(typeSelect);
        } else {
          const label = document.createElement('span');
          label.className = 'block-type-label';
          label.textContent = 'Bloglist';
          header.appendChild(label);
        }

        const actions = document.createElement('div');
        actions.className = 'block-item-actions';

        const upBtn = document.createElement('button');
        upBtn.type = 'button';
        upBtn.textContent = 'â†‘';
        upBtn.title = 'Move up';
        upBtn.addEventListener('click', () => moveBlock(block, -1));
        actions.appendChild(upBtn);

        const downBtn = document.createElement('button');
        downBtn.type = 'button';
        downBtn.textContent = 'â†“';
        downBtn.title = 'Move down';
        downBtn.addEventListener('click', () => moveBlock(block, 1));
        actions.appendChild(downBtn);

        const deleteBtn = document.createElement('button');
        deleteBtn.type = 'button';
        deleteBtn.textContent = 'Ã—';
        deleteBtn.title = 'Delete';
        deleteBtn.addEventListener('click', () => block.remove());
        actions.appendChild(deleteBtn);

        header.appendChild(actions);
        
        // Byte indicator fÃ¼r diesen Block
        const byteIndicator = document.createElement('div');
        byteIndicator.className = 'block-byte-indicator';
        byteIndicator.textContent = '0 B';
        block.appendChild(byteIndicator);
        
        block.appendChild(header);

        // Content area
        const content = document.createElement('div');
        content.className = 'block-content';
        if (type === 'bloglist') {
          content.contentEditable = 'false';
          content.className = 'block-content block-bloglist';
          content.innerHTML = '<em style="color: #999;">All blog posts will be listed here automatically</em>';
        } else {
          content.contentEditable = 'true';
          content.dataset.placeholder = type === 'heading' ? 'Heading...' : 'Enter text...';
          content.innerHTML = initialHtml;
        }
        block.appendChild(content);

        updateBlockStyling(block);
        return block;
      }

      function updateBlockStyling(block) {
        const content = block.querySelector('.block-content');
        const type = block.dataset.type;
        const level = block.dataset.level;

        // Reset styles
        content.style.fontSize = '';
        content.style.fontWeight = '';

        if (type === 'heading') {
          content.style.fontWeight = 'bold';
          const sizes = { 1: '2rem', 2: '1.5rem', 3: '1.25rem', 4: '1.1rem', 5: '1rem', 6: '0.875rem' };
          content.style.fontSize = sizes[level] || '1rem';
          content.dataset.placeholder = 'Heading...';
        } else {
          content.dataset.placeholder = 'Enter text...';
        }
      }

      function moveBlock(block, direction) {
        const blocks = Array.from(blockEditor.children);
        const index = blocks.indexOf(block);
        const newIndex = index + direction;
        if (newIndex < 0 || newIndex >= blocks.length) return;

        if (direction < 0) {
          blockEditor.insertBefore(block, blocks[newIndex]);
        } else {
          blockEditor.insertBefore(block, blocks[newIndex].nextSibling);
        }
      }

      // ============ FLOATING FORMAT TOOLBAR ============

      document.addEventListener('selectionchange', () => {
        const sel = window.getSelection();
        if (!sel.rangeCount || sel.isCollapsed) {
          formatToolbar.classList.add('hidden');
          return;
        }

        // Check if selection is within block editor
        const range = sel.getRangeAt(0);
        const container = range.commonAncestorContainer;
        const blockContent = container.nodeType === Node.TEXT_NODE
          ? container.parentElement.closest('.block-content')
          : container.closest('.block-content');

        if (!blockContent || !blockEditor.contains(blockContent)) {
          formatToolbar.classList.add('hidden');
          return;
        }

        // Position toolbar above selection
        const rect = range.getBoundingClientRect();
        formatToolbar.style.top = (rect.top + window.scrollY - 40) + 'px';
        formatToolbar.style.left = (rect.left + window.scrollX + rect.width / 2 - 50) + 'px';
        formatToolbar.classList.remove('hidden');
      });

      formatToolbar.addEventListener('click', (e) => {
        const btn = e.target.closest('button');
        if (!btn) return;

        const cmd = btn.dataset.cmd;
        if (cmd === 'bold') {
          document.execCommand('bold', false, null);
        } else if (cmd === 'italic') {
          document.execCommand('italic', false, null);
        } else if (cmd === 'link') {
          showLinkPopup();
        }
      });

      // ============ LINK POPUP ============

      function showLinkPopup() {
        const sel = window.getSelection();
        if (!sel.rangeCount || sel.isCollapsed) return;

        savedSelection = sel.getRangeAt(0).cloneRange();

        const parentLink = sel.anchorNode.parentElement.closest('a');
        linkHrefInput.value = parentLink ? parentLink.getAttribute('href') : '';

        const rect = savedSelection.getBoundingClientRect();
        linkPopup.style.top = (rect.bottom + window.scrollY + 5) + 'px';
        linkPopup.style.left = (rect.left + window.scrollX) + 'px';
        linkPopup.classList.remove('hidden');
        linkHrefInput.focus();
      }

      linkApplyBtn.addEventListener('click', () => {
        const href = linkHrefInput.value.trim();
        if (!href) {
          linkPopup.classList.add('hidden');
          return;
        }

        if (savedSelection) {
          const sel = window.getSelection();
          sel.removeAllRanges();
          sel.addRange(savedSelection);
          document.execCommand('createLink', false, href);
        }
        linkPopup.classList.add('hidden');
        savedSelection = null;
      });

      linkCancelBtn.addEventListener('click', () => {
        linkPopup.classList.add('hidden');
        savedSelection = null;
      });

      // ============ ADD BLOCK ============

      addBlockBtn.addEventListener('click', () => {
        addBlockDropdown.classList.toggle('hidden');
      });

      addBlockDropdown.addEventListener('click', (e) => {
        const btn = e.target.closest('button');
        if (!btn) return;

        const type = btn.dataset.type;
        const level = btn.dataset.level;
        const block = createBlockElement(type, level);
        blockEditor.appendChild(block);
        block.querySelector('.block-content').focus();
        addBlockDropdown.classList.add('hidden');
      });

      document.addEventListener('click', (e) => {
        if (!e.target.closest('.block-actions-row')) {
          addBlockDropdown.classList.add('hidden');
        }
        if (!e.target.closest('.nav-link-popup') && !e.target.closest('#add-nav-link') && !e.target.closest('.nav-chip')) {
          navLinkPopup.classList.add('hidden');
        }
      });

      // ============ BUILD INPUT ============

      function parseInlineNodes(element) {
        const nodes = [];

        function processNodeInto(node, targetArray) {
          if (node.nodeType === Node.TEXT_NODE) {
            const text = node.textContent;
            if (text) {
              targetArray.push({ type: 'text', text });
            }
          } else if (node.nodeType === Node.ELEMENT_NODE) {
            const tag = node.tagName.toLowerCase();
            const children = [];
            for (const child of node.childNodes) {
              processNodeInto(child, children);
            }

            if (tag === 'br') {
              targetArray.push({ type: 'linebreak' });
            } else if (tag === 'b' || tag === 'strong') {
              targetArray.push({ type: 'bold', children });
            } else if (tag === 'i' || tag === 'em') {
              targetArray.push({ type: 'italic', children });
            } else if (tag === 'a') {
              const href = node.getAttribute('href') || '';
              targetArray.push({ type: 'link', href, children });
            } else {
              targetArray.push(...children);
            }
          }
        }

        for (const child of element.childNodes) {
          processNodeInto(child, nodes);
        }

        if (nodes.length === 0) {
          nodes.push({ type: 'text', text: '' });
        }

        return nodes;
      }

      function getContentFromBlocks() {
        const blocks = blockEditor.querySelectorAll('.block-item');
        const content = [];

        for (const block of blocks) {
          const type = block.dataset.type;

          if (type === 'bloglist') {
            content.push({
              type: 'bloglist'
            });
          } else {
            const contentEl = block.querySelector('.block-content');
            const children = parseInlineNodes(contentEl);

            if (type === 'heading') {
              content.push({
                type: 'heading',
                level: parseInt(block.dataset.level, 10),
                children
              });
            } else {
              content.push({
                type: 'paragraph',
                children
              });
            }
          }
        }

        return content;
      }

      function getNavigationItems() {
        const chips = navLinks.querySelectorAll('.nav-chip');
        return Array.from(chips).map(chip => ({
          text: chip.textContent,
          href: chip.dataset.href
        }));
      }

      
      async function buildInput() {
        const content = getContentFromBlocks();
        
        // For preview with empty content, use minimal placeholder
        const finalContent = content.length > 0
          ? content
          : [{ type: 'paragraph', children: [{ type: 'text', text: '' }] }];

        // Load posts if bloglist block is present
        let posts = [];
        const hasBloglist = finalContent.some(block => block.type === 'bloglist');
        if (hasBloglist) {
          try {
            posts = await App.getPosts();
            console.log('Loaded posts for bloglist:', posts);
          } catch (err) {
            console.warn('Failed to load posts for bloglist:', err);
          }
        }

        let navigation = null;
        if (navEnabled.checked) {
          const items = getNavigationItems();
          if (items.length > 0) {
            navigation = { items };
          }
        }

        let footer = null;
        if (footerEnabled.checked && footerText.value.trim()) {
          footer = { content: footerText.value.trim() };
        }

        let css = null;
        if (cssEnabled.checked && cssRules.value.trim()) {
          css = { rules: cssRules.value.trim() };
        }

        return {
          slug: slugInput.value.trim() || 'untitled',
          title: titleInput.value.trim() || 'Untitled',
          content: finalContent,
          navigation,
          footer,
          css,
          icons: [],
          posts,
          allowPagination: allowPaginationCheckbox.checked,
          buildId: crypto.randomUUID(),
          pageType: pageTypeSelect.value,
        };
      }

      // ============ BYTE COUNTER & COST RAIL ============

      function formatBytes(bytes) {
        if (bytes === 0) return '0 B';
        if (bytes < 1000) return bytes + ' B';
        return (bytes / 1024).toFixed(1) + ' KB';
      }

      function updateByteCounter(totalBytes, overheadBytes = 0, contentBytes = null, breakdown = null) {
        const limit = 14336;
        const actualContentBytes = contentBytes !== null ? contentBytes : Math.max(0, totalBytes - overheadBytes);
        const overheadPercent = Math.min((overheadBytes / limit) * 100, 100);
        const totalPercent = Math.min((totalBytes / limit) * 100, 100);

        // Update Build Summary breakdown
        if (breakdown) {
          breakdownBase.textContent = formatBytes(breakdown.base);
          breakdownNav.textContent = formatBytes(breakdown.navigation);
          breakdownFooter.textContent = formatBytes(breakdown.footer);
          breakdownCss.textContent = formatBytes(breakdown.css);
          breakdownContent.textContent = formatBytes(breakdown.content);
          breakdownTotal.textContent = `${formatBytes(totalBytes)} / 14.336 B`;

          // Update rail indicators
          navBytesEl.textContent = formatBytes(breakdown.navigation);
          footerBytesEl.textContent = formatBytes(breakdown.footer);
          cssBytesEl.textContent = formatBytes(breakdown.css);
        }

        // Update Cost Rail content total
        costContentTotal.textContent = formatBytes(actualContentBytes);

        // Calculate angles for pie chart (360 degrees = 100%)
        const overheadDeg = (overheadPercent / 100) * 360;
        const totalDeg = (totalPercent / 100) * 360;

        // Determine content color based on usage
        let contentColor = 'var(--accent)';
        pieContentDot.classList.remove('warning', 'danger');
        if (totalPercent >= 100) {
          contentColor = '#dc2626';
          pieContentDot.classList.add('danger');
          paginationOption.classList.remove('hidden');
        } else if (totalPercent >= 80) {
          contentColor = '#f59e0b';
          pieContentDot.classList.add('warning');
          paginationOption.classList.add('hidden');
        } else {
          paginationOption.classList.add('hidden');
        }

        // Update pie chart with conic-gradient
        pieChart.style.background = `conic-gradient(
          var(--gray-400) 0deg ${overheadDeg}deg,
          ${contentColor} ${overheadDeg}deg ${totalDeg}deg,
          var(--gray-200) ${totalDeg}deg 360deg
        )`;

        // Update percentage in center
        piePercent.textContent = `${Math.round(totalPercent)}%`;
      }

      function updateCostRail() {
        const blocks = blockEditor.querySelectorAll('.block-item');
        let totalContentBytes = 0;

        blocks.forEach((block, index) => {
          const content = block.querySelector('.block-content');
          const byteIndicator = block.querySelector('.block-byte-indicator');
          const type = block.dataset.type;
          const level = block.dataset.level;
          const text = content ? content.textContent.trim() : '';

          // Rough byte estimation (real calculation happens server-side)
          const bytes = new TextEncoder().encode(text).length + 50; // +50 for markup
          totalContentBytes += bytes;

          // Determine semantic label
          let label = 'Paragraph';
          if (type === 'heading') {
            label = `H${level}`;
          } else if (type === 'bloglist') {
            label = 'List';
          }

          // Update inline byte indicator
          if (byteIndicator) {
            byteIndicator.innerHTML = `<span>${label}</span><span>${formatBytes(bytes)}</span>`;
          }
        });

        // Update content total
        costContentTotal.textContent = formatBytes(totalContentBytes);
      }

      function updateTitleBytes() {
        const title = titleInput.value.trim() || 'Untitled';
        // <title>TITEL</title> = 15 bytes markup + title bytes
        const titleBytes = new TextEncoder().encode(title).length + 15;
        titleBytesEl.textContent = formatBytes(titleBytes);
      }

      // ============ MODAL SYSTEM ============

      const Modal = (() => {
        const backdrop = document.getElementById('modal-backdrop');
        const modal = document.getElementById('modal');
        const message = document.getElementById('modal-message');
        const actions = document.getElementById('modal-actions');

        function hide() {
          modal.classList.add('hidden');
          backdrop.classList.add('hidden');
          modal.className = 'modal hidden';
          actions.innerHTML = '';
        }

        function show(text, buttons, type = '') {
          message.textContent = text;
          actions.innerHTML = '';
          modal.className = 'modal' + (type ? ` modal-${type}` : '');

          buttons.forEach(btn => {
            const button = document.createElement('button');
            button.type = 'button';
            button.textContent = btn.text;
            button.className = btn.class || '';
            button.addEventListener('click', () => {
              hide();
              if (btn.action) btn.action();
            });
            actions.appendChild(button);
          });

          backdrop.classList.remove('hidden');
          modal.classList.remove('hidden');
        }

        return {
          confirm(text) {
            return new Promise(resolve => {
              show(text, [
                { text: 'Yes', class: 'btn-primary', action: () => resolve(true) },
                { text: 'Cancel', class: 'btn-secondary', action: () => resolve(false) }
              ]);
            });
          },

          success(text) {
            show(text, [{ text: 'OK', class: 'btn-primary' }], 'success');
          },

          error(text) {
            show(text, [{ text: 'OK', class: 'btn-primary' }], 'error');
          },

          hide
        };
      })();

      // ============ PUBLISH ============

      publishBtn.addEventListener('click', async () => {
        // Validate content before publish
        const blocks = blockEditor.querySelectorAll('.block-item');
        if (blocks.length === 0) {
          Modal.error('At least one block required');
          return;
        }

        const confirmed = await Modal.confirm('Execute build and publish?');
        if (!confirmed) return;

        publishBtn.disabled = true;

        try {
          const input = await buildInput();
          const result = await App.publish(input);

          if (result.pageCount && result.pageCount > 1) {
            Modal.success(`Build completed: /${result.slug} (${result.pageCount} pages, ${result.totalBytes} bytes)`);
            updateByteCounter(result.totalBytes);
          } else {
            Modal.success(`Build completed: /${result.slug} (${result.bytes} bytes)`);
            updateByteCounter(result.bytes);
          }

          // Disable editing after publish
          titleInput.disabled = true;
          slugInput.disabled = true;
          blockEditor.querySelectorAll('.block-content').forEach(el => {
            el.contentEditable = 'false';
          });
          blockEditor.querySelectorAll('button, select').forEach(el => {
            el.disabled = true;
          });
          addBlockBtn.disabled = true;
          navEnabled.disabled = true;
          footerEnabled.disabled = true;
          cssRules.disabled = true;
          publishBtn.disabled = true;
          publishBtn.textContent = 'Build completed';
        } catch (err) {
          Modal.error(err.message);
          console.error(err);
          publishBtn.disabled = false;
        }
      });

      // ============ INIT ============

      // Load global values into fields
      loadGlobalNavigation();
      loadGlobalFooter();
      loadGlobalCSS();
      
      // Set initial disabled states (after loading global values)
      navEditor.classList.remove('hidden');
      addNavLinkBtn.disabled = true;
      
      // Apply disabled state to navigation chips
      const initialChips = navLinks.querySelectorAll('.nav-chip');
      initialChips.forEach(chip => {
        chip.style.pointerEvents = 'none';
        chip.style.opacity = '0.6';
      });
      
      footerEditor.classList.remove('hidden');
      footerText.disabled = true;
      insertBytesBtn.disabled = true;
      
      cssEditor.classList.remove('hidden');
      cssRules.disabled = true;

      function debounce(fn, delay) {
        let timeout;
        return (...args) => {
          clearTimeout(timeout);
          timeout = setTimeout(() => fn(...args), delay);
        };
      }

      updateByteCounter(0, 0);
      updateCostRail();
      updateTitleBytes();

      // Auto-update byte counter on content changes
      const debouncedPreview = debounce(async () => {
        try {
          const input = await buildInput();
          const result = await App.preview(input);
          updateByteCounter(result.bytes, result.overheadBytes || 0, result.contentBytes, result.breakdown);

          // Clear previous block warnings
          blockEditor.querySelectorAll('.block-item.block-too-large').forEach(el => {
            el.classList.remove('block-too-large');
          });

          // Check if a block is too large for pagination
          if (result.blockTooLarge) {
            const blocks = blockEditor.querySelectorAll('.block-item');
            const blockIndex = result.blockTooLarge.blockIndex;
            if (blocks[blockIndex]) {
              blocks[blockIndex].classList.add('block-too-large');
            }
          }
        } catch (e) {
          // Ignore preview errors during editing
        }
      }, 500);

      // Listen for content changes
      blockEditor.addEventListener('input', () => {
        debouncedPreview();
        updateCostRail();
      });
      titleInput.addEventListener('input', debouncedPreview);
      footerText.addEventListener('input', debouncedPreview);
      cssRules.addEventListener('input', debouncedPreview);
      navEnabled.addEventListener('change', debouncedPreview);
      footerEnabled.addEventListener('change', debouncedPreview);
      cssEnabled.addEventListener('change', debouncedPreview);

      // Update cost rail when blocks change
      const observer = new MutationObserver(() => {
        updateCostRail();
      });
      observer.observe(blockEditor, { childList: true });

      // Initial preview to get overhead
      debouncedPreview();

    })();
  </script>
</body>
</html>
