<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Editor - fourteenkilobytes</title>
  <link rel="icon" type="image/png" sizes="32x32" href="/admin/favicon-32x32.png">
  <link rel="stylesheet" href="/admin/style.css">
  <link rel="stylesheet" href="/admin/sections.css">
  <link rel="modulepreload" href="/admin/i18n.js">
  <link rel="modulepreload" href="/admin/app.js">
  <link rel="modulepreload" href="/admin/lib/common.js">
  <link rel="modulepreload" href="/admin/lib/css-utils.js">
  <link rel="modulepreload" href="/admin/lib/byte-utils.js">
  <link rel="modulepreload" href="/admin/lib/settings-utils.js">
  <link rel="modulepreload" href="/admin/lib/content-utils.js">
  <link rel="modulepreload" href="/admin/lib/editor-core.js">
  <script type="module" src="/admin/i18n.js"></script>
</head>

<body>
  <!-- Loading Overlay (shown until editor is loaded) -->
  <div id="loading-overlay" class="loading-overlay instant">
    <div class="loading-state">
      <div class="loading-spinner"></div>
      <span>Loading...</span>
    </div>
  </div>

  <!-- Use semantic header element for better document structure -->
  <header class="header">
    <div class="header-top">
      <!-- Logo with improved accessibility -->
      <div class="logo-container">
        <a href="/admin/index.html" class="logo" aria-label="14KB Dashboard">
          <!-- SVG uses currentColor to inherit accent from CSS -->
          <svg version="1.0" xmlns="http://www.w3.org/2000/svg" width="32" height="32"
            viewBox="0 0 191.000000 191.000000" preserveAspectRatio="xMidYMid meet" aria-hidden="true">
            <g transform="translate(0.000000,191.000000) scale(0.100000,-0.100000)" fill="currentColor" stroke="none">
              <path d="M406 1889 c-175 -35 -325 -178 -371 -356 -21 -81 -22 -1071 -1 -1149
47 -176 194 -315 374 -353 61 -13 1058 -16 1066 -3 2 4 -22 29 -55 55 -67 54
-152 157 -220 265 -24 39 -46 71 -49 72 -3 0 -18 -21 -34 -46 -41 -65 -64 -78
-116 -64 -63 17 -74 3 -65 -82 5 -57 4 -69 -10 -74 -24 -10 -45 15 -45 54 0
34 -1 34 -19 18 -10 -9 -21 -31 -25 -47 -5 -26 -10 -30 -33 -27 -23 2 -29 8
-31 35 -3 27 1 35 22 44 26 12 40 35 30 50 -9 16 -22 10 -58 -27 -40 -41 -72
-40 -82 2 -8 31 5 46 54 59 49 14 52 37 7 54 -19 7 -40 9 -45 6 -29 -18 -54
47 -28 73 17 17 35 15 66 -8 15 -12 41 -22 57 -23 28 -2 30 0 27 28 -8 85 -7
89 12 93 24 5 46 -23 46 -58 0 -37 29 -60 75 -60 51 0 69 18 101 106 l27 74
-19 42 c-26 59 -98 111 -196 143 -68 23 -91 36 -129 75 -58 59 -82 121 -109
278 -33 194 -24 242 44 242 36 0 242 -68 310 -102 87 -43 125 -102 140 -218 9
-60 39 -108 79 -125 20 -8 76 -15 138 -16 57 -1 142 -8 188 -15 46 -8 87 -12
90 -9 9 10 1 84 -14 119 -8 20 -25 41 -37 47 -20 11 -25 8 -55 -27 -27 -33
-35 -37 -50 -28 -10 6 -19 22 -21 36 -2 20 5 30 33 47 45 26 37 45 -16 38 -44
-6 -75 18 -65 51 9 29 30 33 70 17 57 -24 63 -18 22 24 -40 41 -44 66 -13 85
24 15 49 -2 59 -41 4 -17 15 -36 23 -43 21 -18 31 12 17 56 -8 27 -7 37 5 49
36 37 68 5 59 -58 -5 -32 -3 -47 8 -56 11 -9 18 -6 35 16 40 54 41 54 62 42
28 -15 22 -60 -11 -76 -57 -28 -65 -87 -25 -201 28 -82 31 -131 10 -171 -16
-31 -33 -41 -71 -41 -14 0 -34 -5 -45 -11 -26 -13 -15 -27 61 -79 30 -21 91
-70 135 -109 44 -39 85 -71 92 -71 20 0 18 909 -2 1003 -15 73 -58 162 -106
221 -40 48 -135 112 -207 139 -55 21 -71 22 -587 23 -305 1 -551 -2 -579 -7z" />
            </g>
          </svg>
          <!-- Stacked wordmark for compact branding -->
          <span class="logo-text" aria-hidden="true">14<br>KB</span>
        </a>
      </div>
      <!-- Semantic nav with improved structure -->
      <nav class="header-nav" aria-label="Main navigation">
        <a href="/admin/index.html" class="nav-icon">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
            aria-hidden="true">
            <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" />
            <polyline points="9 22 9 12 15 12 15 22" />
          </svg>
          <span data-i18n="nav.overview">Overview</span>
        </a>
        <a href="/admin/editor.html" class="nav-icon active" aria-current="page">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
            aria-hidden="true">
            <line x1="12" y1="5" x2="12" y2="19" />
            <line x1="5" y1="12" x2="19" y2="12" />
          </svg>
          <span data-i18n="nav.new">New</span>
        </a>
        <a href="/admin/settings.html" class="nav-icon">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
            aria-hidden="true">
            <circle cx="12" cy="12" r="3" />
            <path
              d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z" />
          </svg>
          <span data-i18n="nav.settings">Settings</span>
        </a>
        <a href="/" target="_blank" rel="noopener" class="nav-icon external-link">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
            aria-hidden="true">
            <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6" />
            <polyline points="15 3 21 3 21 9" />
            <line x1="10" y1="14" x2="21" y2="3" />
          </svg>
          <span data-i18n="nav.blog">Blog</span>
        </a>
        <!-- Visual separator before logout -->
        <span class="nav-separator" aria-hidden="true"></span>
        <a href="#" id="logout-btn" class="nav-icon logout-icon">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
            aria-hidden="true">
            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" />
            <polyline points="16 17 21 12 16 7" />
            <line x1="21" y1="12" x2="9" y2="12" />
          </svg>
          <span data-i18n="nav.logout">Logout</span>
        </a>
      </nav>
    </div>
    <div style="margin-top: 32px;">
      <div>
        <h1 id="page-title" class="page-title" style="margin: 0;" data-i18n="editor.new">New</h1>
        <p id="page-subtitle" class="page-subtitle" style="margin: 4px 0 0 0;">Creating source Â· not yet compiled</p>
      </div>
      <div style="display: flex; gap: 12px; align-items: center; justify-content: flex-end; margin-top: 16px;">
        <div id="template-selector-container" style="display: flex; gap: 12px; align-items: center;">
          <select id="template-selector" class="page-type-select">
            <option value="" data-i18n="editor.templatesSelect">Select template...</option>
          </select>
        </div>
        <button type="button" id="clear-all-btn" class="btn btn-danger"> <svg width="14" height="14" viewBox="0 0 24 24"
            fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="23 4 23 10 17 10"></polyline>
            <polyline points="1 20 1 14 7 14"></polyline>
            <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
          </svg><span data-i18n="editor.resetBtn">Reset</span></button>
      </div>
    </div>
  </header>

  <!-- Card: Head -->
  <div class="editor-card">
    <div class="card-header">
      <h2 class="card-title" data-i18n="editor.head">Head</h2>
    </div>
    <div class="card-body card-body-grid">
      <div class="base-data-row">
        <div class="form-group">
          <label for="title" data-i18n="editor.title">Title</label>
          <input type="text" id="title" data-i18n-placeholder="editor.titlePlaceholder" placeholder="My first post">
        </div>
        <div class="form-group">
          <label for="slug" data-i18n="editor.slug">Slug</label>
          <input type="text" id="slug" data-i18n-placeholder="editor.slugPlaceholder" placeholder="my-first-post">
        </div>
        <div class="form-group">
          <label for="page-type" data-i18n="editor.pageType">Page Type</label>
          <select id="page-type" class="page-type-select">
            <option value="post" data-i18n="editor.pageTypePost">Post</option>
            <option value="page" data-i18n="editor.pageTypePage">Page</option>
          </select>
          <span id="page-type-hint" class="text-small text-muted"></span>
        </div>
      </div>
      <div class="rail-item">
        <span data-i18n="editor.blogTitle">Blog Title</span>
        <span id="title-bytes">0 B</span>
      </div>

      <!-- Title Override -->
      <div class="override-section">
        <div class="override-section-header">
          <label class="override-toggle">
            <input type="checkbox" id="title-override-enabled">
            <span data-i18n="editor.browserTabTitle">Browser Tab Title</span>
          </label>
          <p id="title-override-hint" class="override-hint"><svg class="hint-icon" width="12" height="12"
              viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="20 6 9 17 4 12" />
            </svg> <span data-i18n="editor.browserTabTitleHint">Using title only</span></p>
        </div>
        <div id="title-override-editor" class="override-editor">
          <div class="form-group">
            <label for="title-override" data-i18n="editor.browserTabTitle">Browser Tab Title</label>
            <input type="text" id="title-override" maxlength="100" placeholder="Custom browser tab title..." disabled>
          </div>
        </div>
      </div>
      <div class="rail-item" id="title-rail-item">
        <span data-i18n="editor.browserTabTitle">Browser Tab Title</span>
        <span id="browser-title-bytes">0 B</span>
      </div>

      <!-- Meta-Override -->
      <div class="override-section">
        <div class="override-section-header">
          <label class="override-toggle">
            <input type="checkbox" id="meta-enabled">
            <span data-i18n="settings.meta">Meta</span>
          </label>
          <p id="meta-global-hint" class="override-hint" data-i18n="settings.metaHint">Global SEO tags</p>
        </div>
        <div id="meta-editor" class="override-editor hidden">
          <div class="meta-row">
            <div class="form-group">
              <label for="meta-description" data-i18n="settings.metaDescription">Description</label>
              <input type="text" id="meta-description" maxlength="160"
                data-i18n-placeholder="settings.metaDescriptionPlaceholder" placeholder="Page description...">
            </div>
            <div class="form-group">
              <label for="meta-author" data-i18n="settings.metaAuthor">Author</label>
              <input type="text" id="meta-author" maxlength="100" data-i18n-placeholder="settings.metaAuthorPlaceholder"
                placeholder="Author name">
            </div>
          </div>
        </div>
      </div>
      <div class="rail-item" id="meta-rail-item">
        <span data-i18n="settings.meta">Meta</span>
        <span id="meta-bytes">0 B</span>
      </div>

      <!-- Navigation-Override -->
      <div class="override-section">
        <div class="override-section-header">
          <label class="override-toggle">
            <input type="checkbox" id="nav-enabled">
            <span data-i18n="settings.navigation">Navigation</span>
          </label>
          <p id="nav-global-hint" class="override-hint" data-i18n="settings.navigationHint">Navigation links</p>
        </div>
        <div id="nav-editor" class="override-editor hidden">
          <p class="text-small text-muted mb-1" data-i18n="settings.navigationHint">Navigation links (appear on every
            page)</p>
          <div class="nav-editor-row">
            <div id="nav-links" class="nav-links"></div>
            <button type="button" id="add-nav-link" class="btn btn-secondary" data-i18n="settings.navigationAddLink">+
              Link</button>
          </div>
        </div>
      </div>
      <div class="rail-item" id="nav-rail-item">
        <span data-i18n="settings.navigation">Navigation</span>
        <span id="nav-bytes">0 B</span>
      </div>
    </div>
  </div>

  <!-- Card: Body -->
  <div class="editor-card">
    <div class="card-header">
      <h2 class="card-title" data-i18n="editor.body">Body</h2>
    </div>
    <div class="card-body card-body-grid">
      <div class="block-editor-wrapper">
        <div id="block-editor" class="block-editor"></div>
        <div class="block-actions-row">
          <button type="button" id="add-block-btn" class="btn btn-secondary" data-i18n="editor.addBlock">+ Add
            Block</button>
          <div id="add-block-dropdown" class="add-block-dropdown hidden">
            <button type="button" data-type="paragraph" data-i18n="editor.blockParagraph">Paragraph</button>
            <button type="button" data-type="heading" data-level="2" data-i18n="editor.blockHeading">Heading</button>
            <button type="button" data-type="list" data-list-type="unordered" data-i18n="editor.blockList">List</button>
            <button type="button" data-type="divider" data-i18n="editor.blockDivider">Divider</button>
            <button type="button" data-type="spacer" data-i18n="editor.blockSpacer">Spacer</button>
            <button type="button" data-type="bloglist" data-i18n="editor.blockBloglist">Bloglist</button>
            <button type="button" data-type="section" data-i18n="editor.blockSection">Section</button>
          </div>
        </div>
      </div>
      <div class="rail-item rail-item-total" id="content-rail">
        <span data-i18n="editor.body">Body</span>
        <span id="cost-content-total">0 B</span>
      </div>
    </div>
  </div>

  <!-- Card: Footer -->
  <div class="editor-card">
    <div class="card-header">
      <h2 class="card-title" data-i18n="editor.footer">Footer</h2>
    </div>
    <div class="card-body card-body-grid">
      <!-- Footer-Override -->
      <div class="override-section override-section-first">
        <div class="override-section-header">
          <label class="override-toggle">
            <input type="checkbox" id="footer-enabled">
            <span data-i18n="settings.footerSection">Footer</span>
          </label>
          <p id="footer-global-hint" class="override-hint" data-i18n="settings.footerHint">Footer text</p>
        </div>
        <div id="footer-editor" class="override-editor hidden">
          <div class="footer-editor-row">
            <input type="text" id="footer-text" placeholder="Â© 2024 My Blog">
            <button type="button" id="insert-bytes-btn" class="btn btn-secondary"
              data-i18n="settings.footerBytesBtn">{{bytes}}</button>
          </div>
        </div>
      </div>
      <div class="rail-item">
        <span data-i18n="settings.footerSection">Footer</span>
        <span id="footer-bytes">0 B</span>
      </div>

      <!-- CSS Override -->
      <div class="override-section">
        <div class="override-section-header">
          <label class="override-toggle">
            <input type="checkbox" id="css-enabled">
            <span data-i18n="tabs.css">CSS</span>
          </label>
          <p id="css-global-hint" class="override-hint"></p>
        </div>
        <div id="css-editor" class="override-editor">
          <p class="css-warning-hint" data-i18n="settings.cssCustomHint">Custom CSS rules (embedded in every page)</p>
          <textarea id="css-rules" rows="10" data-i18n-placeholder="settings.cssCustom"
            placeholder="/* Additional CSS */"></textarea>
        </div>
      </div>
      <div class="rail-item">
        <span data-i18n="tabs.css">CSS</span>
        <span id="css-bytes">0 B</span>
      </div>
    </div>
  </div>

  <!-- Link Edit Popup for Navigation -->
  <div id="nav-link-popup" class="nav-link-popup hidden">
    <div class="popup-content">
      <div class="form-group">
        <label data-i18n="linkPopup.text">Text</label>
        <input type="text" id="nav-link-text" data-i18n-placeholder="linkPopup.textPlaceholder" placeholder="Home">
      </div>
      <div class="form-group">
        <label data-i18n="linkPopup.target">Target</label>
        <input type="text" id="nav-link-href" data-i18n-placeholder="linkPopup.targetPlaceholder" placeholder="/">
      </div>
      <div class="popup-actions">
        <button type="button" id="nav-link-save" class="btn btn-primary" data-i18n="linkPopup.save">OK</button>
        <button type="button" id="nav-link-delete" class="btn btn-danger" data-i18n="linkPopup.delete">Delete</button>
        <button type="button" id="nav-link-cancel" class="btn btn-secondary"
          data-i18n="linkPopup.cancel">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Floating Format Toolbar (disabled - using inline buttons in block header)
  <div id="format-toolbar" class="format-toolbar hidden">
    <button type="button" data-cmd="bold" title="Bold"><b>B</b></button>
    <button type="button" data-cmd="italic" title="Italic"><i>I</i></button>
    <button type="button" data-cmd="underline" title="Underline"><u>U</u></button>
    <button type="button" data-cmd="strikethrough" title="Strikethrough"><s>S</s></button>
    <button type="button" data-cmd="code" title="Code"><code>&lt;&gt;</code></button>
    <button type="button" data-cmd="link" title="Link">ðŸ”—</button>
  </div>
  -->

  <!-- Link Popup for content -->
  <div id="link-popup" class="link-popup hidden">
    <div class="link-prefix-buttons">
      <button type="button" class="link-prefix-btn" data-prefix="https://" title="URL">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10" />
          <line x1="2" y1="12" x2="22" y2="12" />
          <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z" />
        </svg>
      </button>
      <button type="button" class="link-prefix-btn" data-prefix="mailto:" title="E-Mail">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z" />
          <polyline points="22,6 12,13 2,6" />
        </svg>
      </button>
      <button type="button" class="link-prefix-btn" data-prefix="tel:" title="Telefon">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path
            d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z" />
        </svg>
      </button>
    </div>
    <input type="text" id="link-href" placeholder="/path or #anchor">
    <button type="button" id="link-apply" class="btn btn-primary">OK</button>
    <button type="button" id="link-cancel" class="btn btn-secondary">Ã—</button>
  </div>

  <!-- Modal System -->
  <div id="modal-backdrop" class="modal-backdrop hidden"></div>
  <div id="modal" class="modal hidden">
    <div class="modal-content">
      <p id="modal-message"></p>
      <div id="modal-actions" class="popup-actions"></div>
    </div>
  </div>

  <!-- Card: Build -->
  <div class="editor-card">
    <div class="card-header">
      <h2 class="card-title">Build</h2>
    </div>
    <div class="card-body card-body-with-rail">
      <div class="card-content">
        <div class="breakdown-table">
          <div class="breakdown-row">
            <span>Base</span>
            <span id="breakdown-base">0 B</span>
          </div>
          <div class="breakdown-row">
            <span>Title</span>
            <span id="breakdown-title">0 B</span>
          </div>
          <div class="breakdown-row">
            <span>Favicon</span>
            <span id="breakdown-favicon">0 B</span>
          </div>
          <div class="breakdown-row">
            <span>Navigation</span>
            <span id="breakdown-nav">0 B</span>
          </div>
          <div class="breakdown-row">
            <span>Meta</span>
            <span id="breakdown-meta">0 B</span>
          </div>
          <div class="breakdown-row">
            <span>Footer</span>
            <span id="breakdown-footer">0 B</span>
          </div>
          <div class="breakdown-row">
            <span>CSS</span>
            <span id="breakdown-css">0 B</span>
          </div>
          <div class="breakdown-row">
            <span>Content</span>
            <span id="breakdown-content">0 B</span>
          </div>
          <div class="breakdown-row breakdown-row-total">
            <span>Total</span>
            <span id="breakdown-total">0 B / 14.336 B</span>
          </div>
        </div>
      </div>
      <div class="card-rail build-rail">
        <div class="build-progress">
          <div class="pie-chart" id="pie-chart">
            <span class="pie-percent" id="pie-percent">0%</span>
          </div>
          <div class="pie-legend">
            <div class="pie-legend-item">
              <span class="pie-dot pie-dot-overhead"></span>
              <span>Overhead</span>
            </div>
            <div class="pie-legend-item">
              <span class="pie-dot pie-dot-content"></span>
              <span>Content</span>
            </div>
            <div class="pie-legend-item">
              <span class="pie-dot pie-dot-free"></span>
              <span>Free</span>
            </div>
          </div>
        </div>
        <button id="publish-btn" class="btn btn-primary build-publish-btn" data-i18n="editor.buildPublish">Compile &
          Publish</button>
      </div>
    </div>
  </div>

  <!-- Live CSS Container -->
  <style id="live-css"></style>

  <script type="module" src="/admin/app.js"></script>
  <script type="module">
    // Import compiler (browser bundle)
    import * as Compiler from './compiler.browser.js';
    // Import common utilities
    import { debounce, initAuthGuard, setupLogoutHandler, hideLoadingOverlay } from './lib/common.js';
    // Import editor core functions (data serialization/deserialization)
    import { inlineNodesToHtml, parseInlineNodes, selectorFromSourceBlock, serializeBlock } from './lib/editor-core.js';
    // Import byte utilities
    import { formatBytes } from './lib/byte-utils.js';
    // Import byte estimation functions
    import { parseSelector, selectorToAttributes, renderBlockHtml, estimateBlockSize } from './lib/byte-estimation.js';
    // Import publish workflow functions
    import { validatePublishData, determinePaginationStrategy, executePublish, resetEditorForm } from './lib/publish-workflow.js';
    // Import block UI utilities
    import { createBlockSelectorControl, createBlockActions, createBlockHeader, createInnerAddBlock, createByteIndicator } from './lib/block-ui-utils.js';
    // Import block builders
    import { createSectionBlock, createLayoutBlock } from './lib/block-builders.js';
    // Import modal utilities
    import { createModalManager } from './lib/modal-utils.js';
    // Import block operations
    import { updateBlockStyling, insertBlockBelow, moveBlock as moveBlockUtil, toggleSelectionWrap } from './lib/block-operations.js';
    // Import block type selectors
    import { createTextBlockTypeSelector, createHeadingLevelSelector, createListTypeSelector, createBlockTypeLabel, createFormatButtons } from './lib/block-type-selectors.js';
    // Import block content builders
    import { createBloglistContent, createListContent, createDividerContent, createSpacerContent, createCodeblockContent, createBlockquoteContent, createParagraphContent, createHeadingContent } from './lib/block-content-builders.js';
    // Import editor state manager
    import { createEditorStateManager } from './lib/editor/state.js';
    // Import editor metrics manager
    import { createEditorMetricsManager } from './lib/editor/metrics.js';
    // Import editor overrides manager
    import { createEditorOverridesManager } from './lib/editor/overrides.js';
    // Import editor build input manager
    import { createEditorBuildInputManager } from './lib/editor/build-input.js';

    // Declare early to avoid initialization order issues
    let debouncedPreview = () => { };

    (async function () {
      // Initialize auth guard and setup
      await initAuthGuard({ redirectIfNotAuth: 'index.html' });

      // Load settings with global header/footer/CSS
      const settings = await App.getSettings();
      window.globalConfig = settings;

      // Hide loading overlay and setup logout
      hideLoadingOverlay();
      setupLogoutHandler();

      // Elements
      const pageTypeSelect = document.getElementById('page-type');
      const pageTypeHint = document.getElementById('page-type-hint');
      const titleInput = document.getElementById('title');
      const slugInput = document.getElementById('slug');
      const blockEditor = document.getElementById('block-editor');
      const addBlockBtn = document.getElementById('add-block-btn');
      const addBlockDropdown = document.getElementById('add-block-dropdown');
      const formatToolbar = document.getElementById('format-toolbar');
      const linkPopup = document.getElementById('link-popup');
      const linkHrefInput = document.getElementById('link-href');
      const linkApplyBtn = document.getElementById('link-apply');
      const linkCancelBtn = document.getElementById('link-cancel');
      const navEnabled = document.getElementById('nav-enabled');
      const navEditor = document.getElementById('nav-editor');
      const navGlobalHint = document.getElementById('nav-global-hint');
      const navLinks = document.getElementById('nav-links');
      const addNavLinkBtn = document.getElementById('add-nav-link');
      const navLinkPopup = document.getElementById('nav-link-popup');
      const navLinkText = document.getElementById('nav-link-text');
      const navLinkHref = document.getElementById('nav-link-href');
      const navLinkSave = document.getElementById('nav-link-save');
      const navLinkDelete = document.getElementById('nav-link-delete');
      const navLinkCancel = document.getElementById('nav-link-cancel');
      const footerEnabled = document.getElementById('footer-enabled');
      const footerEditor = document.getElementById('footer-editor');
      const footerGlobalHint = document.getElementById('footer-global-hint');
      const footerText = document.getElementById('footer-text');
      const titleOverrideEnabled = document.getElementById('title-override-enabled');
      const titleOverrideEditor = document.getElementById('title-override-editor');
      const titleOverrideHint = document.getElementById('title-override-hint');
      const titleOverrideInput = document.getElementById('title-override');
      const metaEnabled = document.getElementById('meta-enabled');
      const metaEditor = document.getElementById('meta-editor');
      const metaGlobalHint = document.getElementById('meta-global-hint');
      const metaDescription = document.getElementById('meta-description');
      const metaAuthor = document.getElementById('meta-author');
      const cssEnabled = document.getElementById('css-enabled');
      const cssEditor = document.getElementById('css-editor');
      const cssGlobalHint = document.getElementById('css-global-hint');
      const cssRules = document.getElementById('css-rules');
      const liveCSS = document.getElementById('live-css');
      const publishBtn = document.getElementById('publish-btn');

      // Byte display elements
      const costContentTotal = document.getElementById('cost-content-total');
      const contentRail = document.getElementById('content-rail');
      const titleBytesEl = document.getElementById('title-bytes');
      const browserTitleBytesEl = document.getElementById('browser-title-bytes');
      const navBytesEl = document.getElementById('nav-bytes');
      const metaBytesEl = document.getElementById('meta-bytes');
      const footerBytesEl = document.getElementById('footer-bytes');
      const cssBytesEl = document.getElementById('css-bytes');

      // Build Card elements
      const breakdownBase = document.getElementById('breakdown-base');
      const breakdownTitle = document.getElementById('breakdown-title');
      const breakdownFavicon = document.getElementById('breakdown-favicon');
      const breakdownNav = document.getElementById('breakdown-nav');
      const breakdownMeta = document.getElementById('breakdown-meta');
      const breakdownFooter = document.getElementById('breakdown-footer');
      const breakdownCss = document.getElementById('breakdown-css');
      const breakdownContent = document.getElementById('breakdown-content');
      const breakdownTotal = document.getElementById('breakdown-total');
      const pieChart = document.getElementById('pie-chart');
      const piePercent = document.getElementById('pie-percent');
      const pieContentDot = document.querySelector('.pie-dot-content');

      // State
      let savedSelection = null;

      // ============ AUTO-SAVE ============
      let editorStateManager = null;

      function getEditorStateManager() {
        if (editorStateManager) {
          return editorStateManager;
        }

        editorStateManager = createEditorStateManager({
          titleInput,
          slugInput,
          pageTypeSelect,
          blockEditor,
          titleOverrideEnabled,
          titleOverrideInput,
          navEnabled,
          navLinks,
          footerEnabled,
          footerText,
          metaEnabled,
          metaDescription,
          metaAuthor,
          cssEnabled,
          cssRules,
          getContentFromBlocks,
          getNavigationItems,
          loadFromSource,
          updatePageTitleSlug,
          createBlockElement,
          createNavChip
        });

        return editorStateManager;
      }

      function getCurrentContext() {
        return getEditorStateManager().getCurrentContext();
      }

      function saveToLocalStorage() {
        return getEditorStateManager().saveToLocalStorage();
      }

      function loadFromLocalStorage() {
        return getEditorStateManager().loadFromLocalStorage();
      }

      function clearAutoSave() {
        return getEditorStateManager().clearAutoSave();
      }

      // ============ EDIT MODE (Source Editing) ============

      let isEditMode = false;
      let editingSlug = null;

      // Update page title with current slug (for new mode)
      function updatePageTitleSlug() {
        if (isEditMode) return; // Don't update in edit mode
        const pageTitle = document.getElementById('page-title');
        const slug = slugInput.value.trim();
        if (slug) {
          pageTitle.innerHTML = `New <span style="font-weight: 400; color: var(--text-secondary);">/ ${slug}</span>`;
        } else {
          pageTitle.textContent = 'New';
        }
      }

      // SVG icons for alignment buttons (shared by createBlockElement and blockElFromSource)
      const alignSvgs = {
        left: '<svg width="14" height="14" viewBox="0 0 14 14"><line x1="1" y1="3" x2="13" y2="3" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/><line x1="1" y1="7" x2="9" y2="7" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/><line x1="1" y1="11" x2="11" y2="11" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>',
        center: '<svg width="14" height="14" viewBox="0 0 14 14"><line x1="1" y1="3" x2="13" y2="3" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/><line x1="3" y1="7" x2="11" y2="7" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/><line x1="2" y1="11" x2="12" y2="11" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>',
        right: '<svg width="14" height="14" viewBox="0 0 14 14"><line x1="1" y1="3" x2="13" y2="3" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/><line x1="5" y1="7" x2="13" y2="7" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/><line x1="3" y1="11" x2="13" y2="11" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>'
      };

      function applySelectorToBlockElement(element, block) {
        if (!element) return element;
        const selector = selectorFromSourceBlock(block);
        element.dataset.selector = selector;
        const selectorInput = element.querySelector('.block-selector-input');
        if (selectorInput) {
          selectorInput.value = selector;
        }
        return element;
      }

      let blockElFromSource = null;

      // Load editor state from source JSON (compiler format)
      function loadFromSource(sourceData) {
        // Restore basic fields
        titleInput.value = sourceData.title || '';
        slugInput.value = sourceData.slug || '';
        pageTypeSelect.value = sourceData.pageType || 'post';

        // Helper to create a block element from source data
        blockElFromSource = function (block, depth = 0) {
          const isNested = depth > 0;
          if (block.type === 'bloglist') {
            return applySelectorToBlockElement(createBlockElement('bloglist', null, '', null, null, isNested), block);
          }
          if (block.type === 'divider') {
            return applySelectorToBlockElement(createBlockElement('divider', null, '', null, null, isNested), block);
          }
          if (block.type === 'spacer') {
            return applySelectorToBlockElement(createBlockElement('spacer', null, '', null, block.height || '1rem', isNested), block);
          }
          if (block.type === 'codeblock') {
            return applySelectorToBlockElement(createBlockElement('codeblock', null, block.content || '', null, null, isNested), block);
          }
          if (block.type === 'unordered-list' || block.type === 'ordered-list') {
            const listType = block.type === 'ordered-list' ? 'ordered' : 'unordered';
            const el = createBlockElement('list', null, '', listType, null, isNested);
            const listEl = el.querySelector('.editable-list');
            if (listEl && block.items) {
              listEl.innerHTML = '';
              block.items.forEach(item => {
                const li = document.createElement('li');
                li.contentEditable = 'true';
                li.innerHTML = inlineNodesToHtml(item.children);
                listEl.appendChild(li);
              });
              setupListKeyHandlers(listEl);
            }
            return applySelectorToBlockElement(el, block);
          }
          if (block.type === 'section') {
            const el = createBlockElement('section', null, '', null, null, isNested);
            // Set properties
            el.dataset.background = block.background || '#1a1a1a';
            el.dataset.color = block.color || '#ffffff';
            el.dataset.pattern = block.pattern || '';
            el.dataset.patternColor = block.patternColor || '#ffffff';
            el.dataset.patternOpacity = block.patternOpacity || '0.1';
            el.dataset.width = block.width || '';
            el.dataset.padding = block.padding || '';
            el.dataset.align = block.align || '';

            // Update UI controls
            const bgInput = el.querySelector('.section-controls input[type="color"]');
            if (bgInput) bgInput.value = block.background || '#1a1a1a';

            const colorInputs = el.querySelectorAll('.section-inner-wrapper input[type="color"]');
            // 0=background, 1=text, 2=pattern
            if (colorInputs[1]) colorInputs[1].value = block.color || '#ffffff';
            if (colorInputs[2]) colorInputs[2].value = block.patternColor || '#ffffff';

            const patternSelect = el.querySelector('.section-pattern-select');
            if (patternSelect) patternSelect.value = block.pattern || '';
            const sectionInnerWrapper = el.querySelector('.section-inner-wrapper');
            if (sectionInnerWrapper) sectionInnerWrapper.classList.toggle('has-pattern', !!block.pattern);

            const opacityInput = el.querySelector('.section-pattern-row input[type="range"]');
            if (opacityInput) opacityInput.value = block.patternOpacity || '0.1';
            const opacityNumber = el.querySelector('.section-opacity-input');
            if (opacityNumber) opacityNumber.value = block.patternOpacity || '0.1';

            const widthInput = el.querySelector('.section-width-input');
            if (widthInput) widthInput.value = block.width || '';

            const paddingInput = el.querySelector('.section-padding-input');
            if (paddingInput) paddingInput.value = block.padding || '';

            const alignSelect = el.querySelector('.section-align-select');
            if (alignSelect) alignSelect.value = block.align || '';

            // Update preview colors
            const preview = el.querySelector('.section-preview');
            if (preview) {
              preview.style.backgroundColor = block.background || '#ffffff';
              preview.style.color = block.color || '#000000';
              preview.style.textAlign = block.align || '';
              if (block.padding) preview.style.setProperty('--sp', block.padding);
              const pClass = Compiler.getPatternClass(block.pattern || '');
              preview.className = 'section-preview ' + pClass;

              // Set PC var
              const opacity = parseFloat(block.patternOpacity || '0.1');
              const hex = block.patternColor || '#ffffff';
              const r = parseInt(hex.substring(1, 3), 16);
              const g = parseInt(hex.substring(3, 5), 16);
              const b = parseInt(hex.substring(5, 7), 16);
              preview.style.setProperty('--pc', `rgba(${r},${g},${b},${opacity})`);
            }
            // Load child blocks
            if (block.children && block.children.length > 0) {
              const sectionBlocks = el.querySelector('.section-blocks');
              block.children.forEach(child => {
                sectionBlocks.appendChild(blockElFromSource(child, depth + 1));
              });
            }
            return applySelectorToBlockElement(el, block);
          }
          if (block.type === 'layout') {
            const el = createBlockElement('layout', null, '', null, null, isNested);
            const cols = block.columns || 2;
            const rows = block.cells ? Math.ceil(block.cells.length / cols) : 2;

            el.dataset.columns = cols;
            el.dataset.rows = rows;

            // Get cell grid and populate
            const cellsGrid = el.querySelector('.layout-cells-grid');
            if (cellsGrid && block.cells && block.cells.length > 0) {
              // Clear existing cells (keep controls)
              cellsGrid.querySelectorAll(':scope > .layout-cell').forEach(c => c.remove());

              // Recreate cells from data
              block.cells.forEach(cellData => {
                const cellEl = document.createElement('div');
                cellEl.className = 'layout-cell';

                // Cell toolbar
                const toolbar = document.createElement('div');
                toolbar.className = 'layout-cell-toolbar';

                // Alignment buttons
                const alignGroup = document.createElement('div');
                alignGroup.className = 'layout-toolbar-group';
                ['left', 'center', 'right'].forEach(align => {
                  const abtn = document.createElement('button');
                  abtn.type = 'button';
                  abtn.className = 'layout-align-btn';
                  abtn.dataset.align = align;
                  abtn.innerHTML = alignSvgs[align];
                  abtn.title = 'Align ' + align;
                  if (cellData.textAlign === align) abtn.classList.add('active');
                  abtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    cellEl.dataset.textAlign = align;
                    cellEl.style.textAlign = align;
                    alignGroup.querySelectorAll('.layout-align-btn').forEach(b => b.classList.remove('active'));
                    abtn.classList.add('active');
                    debouncedPreview();
                  });
                  alignGroup.appendChild(abtn);
                });
                toolbar.appendChild(alignGroup);

                // Padding input
                const padGroup = document.createElement('label');
                padGroup.className = 'layout-toolbar-input';
                padGroup.innerHTML = '<span>P</span>';
                const padInput = document.createElement('input');
                padInput.type = 'text';
                padInput.placeholder = '0';
                padInput.title = 'Padding';
                if (cellData.padding) {
                  padInput.value = cellData.padding;
                  cellEl.dataset.padding = cellData.padding;
                  cellEl.style.padding = cellData.padding;
                }
                padInput.addEventListener('input', () => {
                  const value = padInput.value.trim();
                  cellEl.dataset.padding = value;
                  cellEl.style.padding = value || '';
                  debouncedPreview();
                });
                padGroup.appendChild(padInput);
                toolbar.appendChild(padGroup);

                // Margin input
                const marGroup = document.createElement('label');
                marGroup.className = 'layout-toolbar-input';
                marGroup.innerHTML = '<span>M</span>';
                const marInput = document.createElement('input');
                marInput.type = 'text';
                marInput.placeholder = '0';
                marInput.title = 'Margin';
                if (cellData.margin) {
                  marInput.value = cellData.margin;
                  cellEl.dataset.margin = cellData.margin;
                  cellEl.style.margin = cellData.margin;
                }
                marInput.addEventListener('input', () => {
                  const value = marInput.value.trim();
                  cellEl.dataset.margin = value;
                  cellEl.style.margin = value || '';
                  debouncedPreview();
                });
                marGroup.appendChild(marInput);
                toolbar.appendChild(marGroup);

                // Delete button
                const delBtn = document.createElement('button');
                delBtn.type = 'button';
                delBtn.className = 'layout-toolbar-delete';
                delBtn.textContent = 'Ã—';
                delBtn.title = 'Delete block';
                delBtn.addEventListener('click', (e) => {
                  e.stopPropagation();
                  const cb = cellEl.querySelector('.layout-cell-blocks');
                  cb.innerHTML = '';
                  debouncedPreview();
                });
                toolbar.appendChild(delBtn);

                cellEl.appendChild(toolbar);

                // Restore alignment
                if (cellData.textAlign) {
                  cellEl.dataset.textAlign = cellData.textAlign;
                  cellEl.style.textAlign = cellData.textAlign;
                }

                const cellBlocks = document.createElement('div');
                cellBlocks.className = 'layout-cell-blocks';
                if (cellData.children && cellData.children.length > 0) {
                  const child = cellData.children[0];
                  cellBlocks.appendChild(blockElFromSource(child, depth + 1));
                }
                cellEl.appendChild(cellBlocks);

                // Add block button with type picker
                const addBtn = document.createElement('button');
                addBtn.type = 'button';
                addBtn.className = 'layout-cell-add-btn';
                addBtn.textContent = '+';
                addBtn.title = 'Add block';

                const dropdown = document.createElement('div');
                dropdown.className = 'layout-cell-dropdown hidden';
                const innerTypes = [
                  { type: 'paragraph', label: 'Paragraph' },
                  { type: 'heading', label: 'Heading', level: '2' },
                  { type: 'list', label: 'List', listType: 'unordered' },
                  { type: 'divider', label: 'Divider' },
                  { type: 'spacer', label: 'Spacer' }
                ];
                innerTypes.forEach(t => {
                  const b = document.createElement('button');
                  b.type = 'button';
                  b.textContent = t.label;
                  b.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const newBlock = createBlockElement(t.type, t.level, '', t.listType, t.spacerHeight, true);
                    cellBlocks.appendChild(newBlock);
                    dropdown.classList.add('hidden');
                    const focusTarget = newBlock.querySelector('li[contenteditable="true"]') || newBlock.querySelector('.block-content');
                    if (focusTarget) focusTarget.focus();
                    debouncedPreview();
                  });
                  dropdown.appendChild(b);
                });

                addBtn.addEventListener('click', (e) => {
                  e.stopPropagation();
                  dropdown.classList.toggle('hidden');
                });
                document.addEventListener('click', () => dropdown.classList.add('hidden'));

                cellEl.appendChild(addBtn);
                cellEl.appendChild(dropdown);

                cellsGrid.appendChild(cellEl);
              });

              // Update grid styling
              cellsGrid.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
              cellsGrid.style.gridTemplateRows = `repeat(${rows}, auto)`;
            }

            return applySelectorToBlockElement(el, block);
          }
          if (block.type === 'heading') {
            return applySelectorToBlockElement(createBlockElement('heading', block.level, inlineNodesToHtml(block.children), null, null, isNested), block);
          }
          if (block.type === 'blockquote') {
            return applySelectorToBlockElement(createBlockElement('blockquote', null, inlineNodesToHtml(block.children), null, null, isNested), block);
          }
          // paragraph
          return applySelectorToBlockElement(createBlockElement('paragraph', null, inlineNodesToHtml(block.children), null, null, isNested), block);
        };

        // Restore blocks from content array
        blockEditor.innerHTML = '';
        if (sourceData.content && sourceData.content.length > 0) {
          sourceData.content.forEach(block => {
            blockEditor.appendChild(blockElFromSource(block));
          });
        } else {
          // Add empty paragraph if no content
          blockEditor.appendChild(createBlockElement('paragraph'));
        }

        // Restore title override
        if (sourceData.titleOverride && typeof sourceData.titleOverride === 'object' && sourceData.titleOverride.enabled) {
          titleOverrideEnabled.checked = true;
          titleOverrideEnabled.dispatchEvent(new Event('change'));
          titleOverrideInput.value = sourceData.titleOverride.title || '';
        } else if (typeof sourceData.titleOverride === 'string' && sourceData.titleOverride) {
          // Legacy format - titleOverride is just a string
          titleOverrideEnabled.checked = true;
          titleOverrideEnabled.dispatchEvent(new Event('change'));
          titleOverrideInput.value = sourceData.titleOverride;
        } else {
          titleOverrideEnabled.checked = false;
          titleOverrideEnabled.dispatchEvent(new Event('change'));
        }

        // Restore navigation
        if (sourceData.navigation && sourceData.navigation.items && sourceData.navigation.items.length > 0) {
          navEnabled.checked = true;
          navEnabled.dispatchEvent(new Event('change'));
          navLinks.innerHTML = '';
          sourceData.navigation.items.forEach(link => {
            navLinks.appendChild(createNavChip(link.text, link.href));
          });
        } else {
          navEnabled.checked = false;
          navEnabled.dispatchEvent(new Event('change'));
          loadGlobalNavigation();
        }

        // Restore footer
        if (sourceData.footer && sourceData.footer.content) {
          footerEnabled.checked = true;
          footerEnabled.dispatchEvent(new Event('change'));
          footerText.value = sourceData.footer.content;
        } else {
          footerEnabled.checked = false;
          footerEnabled.dispatchEvent(new Event('change'));
          loadGlobalFooter();
        }

        // Restore meta
        if (sourceData.meta) {
          metaEnabled.checked = true;
          metaEnabled.dispatchEvent(new Event('change'));
          metaDescription.value = sourceData.meta.description || '';
          metaAuthor.value = sourceData.meta.author || '';
        } else {
          metaEnabled.checked = false;
          metaEnabled.dispatchEvent(new Event('change'));
          loadGlobalMeta();
        }

        // Restore CSS
        if (sourceData.css && sourceData.css.rules) {
          cssEnabled.checked = true;
          cssEnabled.dispatchEvent(new Event('change'));
          cssRules.value = sourceData.css.rules;
        } else {
          cssEnabled.checked = false;
          cssEnabled.dispatchEvent(new Event('change'));
          loadGlobalCSS();
        }
      }

      // ============ PAGE TYPE ============

      pageTypeSelect.addEventListener('change', () => {
        const type = pageTypeSelect.value;
        if (type === 'page') {
          pageTypeHint.textContent = '(not in feed)';
        } else {
          pageTypeHint.textContent = '';
        }
      });

      // ============ NAVIGATION EDITOR ============
      const insertBytesBtn = document.getElementById('insert-bytes-btn');
      let editorOverridesManager = null;

      function getEditorOverridesManager() {
        if (editorOverridesManager) {
          return editorOverridesManager;
        }

        editorOverridesManager = createEditorOverridesManager({
          navEnabled,
          navGlobalHint,
          navLinks,
          addNavLinkBtn,
          navLinkPopup,
          navLinkText,
          navLinkHref,
          navLinkSave,
          navLinkDelete,
          navLinkCancel,
          footerEnabled,
          footerGlobalHint,
          footerText,
          insertBytesBtn,
          metaEnabled,
          metaGlobalHint,
          metaDescription,
          metaAuthor,
          titleOverrideEnabled,
          titleOverrideHint,
          titleOverrideInput,
          cssEnabled,
          cssGlobalHint,
          cssRules,
          liveCSS,
          t,
          updateTitleBytes,
          onPreviewRequested: () => debouncedPreview(),
          getGlobalConfig: () => window.globalConfig
        });

        return editorOverridesManager;
      }

      function loadGlobalNavigation() {
        return getEditorOverridesManager().loadGlobalNavigation();
      }

      function createNavChip(text, href) {
        return getEditorOverridesManager().createNavChip(text, href);
      }

      function loadGlobalFooter() {
        return getEditorOverridesManager().loadGlobalFooter();
      }

      function loadGlobalMeta() {
        return getEditorOverridesManager().loadGlobalMeta();
      }

      function updateTitleOverrideHint() {
        return getEditorOverridesManager().updateTitleOverrideHint();
      }

      function loadGlobalCSS() {
        return getEditorOverridesManager().loadGlobalCSS();
      }

      function applyLiveCSS() {
        return getEditorOverridesManager().applyLiveCSS();
      }

      // ============ AUTO-SLUG ============

      titleInput.addEventListener('input', () => {
        if (!slugInput.dataset.manual) {
          slugInput.value = App.slugify(titleInput.value);
          updatePageTitleSlug();
        }
        updateTitleBytes();
      });

      slugInput.addEventListener('input', () => {
        slugInput.dataset.manual = 'true';
        updatePageTitleSlug();
      });

      // ============ BLOCK EDITOR ============

      function setupListKeyHandlers(listEl) {
        listEl.addEventListener('keydown', (e) => {
          const li = e.target.closest('li');
          if (!li) return;

          if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            const newLi = document.createElement('li');
            newLi.contentEditable = 'true';
            newLi.dataset.placeholder = 'List item...';
            li.after(newLi);
            newLi.focus();
            debouncedPreview();
          } else if (e.key === 'Backspace' && li.innerHTML === '' && listEl.children.length > 1) {
            e.preventDefault();
            const prevLi = li.previousElementSibling;
            li.remove();
            if (prevLi) {
              prevLi.focus();
              // Move cursor to end
              const range = document.createRange();
              const sel = window.getSelection();
              range.selectNodeContents(prevLi);
              range.collapse(false);
              sel.removeAllRanges();
              sel.addRange(range);
            }
            debouncedPreview();
          }
        });
      }

      // Helper: create inner add-block dropdown for sections (no nesting allowed)
      // Create inner add block using imported utility
      function createInnerAddBlockWrapper(sectionBlock) {
        return createInnerAddBlock({
          onBlockAdd: (config) => {
            const childBlock = createBlockElement(config.type, config.level, '', config.listType, config.spacerHeight, true);
            const sectionBlocks = sectionBlock.querySelector('.section-blocks');
            sectionBlocks.appendChild(childBlock);
            const focusTarget = childBlock.querySelector('li[contenteditable="true"]') || childBlock.querySelector('.block-content');
            if (focusTarget) focusTarget.focus();
            debouncedPreview();
          }
        });
      }

      function createBlockElement(type, level, initialHtml = '', listType = null, spacerHeight = null, isNested = false) {
        const block = document.createElement('div');
        block.className = 'block-item';
        block.dataset.type = type;
        block.dataset.selector = '';
        if (level) block.dataset.level = level;
        if (listType) block.dataset.listType = listType;
        if (type === 'spacer') block.dataset.height = spacerHeight || '1rem';

        function createBlockSelectorControl(currentBlock) {
          const input = document.createElement('input');
          input.type = 'text';
          input.className = 'block-selector-input';
          input.placeholder = '.your-css-class';
          input.title = 'CSS selector';
          input.value = currentBlock.dataset.selector || '';
          input.addEventListener('input', () => {
            currentBlock.dataset.selector = input.value.trim();
            updateCostRail();
            debouncedPreview();
          });

          return input;
        }

        // Section block: use builder
        if (type === 'section') {
          const sectionBlock = createSectionBlock({
            isNested,
            callbacks: {
              onSelectorChange: (value) => {
                updateCostRail();
                debouncedPreview();
              },
              onMoveUp: () => moveBlock(sectionBlock, -1),
              onMoveDown: () => moveBlock(sectionBlock, 1),
              onDuplicate: () => {
                const data = serializeBlock(sectionBlock);
                const clone = blockElFromSource(data);
                insertBlockDirectlyBelow(sectionBlock, clone);
                debouncedPreview();
              },
              onDelete: () => {
                sectionBlock.remove();
                debouncedPreview();
              },
              onChange: () => {
                updateCostRail();
                debouncedPreview();
              },
              createInnerAddBlock: createInnerAddBlockWrapper
            },
            Compiler
          });
          return sectionBlock;
        }

        // Layout block: use builder
        if (type === 'layout') {
          const layoutBlock = createLayoutBlock({
            isNested,
            callbacks: {
              onSelectorChange: (value) => {
                updateCostRail();
                debouncedPreview();
              },
              onMoveUp: () => moveBlock(layoutBlock, -1),
              onMoveDown: () => moveBlock(layoutBlock, 1),
              onDuplicate: () => {
                const data = serializeBlock(layoutBlock);
                const clone = blockElFromSource(data);
                insertBlockDirectlyBelow(layoutBlock, clone);
                debouncedPreview();
              },
              onDelete: () => {
                layoutBlock.remove();
                debouncedPreview();
              },
              onChange: () => {
                updateCostRail();
                debouncedPreview();
              },
              createBlockElement: (type, level, html, listType, spacerHeight, nested) => {
                return createBlockElement(type, level, html, listType, spacerHeight, nested);
              }
            }
          });
          return layoutBlock;
        }

        // Block header with type selector and actions
        const header = document.createElement('div');
        header.className = 'block-header';

        // Type selector
        if (type === 'paragraph' || type === 'blockquote' || type === 'codeblock') {
          const typeSelect = createTextBlockTypeSelector(type, (newType) => {
            const oldType = block.dataset.type;
            block.dataset.type = newType;

            // Handle content conversion
            const content = block.querySelector('.block-content');
            if (oldType === 'codeblock' && newType !== 'codeblock') {
              // From codeblock to rich text - convert plain text
              content.contentEditable = 'true';
              content.classList.remove('block-codeblock');
              content.dataset.placeholder = newType === 'blockquote' ? 'Quote...' : 'Enter text...';
              // Show format buttons
              const formatBtns = block.querySelector('.block-format-buttons');
              if (formatBtns) formatBtns.style.display = '';
            } else if (oldType !== 'codeblock' && newType === 'codeblock') {
              // From rich text to codeblock - strip HTML
              content.textContent = content.textContent;
              content.contentEditable = 'true';
              content.classList.add('block-codeblock');
              content.dataset.placeholder = 'Code...';
              // Hide format buttons
              const formatBtns = block.querySelector('.block-format-buttons');
              if (formatBtns) formatBtns.style.display = 'none';
            } else {
              // Just update placeholder
              content.dataset.placeholder = newType === 'blockquote' ? 'Quote...' : newType === 'codeblock' ? 'Code...' : 'Enter text...';
            }

            updateBlockStyling(block);
            updateCostRail();
            debouncedPreview();
          });
          header.appendChild(typeSelect);
        } else if (type === 'heading') {
          const typeSelect = createHeadingLevelSelector(level, (newLevel) => {
            block.dataset.level = newLevel;
            updateBlockStyling(block);
            updateCostRail();
            debouncedPreview();
          });
          header.appendChild(typeSelect);
        } else if (type === 'list' || type === 'unordered-list' || type === 'ordered-list') {
          // Normalize type for new blocks - use passed listType or derive from legacy type
          const effectiveListType = listType || (type === 'ordered-list' ? 'ordered' : 'unordered');
          block.dataset.type = 'list';
          block.dataset.listType = effectiveListType;

          const typeSelect = createListTypeSelector(effectiveListType, (newListType) => {
            block.dataset.listType = newListType;
            // Update list element tag
            const oldList = block.querySelector('.editable-list');
            if (oldList) {
              const newTag = newListType === 'ordered' ? 'ol' : 'ul';
              const newList = document.createElement(newTag);
              newList.className = 'editable-list';
              // Move all children
              while (oldList.firstChild) {
                newList.appendChild(oldList.firstChild);
              }
              // Copy event listeners by replacing
              oldList.replaceWith(newList);
              setupListKeyHandlers(newList);
            }
            updateCostRail();
            debouncedPreview();
          });
          header.appendChild(typeSelect);
        } else {
          // Bloglist, Divider or Spacer - just a label
          header.appendChild(createBlockTypeLabel(type));
        }

        // Format buttons (nur fÃ¼r rich-text BlÃ¶cke)
        if (type !== 'bloglist' && type !== 'divider' && type !== 'codeblock' && type !== 'spacer') {
          header.appendChild(createFormatButtons(handleFormatClick, block));
        }

        const actions = document.createElement('div');
        actions.className = 'block-item-actions';
        if (!isNested) actions.appendChild(createBlockSelectorControl(block));

        const upBtn = document.createElement('button');
        upBtn.type = 'button';
        upBtn.textContent = 'â†‘';
        upBtn.title = 'Move up';
        upBtn.addEventListener('click', () => moveBlock(block, -1));
        actions.appendChild(upBtn);

        const downBtn = document.createElement('button');
        downBtn.type = 'button';
        downBtn.textContent = 'â†“';
        downBtn.title = 'Move down';
        downBtn.addEventListener('click', () => moveBlock(block, 1));
        actions.appendChild(downBtn);

        const copyBtn = document.createElement('button');
        copyBtn.type = 'button';
        copyBtn.innerHTML = 'â§‰';
        copyBtn.title = 'Duplicate';
        copyBtn.addEventListener('click', () => {
          const data = serializeBlock(block);
          const clone = blockElFromSource(data);
          insertBlockDirectlyBelow(block, clone);
          debouncedPreview();
        });
        actions.appendChild(copyBtn);

        const deleteBtn = document.createElement('button');
        deleteBtn.type = 'button';
        deleteBtn.textContent = 'Ã—';
        deleteBtn.title = 'Delete';
        deleteBtn.addEventListener('click', () => block.remove());
        actions.appendChild(deleteBtn);

        header.appendChild(actions);

        // Byte indicator fÃ¼r diesen Block
        const byteIndicator = document.createElement('div');
        byteIndicator.className = 'block-byte-indicator';
        byteIndicator.textContent = '0 B';
        block.appendChild(byteIndicator);

        block.appendChild(header);

        // Content area
        let content;
        if (type === 'bloglist') {
          content = createBloglistContent();
        } else if (type === 'list' || type === 'unordered-list' || type === 'ordered-list') {
          const effectiveListType = block.dataset.listType || (type === 'ordered-list' ? 'ordered' : 'unordered');
          content = createListContent({
            listType: effectiveListType,
            initialHtml,
            setupListKeyHandlers
          });
        } else if (type === 'divider') {
          content = createDividerContent();
        } else if (type === 'spacer') {
          content = createSpacerContent({
            height: block.dataset.height || spacerHeight || '1rem',
            block,
            onChange: () => {
              updateCostRail();
              debouncedPreview();
            }
          });
        } else if (type === 'codeblock') {
          content = createCodeblockContent(initialHtml);
        } else if (type === 'blockquote') {
          content = createBlockquoteContent(initialHtml);
        } else if (type === 'heading') {
          content = createHeadingContent(initialHtml);
        } else {
          content = createParagraphContent(initialHtml);
        }
        block.appendChild(content);

        updateBlockStyling(block);
        return block;
      }

      // updateBlockStyling now imported from block-operations.js

      // moveBlock wrapper with callbacks
      function moveBlock(block, direction) {
        moveBlockUtil(block, direction, {
          onChange: () => {
            updateCostRail();
            debouncedPreview();
          }
        });
      }

      // insertBlockDirectlyBelow now uses imported insertBlockBelow
      function insertBlockDirectlyBelow(referenceBlock, newBlock) {
        insertBlockBelow(referenceBlock, newBlock);
      }

      // ============ FORMAT BUTTONS ============

      function handleFormatClick(cmd, block) {
        // Save selection BEFORE anything else (clicking button may lose it)
        const sel = window.getSelection();
        const hasSelection = sel.rangeCount > 0 && !sel.isCollapsed;
        const currentRange = hasSelection ? sel.getRangeAt(0).cloneRange() : null;

        // For link command, we need a selection
        if (cmd === 'link') {
          if (!hasSelection) {
            alert('Bitte erst Text markieren');
            return;
          }
          savedSelection = currentRange;
          showLinkPopup();
          return;
        }

        // Focus the block content if not already focused
        const content = block.querySelector('.block-content');
        const listItem = block.querySelector('li[contenteditable="true"]');
        const editableEl = listItem || content;

        // Restore selection if we have one
        if (currentRange) {
          sel.removeAllRanges();
          sel.addRange(currentRange);
        } else if (!editableEl.contains(document.activeElement) && editableEl !== document.activeElement) {
          editableEl.focus();
        }

        if (cmd === 'bold') {
          document.execCommand('bold', false, null);
        } else if (cmd === 'italic') {
          document.execCommand('italic', false, null);
        } else if (cmd === 'underline') {
          document.execCommand('underline', false, null);
        } else if (cmd === 'strikethrough') {
          document.execCommand('strikeThrough', false, null);
        } else if (cmd === 'code') {
          wrapSelectionWithTag('code');
        }
        debouncedPreview();
      }

      // ============ FLOATING FORMAT TOOLBAR (disabled - using inline buttons) ============
      /*
      document.addEventListener('selectionchange', () => {
        const sel = window.getSelection();
        if (!sel.rangeCount || sel.isCollapsed) {
          formatToolbar.classList.add('hidden');
          return;
        }

        // Check if selection is within block editor
        const range = sel.getRangeAt(0);
        const container = range.commonAncestorContainer;
        const blockContent = container.nodeType === Node.TEXT_NODE
          ? container.parentElement.closest('.block-content')
          : container.closest('.block-content');

        if (!blockContent || !blockEditor.contains(blockContent)) {
          formatToolbar.classList.add('hidden');
          return;
        }

        // Position toolbar above selection
        const rect = range.getBoundingClientRect();
        formatToolbar.style.top = (rect.top + window.scrollY - 40) + 'px';
        formatToolbar.style.left = (rect.left + window.scrollX + rect.width / 2 - 50) + 'px';
        formatToolbar.classList.remove('hidden');
      });

      formatToolbar.addEventListener('click', (e) => {
        const btn = e.target.closest('button');
        if (!btn) return;

        const cmd = btn.dataset.cmd;
        if (cmd === 'bold') {
          document.execCommand('bold', false, null);
        } else if (cmd === 'italic') {
          document.execCommand('italic', false, null);
        } else if (cmd === 'underline') {
          document.execCommand('underline', false, null);
        } else if (cmd === 'strikethrough') {
          document.execCommand('strikeThrough', false, null);
        } else if (cmd === 'code') {
          wrapSelectionWithTag('code');
        } else if (cmd === 'link') {
          showLinkPopup();
        }
      });
      */

      // wrapSelectionWithTag wrapper using imported toggleSelectionWrap
      function wrapSelectionWithTag(tagName) {
        toggleSelectionWrap(tagName, {
          onChange: () => debouncedPreview()
        });
      }

      // ============ LINK POPUP ============

      function showLinkPopup() {
        // savedSelection should already be set by handleFormatClick
        if (!savedSelection) return;

        // Check if selection is inside a link
        const sel = window.getSelection();
        sel.removeAllRanges();
        sel.addRange(savedSelection);
        const parentLink = sel.anchorNode?.parentElement?.closest('a');
        const existingHref = parentLink ? parentLink.getAttribute('href') : '';
        linkHrefInput.value = existingHref;

        // Reset prefix buttons and set active based on existing href
        linkPopup.querySelectorAll('.link-prefix-btn').forEach(btn => {
          const prefix = btn.dataset.prefix;
          if (existingHref.startsWith(prefix)) {
            btn.classList.add('active');
          } else {
            btn.classList.remove('active');
          }
        });

        // Update placeholder based on existing prefix
        if (existingHref.startsWith('https://') || existingHref.startsWith('http://')) {
          linkHrefInput.placeholder = 'www.example.com';
        } else if (existingHref.startsWith('mailto:')) {
          linkHrefInput.placeholder = 'name@example.com';
        } else if (existingHref.startsWith('tel:')) {
          linkHrefInput.placeholder = '+49 123 456789';
        } else {
          linkHrefInput.placeholder = '/path or #anchor';
        }

        const rect = savedSelection.getBoundingClientRect();
        linkPopup.style.top = (rect.bottom + window.scrollY + 5) + 'px';
        linkPopup.style.left = (rect.left + window.scrollX) + 'px';
        linkPopup.classList.remove('hidden');
        linkHrefInput.focus();
      }

      linkApplyBtn.addEventListener('click', () => {
        const href = linkHrefInput.value.trim();
        if (!href) {
          linkPopup.classList.add('hidden');
          return;
        }

        // Validate href pattern (same as compiler validation)
        const hrefPattern = /^(\/[a-z0-9._/-]*|#[a-z0-9-]*|[a-z0-9-]+\.html|https?:\/\/[^\s]+|mailto:[^\s]+|tel:[^\s]+)$/i;
        if (!hrefPattern.test(href)) {
          // Give specific hint based on what user likely meant
          let hint;
          if (/^www\./i.test(href) || /\.(com|de|org|net|io|dev|at|ch)$/i.test(href)) {
            hint = `URLs mÃ¼ssen mit https:// beginnen: https://${href}`;
          } else if (/@/.test(href) && !href.startsWith('mailto:')) {
            hint = `E-Mail-Links mÃ¼ssen mit mailto: beginnen: mailto:${href}`;
          } else if (/^[\d\s+()-]+$/.test(href)) {
            hint = `Telefon-Links mÃ¼ssen mit tel: beginnen: tel:${href.replace(/\s/g, '')}`;
          } else {
            hint = 'UngÃ¼ltiges Link-Format';
          }
          Modal.info(hint);
          return;
        }

        if (savedSelection) {
          const sel = window.getSelection();
          sel.removeAllRanges();
          sel.addRange(savedSelection);
          document.execCommand('createLink', false, href);
        }
        linkPopup.classList.add('hidden');
        savedSelection = null;
        debouncedPreview();
      });

      linkCancelBtn.addEventListener('click', () => {
        linkPopup.classList.add('hidden');
        savedSelection = null;
      });

      // Link prefix buttons
      const linkPrefixBtns = linkPopup.querySelectorAll('.link-prefix-btn');
      const prefixPlaceholders = {
        'https://': 'www.example.com',
        'mailto:': 'name@example.com',
        'tel:': '+49 123 456789'
      };

      linkPrefixBtns.forEach(btn => {
        btn.addEventListener('click', () => {
          const prefix = btn.dataset.prefix;
          const currentValue = linkHrefInput.value;

          // Remove any existing prefix
          let cleanValue = currentValue
            .replace(/^https?:\/\//, '')
            .replace(/^mailto:/, '')
            .replace(/^tel:/, '');

          // Toggle: if same prefix was active, just clear it
          if (currentValue.startsWith(prefix)) {
            linkHrefInput.value = cleanValue;
            linkHrefInput.placeholder = '/path or #anchor';
            linkPrefixBtns.forEach(b => b.classList.remove('active'));
          } else {
            linkHrefInput.value = prefix + cleanValue;
            linkHrefInput.placeholder = prefixPlaceholders[prefix];
            linkPrefixBtns.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
          }

          linkHrefInput.focus();
        });
      });

      // ============ ADD BLOCK ============

      addBlockBtn.addEventListener('click', () => {
        addBlockDropdown.classList.toggle('hidden');
      });

      addBlockDropdown.addEventListener('click', (e) => {
        const btn = e.target.closest('button');
        if (!btn) return;

        const type = btn.dataset.type;
        const level = btn.dataset.level;
        const listType = btn.dataset.listType;
        const spacerHeight = btn.dataset.spacerHeight;
        const block = createBlockElement(type, level, '', listType, spacerHeight);
        blockEditor.appendChild(block);
        // Focus on first editable element
        const focusTarget = block.querySelector('li[contenteditable="true"]') || block.querySelector('.block-content');
        if (focusTarget) focusTarget.focus();
        addBlockDropdown.classList.add('hidden');
      });

      document.addEventListener('click', (e) => {
        if (!e.target.closest('.block-actions-row')) {
          addBlockDropdown.classList.add('hidden');
        }
        if (!e.target.closest('.nav-link-popup') && !e.target.closest('#add-nav-link') && !e.target.closest('.nav-chip')) {
          navLinkPopup.classList.add('hidden');
        }
      });

      // ============ BUILD INPUT ============
      let editorBuildInputManager = null;

      function getEditorBuildInputManager() {
        if (editorBuildInputManager) {
          return editorBuildInputManager;
        }

        editorBuildInputManager = createEditorBuildInputManager({
          blockEditor,
          navLinks,
          slugInput,
          titleInput,
          pageTypeSelect,
          titleOverrideEnabled,
          titleOverrideInput,
          navEnabled,
          footerEnabled,
          footerText,
          metaEnabled,
          metaDescription,
          metaAuthor,
          cssEnabled,
          cssRules,
          serializeBlock,
          getPosts: () => App.getPosts(),
          getGlobalConfig: () => window.globalConfig
        });

        return editorBuildInputManager;
      }

      function getContentFromBlocks() {
        return getEditorBuildInputManager().getContentFromBlocks();
      }

      function getNavigationItems() {
        return getEditorBuildInputManager().getNavigationItems();
      }

      async function buildInput(allowPagination = false) {
        return getEditorBuildInputManager().buildInput(allowPagination);
      }

      // ============ BYTE COUNTER & COST RAIL ============
      let editorMetricsManager = null;

      function getEditorMetricsManager() {
        if (editorMetricsManager) {
          return editorMetricsManager;
        }

        editorMetricsManager = createEditorMetricsManager({
          formatBytes,
          serializeBlock,
          estimateBlockSize,
          blockEditor,
          titleInput,
          titleOverrideEnabled,
          titleOverrideInput,
          titleBytesEl,
          browserTitleBytesEl,
          costContentTotal,
          navBytesEl,
          metaBytesEl,
          footerBytesEl,
          cssBytesEl,
          breakdownBase,
          breakdownTitle,
          breakdownFavicon,
          breakdownNav,
          breakdownMeta,
          breakdownFooter,
          breakdownCss,
          breakdownContent,
          breakdownTotal,
          pieChart,
          piePercent,
          pieContentDot,
          getGlobalConfig: () => window.globalConfig
        });

        return editorMetricsManager;
      }

      function updateByteCounter(totalBytes, overheadBytes = 0, contentBytes = null, breakdown = null) {
        return getEditorMetricsManager().updateByteCounter(totalBytes, overheadBytes, contentBytes, breakdown);
      }

      function updateCostRail() {
        return getEditorMetricsManager().updateCostRail();
      }

      function updateTitleBytes() {
        return getEditorMetricsManager().updateTitleBytes();
      }

      // ============ MODAL SYSTEM ============

      const Modal = createModalManager({
        backdrop: document.getElementById('modal-backdrop'),
        modal: document.getElementById('modal'),
        message: document.getElementById('modal-message'),
        actions: document.getElementById('modal-actions')
      });

      // Export Modal for inline handlers
      window.Modal = Modal;

      // ============ PUBLISH ============

      publishBtn.addEventListener('click', async () => {
        // Validate data
        const validation = validatePublishData({
          title: titleInput.value,
          blockCount: blockEditor.querySelectorAll('.block-item').length
        }, t);

        if (!validation.valid) {
          Modal.error(t('editor.buildError', { error: validation.error }));
          return;
        }

        const confirmed = await Modal.confirm(t('editor.buildConfirm'));
        if (!confirmed) return;

        publishBtn.disabled = true;

        try {
          // Determine pagination strategy
          const paginationResult = await determinePaginationStrategy({
            buildInput,
            App,
            Modal,
            t
          });

          if (paginationResult.aborted) {
            Modal.error(paginationResult.error);
            publishBtn.disabled = false;
            return;
          }

          // Execute publish with determined pagination strategy
          const input = await buildInput(paginationResult.shouldPaginate);
          await executePublish({ input, App, Modal, t });

          // Only clear fields if NOT in edit mode
          if (!isEditMode) {
            resetEditorForm(
              {
                titleInput,
                slugInput,
                blockEditor,
                titleOverrideEnabled,
                titleOverrideInput,
                navEnabled,
                footerEnabled,
                footerText,
                metaEnabled,
                metaDescription,
                metaAuthor,
                cssEnabled,
                cssRules,
                liveCSS,
                pageTypeSelect,
                pageTypeHint
              },
              {
                createBlockElement,
                loadGlobalNavigation,
                clearAutoSave,
                updateByteCounter,
                updateCostRail,
                updateTitleBytes
              }
            );
          }

          // Re-enable publish button
          publishBtn.disabled = false;
          // Set appropriate button text based on mode
          publishBtn.textContent = isEditMode ? t('editor.recompile') : t('editor.buildPublish');
        } catch (err) {
          Modal.error(err.message);
          console.error(err);
          publishBtn.disabled = false;
        }
      });

      // ============ INIT ============

      // Load global values into fields
      loadGlobalNavigation();
      loadGlobalFooter();
      loadGlobalMeta();
      loadGlobalCSS();

      // Set initial disabled states (after loading global values)
      navEditor.classList.remove('hidden');
      addNavLinkBtn.disabled = true;

      // Apply disabled state to navigation chips
      const initialChips = navLinks.querySelectorAll('.nav-chip');
      initialChips.forEach(chip => {
        chip.style.pointerEvents = 'none';
        chip.style.opacity = '0.6';
      });

      footerEditor.classList.remove('hidden');
      footerText.disabled = true;
      insertBytesBtn.disabled = true;

      metaEditor.classList.remove('hidden');
      metaDescription.disabled = true;
      metaAuthor.disabled = true;

      // Title override - disabled by default
      titleOverrideInput.disabled = true;
      updateTitleOverrideHint();

      cssEditor.classList.remove('hidden');
      cssRules.disabled = true;

      // ============ SEED TEMPLATES ============

      const templateSelector = document.getElementById('template-selector');
      const templateSelectorContainer = document.getElementById('template-selector-container');

      async function loadSeedTemplates() {
        try {
          const seeds = await App.getSeeds();

          if (seeds && seeds.length > 0) {
            seeds.forEach(seed => {
              const option = document.createElement('option');
              option.value = seed.name;
              option.textContent = seed.label;
              templateSelector.appendChild(option);
            });
          }
        } catch (err) {
          console.error('Failed to load seed templates:', err);
        }
      }

      templateSelector.addEventListener('change', async function () {
        const seedName = this.value;
        if (!seedName) return;

        try {
          const { sourceData } = await App.clonePage(seedName, 'seed');
          loadFromSource(sourceData);

          // Update title
          const pageTitle = document.getElementById('page-title');
          const pageSubtitle = document.getElementById('page-subtitle');
          pageTitle.textContent = `New (from ${seedName.replace('-', ' ')})`;
          pageSubtitle.textContent = 'Set title and slug to create a new page';

          // Reset dropdown
          this.value = '';
        } catch (err) {
          Modal.error(t('editor.templatesError', { error: err.message }));
          this.value = '';
        }
      });

      // Load seed templates on page load (only in new mode)
      const urlParams = new URLSearchParams(window.location.search);
      const editSlug = urlParams.get('edit');
      const isCloning = urlParams.get('clone') === 'true';

      if (!editSlug && !isCloning) {
        loadSeedTemplates();
      } else {
        // Hide template selector in edit/clone mode
        templateSelectorContainer.style.display = 'none';
      }

      // Check for edit mode (recompile from source)


      if (editSlug) {
        // Edit mode: load from source
        try {
          const sourceData = await App.getSourceData(editSlug);
          if (sourceData) {
            isEditMode = true;
            editingSlug = editSlug;
            loadFromSource(sourceData);
            // Show edit mode banner
            showEditModeBanner();
          }
        } catch (err) {
          console.error('Failed to load source:', err);
          Modal.error(t('editor.loadSourceError', { error: err.message }));
        }
      } else if (isCloning) {
        // Clone mode: load from sessionStorage
        try {
          const clonedData = sessionStorage.getItem('clonedSource');
          if (clonedData) {
            const sourceData = JSON.parse(clonedData);
            loadFromSource(sourceData);
            sessionStorage.removeItem('clonedSource');
            // Show notification
            const pageTitle = document.getElementById('page-title');
            const pageSubtitle = document.getElementById('page-subtitle');
            pageTitle.textContent = 'New (Cloned)';
            pageSubtitle.textContent = 'Set title and slug to create a new page';
          }
        } catch (err) {
          console.error('Failed to load cloned source:', err);
        }
      } else {
        // New document mode: try to restore from auto-save
        loadFromLocalStorage();
      }

      // Show edit mode indicator in title
      function showEditModeBanner() {
        const pageTitle = document.getElementById('page-title');
        const pageSubtitle = document.getElementById('page-subtitle');
        pageTitle.innerHTML = `Recompile <span style="font-weight: 400; color: var(--text-secondary);">/ ${editingSlug}</span>`;
        pageSubtitle.textContent = 'Editing source Â· requires rebuild';
        pageSubtitle.style.display = 'block';

        // Change button text to "Recompile" in edit mode
        publishBtn.setAttribute('data-i18n', 'editor.recompile');
        publishBtn.textContent = t('editor.recompile');
      }

      // ============ CLEAR ALL BUTTON ============

      document.getElementById('clear-all-btn').addEventListener('click', async () => {
        const confirmed = await Modal.confirm(t('editor.resetConfirm'));
        if (!confirmed) return;

        // Clear all fields
        titleInput.value = '';
        slugInput.value = '';
        blockEditor.innerHTML = '';

        // Add one empty paragraph block
        const emptyBlock = createBlockElement('paragraph');
        blockEditor.appendChild(emptyBlock);

        // Reset title override (disabled)
        titleOverrideEnabled.checked = false;
        titleOverrideEnabled.dispatchEvent(new Event('change'));
        titleOverrideInput.value = '';

        // Reset navigation to global (disabled)
        navEnabled.checked = false;
        navEnabled.dispatchEvent(new Event('change'));
        loadGlobalNavigation();

        // Reset footer to global (disabled)
        footerEnabled.checked = false;
        footerEnabled.dispatchEvent(new Event('change'));
        loadGlobalFooter();

        // Reset meta to global (disabled)
        metaEnabled.checked = false;
        metaEnabled.dispatchEvent(new Event('change'));
        loadGlobalMeta();

        // Reset CSS to global (disabled)
        cssEnabled.checked = false;
        cssEnabled.dispatchEvent(new Event('change'));
        loadGlobalCSS();

        // Reset page type
        pageTypeSelect.value = 'post';
        pageTypeHint.textContent = '';

        // Clear auto-save
        clearAutoSave();

        // Reset byte counter
        updateByteCounter(0, 0);
        updateCostRail();
        updateTitleBytes();
      });

      updateByteCounter(0, 0);
      updateCostRail();
      updateTitleBytes();

      // Auto-update byte counter on content changes
      debouncedPreview = debounce(async () => {
        saveToLocalStorage(); // Safety backup to localStorage (works in both modes)
        try {
          const input = await buildInput();
          const result = await App.preview(input);
          updateByteCounter(result.bytes, result.overheadBytes || 0, result.contentBytes, result.breakdown);

          // Clear previous block warnings
          blockEditor.querySelectorAll('.block-item.block-too-large').forEach(el => {
            el.classList.remove('block-too-large');
          });

          // Check if a block is too large for pagination
          if (result.blockTooLarge) {
            const blocks = blockEditor.querySelectorAll('.block-item');
            const blockIndex = result.blockTooLarge.blockIndex;
            if (blocks[blockIndex]) {
              blocks[blockIndex].classList.add('block-too-large');
            }
          }
        } catch (e) {
          // Ignore preview errors during editing
        }
      }, 500);

      // Listen for content changes
      blockEditor.addEventListener('input', () => {
        debouncedPreview();
        updateCostRail();
      });
      titleInput.addEventListener('input', debouncedPreview);
      titleOverrideInput.addEventListener('input', debouncedPreview);
      titleOverrideEnabled.addEventListener('change', debouncedPreview);
      footerText.addEventListener('input', debouncedPreview);
      cssRules.addEventListener('input', debouncedPreview);
      metaDescription.addEventListener('input', debouncedPreview);
      metaAuthor.addEventListener('input', debouncedPreview);
      navEnabled.addEventListener('change', debouncedPreview);
      footerEnabled.addEventListener('change', debouncedPreview);
      metaEnabled.addEventListener('change', debouncedPreview);
      cssEnabled.addEventListener('change', debouncedPreview);

      // Update cost rail when blocks change
      const observer = new MutationObserver(() => {
        updateCostRail();
      });
      observer.observe(blockEditor, { childList: true });

      // Initial preview to get overhead
      debouncedPreview();

    })();
  </script>
</body>

</html>