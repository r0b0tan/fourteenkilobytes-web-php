/**
 * App compile/publish service.
 */

export function createCompileService(deps) {
  const {
    Compiler,
    apiFetch,
    getSettings,
    getPosts,
    getSourceData,
    stripCssComments,
    finalizeCompiledPageHtml,
    isCompressionEnabledForSettings,
    isClassManglingEnabledForSettings,
    getClassManglingModeForSettings,
    contentHasSections,
  } = deps;

  const CSS_PRESET_NAMES = ['default', 'light', 'dark'];
  let cssPresetsCache = null;
  let sectionCssCache = null;

  async function isCompressionEnabled() {
    const settings = await getSettings();
    return settings?.optimizations?.compression?.enabled !== false;
  }

  async function loadSectionCSS() {
    if (sectionCssCache !== null) return sectionCssCache;
    try {
      const res = await fetch('/admin/sections.css');
      if (res.ok) {
        sectionCssCache = stripCssComments(await res.text()).trim();
      } else {
        sectionCssCache = '';
      }
    } catch (e) {
      console.warn('Failed to load section CSS:', e);
      sectionCssCache = '';
    }
    return sectionCssCache;
  }

  async function loadCssPresets() {
    if (cssPresetsCache) {
      return cssPresetsCache;
    }

    const presets = {};
    await Promise.all(CSS_PRESET_NAMES.map(async (name) => {
      try {
        const res = await fetch(`/admin/presets/${name}.css`);
        if (res.ok) {
          presets[name] = stripCssComments(await res.text()).trim();
        }
      } catch (e) {
        console.warn(`Failed to load preset ${name}:`, e);
      }
    }));

    cssPresetsCache = presets;
    return presets;
  }

  async function getPresetCSS(cssMode, customCss = '') {
    if (cssMode === 'custom') {
      return customCss;
    }
    const presets = await loadCssPresets();
    return presets[cssMode] || presets.default || '';
  }

  async function applyGlobalSettings(input) {
    const settings = await getSettings();
    const mergedInput = { ...input };
    mergedInput.classMangling = isClassManglingEnabledForSettings(settings);
    mergedInput.classManglingMode = getClassManglingModeForSettings(settings);

    const hasBloglist = mergedInput.content?.some(block => block.type === 'bloglist');
    if (hasBloglist && !mergedInput.posts) {
      mergedInput.posts = await getPosts();
    }

    if (!input.siteTitle && settings.siteTitleEnabled !== false && settings.siteTitle) {
      mergedInput.siteTitle = settings.siteTitle;
    }

    if (!input.navigation) {
      if (settings.header?.enabled && settings.header.links?.length > 0) {
        mergedInput.navigation = { items: settings.header.links };
      } else {
        mergedInput.navigation = null;
      }
    }

    if (!input.footer) {
      if (settings.footer?.enabled && settings.footer.content) {
        mergedInput.footer = { content: settings.footer.content };
      } else {
        mergedInput.footer = null;
      }
    }

    if (!input.css) {
      if (settings.cssEnabled !== false) {
        const globalCss = await getPresetCSS(settings.cssMode || 'default', settings.globalCss);
        if (globalCss) {
          mergedInput.css = { rules: globalCss };
        } else {
          mergedInput.css = null;
        }
      } else {
        mergedInput.css = null;
      }
    } else if (settings.cssEnabled !== false) {
      const globalCss = await getPresetCSS(settings.cssMode || 'default', settings.globalCss);
      if (globalCss) {
        mergedInput.css = { rules: globalCss + '\n' + input.css.rules };
      }
    }

    if (settings.pageWidth && mergedInput.css) {
      mergedInput.css = { rules: mergedInput.css.rules + '\nbody{max-width:' + settings.pageWidth + '}' };
    }

    if (contentHasSections(mergedInput.content)) {
      const sectionCss = await loadSectionCSS();
      if (sectionCss) {
        if (mergedInput.css) {
          mergedInput.css = { rules: sectionCss + '\n' + mergedInput.css.rules };
        } else {
          mergedInput.css = { rules: sectionCss };
        }
      }
    }

    if (!input.meta) {
      if (settings.meta?.enabled && (settings.meta.description || settings.meta.author)) {
        const meta = {};
        if (settings.meta.description) meta.description = settings.meta.description;
        if (settings.meta.author) meta.author = settings.meta.author;
        mergedInput.meta = meta;
      } else {
        mergedInput.meta = null;
      }
    }

    if (settings.favicon) {
      mergedInput.favicon = settings.favicon;
    }

    if (settings.bloglist && mergedInput.content) {
      const isArchivePage = mergedInput._autoGenerated === 'archive';
      mergedInput.content = mergedInput.content.map(block => {
        if (block.type === 'bloglist') {
          const updatedBlock = { ...block };
          if (updatedBlock.limit === undefined) {
            updatedBlock.limit = settings.bloglist.limit || 10;
          }
          if (settings.bloglist.archiveEnabled && !updatedBlock.archiveLink && !isArchivePage) {
            updatedBlock.archiveLink = {
              href: '/' + (settings.bloglist.archiveSlug || 'archive'),
              text: settings.bloglist.archiveLinkText || 'View all posts â†’',
            };
          }
          return updatedBlock;
        }
        return block;
      });
    }

    return mergedInput;
  }

  async function preview(input) {
    const useGlobal = input.useGlobalSettings !== false;
    const compilerInput = useGlobal ? await applyGlobalSettings(input) : input;

    const result = await Compiler.dryRun(compilerInput);

    if (!result.wouldSucceed) {
      const errorCode = result.error?.code;

      const sizeErrors = [
        'SIZE_LIMIT_EXCEEDED',
        'PAGINATION_DISABLED',
        'PAGINATION_BLOCK_TOO_LARGE',
        'PAGINATION_NO_CONVERGENCE'
      ];
      const isExceeded = sizeErrors.includes(errorCode);

      if (isExceeded && result.partialMeasurements) {
        const { total, overhead, content } = result.partialMeasurements.measurements;
        const breakdown = result.partialMeasurements.breakdown;

        let blockTooLarge = null;
        if (result.error.oversizedBlock) {
          blockTooLarge = {
            blockIndex: result.error.oversizedBlock.index,
            blockSize: result.error.oversizedBlock.size,
            availableBudget: result.error.oversizedBlock.availableBudget,
          };
        }

        return {
          html: '',
          bytes: total,
          overheadBytes: overhead,
          contentBytes: content,
          breakdown,
          measurements: null,
          exceeded: true,
          blockTooLarge,
        };
      }

      if (isExceeded) {
        return {
          html: '',
          bytes: result.error?.measured || 0,
          overheadBytes: 0,
          contentBytes: 0,
          breakdown: null,
          measurements: null,
          exceeded: true,
          blockTooLarge: null,
        };
      }

      throw new Error(result.error?.code || 'Compilation failed');
    }

    const page = result.pages[0];
    const { total, overhead, content } = result.measurements[0].measurements;
    const breakdown = result.measurements[0].breakdown;

    const compressionEnabled = await isCompressionEnabled();
    const finalized = finalizeCompiledPageHtml(page.html, page.bytes, compressionEnabled);

    return {
      html: finalized.html,
      bytes: finalized.bytes,
      overheadBytes: overhead,
      contentBytes: content,
      breakdown,
      measurements: result.measurements,
    };
  }

  async function previewOverhead(settings) {
    const actualCss = settings.cssEnabled === false
      ? null
      : await getPresetCSS(settings.cssMode || 'default', settings.globalCss);

    let meta = null;
    if (settings.meta?.description || settings.meta?.author) {
      meta = {};
      if (settings.meta.description) meta.description = settings.meta.description;
      if (settings.meta.author) meta.author = settings.meta.author;
    }

    const testInput = {
      slug: 'overhead-test',
      title: 'Test',
      content: [{ type: 'paragraph', children: [{ type: 'text', text: '' }] }],
      navigation: settings.header?.enabled && settings.header.links?.length > 0
        ? { items: settings.header.links }
        : null,
      footer: settings.footer?.enabled && settings.footer.content
        ? { content: settings.footer.content }
        : null,
      css: actualCss
        ? { rules: actualCss }
        : null,
      meta,
      favicon: settings.favicon || null,
      icons: [],
      allowPagination: false,
      buildId: 'overhead-test',
      classMangling: isClassManglingEnabledForSettings(settings),
      classManglingMode: getClassManglingModeForSettings(settings),
    };

    const result = await Compiler.dryRun(testInput);
    if (!result.wouldSucceed) {
      throw new Error(result.error?.code || 'Compilation failed');
    }

    const page = result.pages[0];
    const compressionEnabled = isCompressionEnabledForSettings(settings);
    const finalized = finalizeCompiledPageHtml(page.html, page.bytes, compressionEnabled);
    const breakdown = result.measurements?.[0]?.breakdown || {};

    return {
      overheadBytes: finalized.bytes,
      measurements: result.measurements,
      breakdown,
    };
  }

  async function getGlobalSettingsInfo() {
    const settings = await getSettings();

    const baseInput = {
      slug: 'base-test',
      title: 'T',
      content: [{ type: 'paragraph', children: [{ type: 'text', text: '' }] }],
      navigation: null,
      footer: null,
      css: null,
      meta: null,
      icons: [],
      allowPagination: false,
      buildId: 'base-test',
    };
    const baseResult = await Compiler.dryRun(baseInput);
    const baseBytes = baseResult.wouldSucceed ? baseResult.measurements[0].breakdown.base : 0;

    let headerBytes = 0;
    let headerActive = false;
    if (settings.header?.enabled && settings.header.links?.length > 0) {
      headerActive = true;
      const headerInput = {
        ...baseInput,
        navigation: { items: settings.header.links },
        buildId: 'header-test',
      };
      const headerResult = await Compiler.dryRun(headerInput);
      if (headerResult.wouldSucceed) {
        headerBytes = headerResult.measurements[0].breakdown.navigation;
      }
    }

    let footerBytes = 0;
    let footerActive = false;
    if (settings.footer?.enabled && settings.footer.content) {
      footerActive = true;
      const footerInput = {
        ...baseInput,
        footer: { content: settings.footer.content },
        buildId: 'footer-test',
      };
      const footerResult = await Compiler.dryRun(footerInput);
      if (footerResult.wouldSucceed) {
        footerBytes = footerResult.measurements[0].breakdown.footer;
      }
    }

    let cssBytes = 0;
    let cssActive = false;
    if (settings.globalCss) {
      cssActive = true;
      const cssInput = {
        ...baseInput,
        css: { rules: settings.globalCss },
        buildId: 'css-test',
      };
      const cssResult = await Compiler.dryRun(cssInput);
      if (cssResult.wouldSucceed) {
        cssBytes = cssResult.measurements[0].breakdown.css;
      }
    }

    return {
      header: {
        active: headerActive,
        bytes: headerBytes,
        links: settings.header?.links || [],
      },
      footer: {
        active: footerActive,
        bytes: footerBytes,
        content: settings.footer?.content || '',
      },
      css: {
        active: cssActive,
        bytes: cssBytes,
      },
      baseBytes,
      totalOverhead: baseBytes + headerBytes + footerBytes + cssBytes,
    };
  }

  async function publish(input) {
    const useGlobal = input.useGlobalSettings !== false;
    const compilerInput = useGlobal ? await applyGlobalSettings(input) : input;

    const result = await Compiler.compile(compilerInput);
    if (!result.success) {
      throw new Error(result.error?.code || 'Compilation failed');
    }

    if (result.pages.length > 1) {
      const compressionEnabled = await isCompressionEnabled();
      const pages = result.pages.map(page => {
        const finalized = finalizeCompiledPageHtml(page.html, page.bytes, compressionEnabled);
        return {
          slug: page.slug,
          html: finalized.html,
          bytes: finalized.bytes,
          hash: page.hash,
        };
      });

      return apiFetch('/api/posts', {
        method: 'POST',
        body: JSON.stringify({
          pages,
          title: input.title,
          pageType: input.pageType || 'post',
          sourceData: {
            slug: input.slug,
            title: input.title,
            content: input.content,
            navigation: input.navigation,
            footer: input.footer,
            css: input.css,
            meta: input.meta,
            icons: input.icons,
            allowPagination: input.allowPagination,
            pageType: input.pageType,
          },
        }),
      });
    }

    const page = result.pages[0];
    const compressionEnabled = await isCompressionEnabled();
    const finalized = finalizeCompiledPageHtml(page.html, page.bytes, compressionEnabled);

    return apiFetch('/api/posts', {
      method: 'POST',
      body: JSON.stringify({
        slug: page.slug,
        title: input.title,
        html: finalized.html,
        bytes: finalized.bytes,
        hash: page.hash,
        pageType: input.pageType || 'post',
        sourceData: {
          slug: input.slug,
          title: input.title,
          content: input.content,
          navigation: input.navigation,
          footer: input.footer,
          css: input.css,
          meta: input.meta,
          icons: input.icons,
          allowPagination: input.allowPagination,
          pageType: input.pageType,
        },
      }),
    });
  }

  async function republishPost(slug) {
    const sourceData = await getSourceData(slug);
    const posts = await getPosts();

    const input = {
      ...sourceData,
      posts,
      buildId: crypto.randomUUID(),
    };

    return publish(input);
  }

  async function createDefaultHomepage() {
    const homepageInput = {
      slug: 'startseite',
      title: 'Startseite',
      pageType: 'page',
      content: [
        {
          type: 'heading',
          level: 1,
          children: [{ type: 'text', text: 'Willkommen' }]
        },
        {
          type: 'paragraph',
          children: [{ type: 'text', text: 'Dies ist die Startseite deines Blogs. Du kannst diese Seite im Editor bearbeiten.' }]
        },
        {
          type: 'bloglist',
        }
      ],
      icons: [],
      allowPagination: true,
      _autoGenerated: 'homepage',
    };

    return publish(homepageInput);
  }

  async function generateArchivePage() {
    const settings = await getSettings();

    if (!settings.bloglist?.archiveEnabled) {
      return null;
    }

    const archiveSlug = settings.bloglist.archiveSlug || 'archiv';
    const archiveTitle = 'Archiv';

    const archiveInput = {
      slug: archiveSlug,
      title: archiveTitle,
      pageType: 'page',
      content: [
        {
          type: 'heading',
          level: 1,
          children: [{ type: 'text', text: archiveTitle }]
        },
        {
          type: 'bloglist',
          limit: null,
        }
      ],
      icons: [],
      allowPagination: true,
      _autoGenerated: 'archive',
    };

    return publish(archiveInput);
  }

  return {
    loadCssPresets,
    getPresetCSS,
    preview,
    previewOverhead,
    getGlobalSettingsInfo,
    publish,
    republishPost,
    createDefaultHomepage,
    generateArchivePage,
  };
}
