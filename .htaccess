# fourteenkilobytes - Apache Configuration
# This file must be in the root of your web directory

# Disable directory listing
Options -Indexes

# Deny access to sensitive files
<FilesMatch "\.(bak|json|md|log)$">
    Require all denied
</FilesMatch>

RewriteEngine On

# Allow access to new public language files
RewriteRule ^lang/(.*)$ public/lang/$1 [L]

# Deny access to data directory
RewriteRule ^data/ - [F,L]

# Redirect to setup wizard if not completed (except setup, api, and static files)
RewriteCond %{REQUEST_URI} !^/setup
RewriteCond %{REQUEST_URI} !^/api
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{DOCUMENT_ROOT}/data/.setup-complete !-f
RewriteRule ^.*$ /setup/ [R=302,L]

# Setup wizard routing
RewriteRule ^setup/api\.php/(.*)$ setup/api.php [L,QSA,E=PATH_INFO:/$1]
RewriteRule ^setup/?$ setup/index.php [L]

# API requests -> /api/index.php
RewriteRule ^api/(.*)$ api/index.php [L,QSA]

# Admin static files (pass through if file exists)
RewriteCond %{REQUEST_FILENAME} -f
RewriteRule ^public/admin/.*$ - [L]

# Admin routes - prevent indexing
SetEnvIf Request_URI "^/admin" ADMIN_REQ
Header set X-Robots-Tag "noindex, nofollow" env=ADMIN_REQ
RewriteRule ^admin/?$ public/admin/index.html [L]
RewriteRule ^admin/(.+)$ public/admin/$1 [L]

# Static files in public (pass through if exists)
RewriteCond %{DOCUMENT_ROOT}/%{REQUEST_URI} -f
RewriteRule ^ - [L]

# RSS Feed
RewriteRule ^feed\.xml$ feed.php [L]

# Root -> public/index.html or index.php router
RewriteRule ^$ index.php [L]

# Blog posts (slug format) -> index.php router
RewriteRule ^([a-z0-9-]+)/?$ index.php?slug=$1 [L,QSA]
